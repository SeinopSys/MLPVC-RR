'use strict';DocReady.push(function(){'use strict';function a(a,b,c,e){var f='Reserving request',g=function(b){$.Dialog.wait(f,'Sending reservation to the server'),$.post('/post/reserve/request/'+c,b,$.mkAjaxHandler(function(){if(this.retry)return $.Dialog.confirm(!1,this.message,function(a){a&&(b.screwit=!0,g(b))});if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var d=$(this.li);a.hasClass('highlight')&&d.addClass('highlight'),a.replaceWith(d),Time.Update(),d.trigger('bind-more-handlers',[c,e])}$.Dialog.close()}))};if('undefined'==typeof d||!b)g({});else{var h=$.mk('form').attr('id','reserve-as').append($.mk('label').append('<span>Reserve as</span>',$.mk('input').attr({type:'text',name:'post_as',required:!0,placeholder:'Username'}).patternAttr(d)),$.mk('label').append($.mk('span').text('Reserved at'),$.mk('input').attr({type:'datetime',name:'reserved_at',spellcheck:!1,autocomplete:'off',placeholder:'time()'})));$.Dialog.request(f,h,'Reserve',function(a){a.on('submit',function(b){b.preventDefault(),g(a.mkData())})})}}var b=window.SEASON,c=window.EPISODE,d=window.USERNAME_REGEX,e=window.FULLSIZE_MATCH_REGEX,f='S'+b+'E'+c,g=0===b?'Movie':'Episode',h=g.toLowerCase(),i=$content.children('section.episode');$('#video').on('click',function(){$.Dialog.wait('Set video links','Requesting links from the server'),$.post('/episode/video-data/'+f+'?action=get',$.mkAjaxHandler(function(){var a=this;if(!a.status)return $.Dialog.fail(!1,a.message);var b='<input type=\'url\' class=\'yt\' name=\'yt_1\' placeholder=\'YouTube\' spellcheck=\'false\' autocomplete=\'off\'>',c='<input type=\'url\' class=\'dm\' name=\'dm_1\' placeholder=\'Dailymotion\' spellcheck=\'false\' autocomplete=\'off\'>',d=$.mk('form').attr('id','vidlinks').attr('class','align-center').html('<p>Enter vido links below, leave any input blank to remove that video from the '+h+' page.</p>\n\t\t\t\t\t<div class=\'input-group-2\'>\n\t\t\t\t\t\t'+b+'\n\t\t\t\t\t\t'+c+'\n\t\t\t\t\t</div>');if(a.twoparter&&($.mk('p').html('<strong>~ Part 1 ~</strong>').insertBefore(d.children('input').first()),d.append('<p>Check below if either link contains the full '+h+' instead of just one part</p>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label><input type=\'checkbox\' name=\'yt_1_full\'> YouTube</label> &nbsp; <label><input type=\'checkbox\' name=\'dm_1_full\'> Dailymotion</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p><strong>~ Part 2 ~</strong></p>\n\t\t\t\t\t<div class=\'input-group-2\'>\n\t\t\t\t\t\t'+b.replace('yt_1','yt_2')+'\n\t\t\t\t\t\t'+c.replace('dm_1','dm_2')+'\n\t\t\t\t\t</div>'),d.find('input[type="checkbox"]').on('change',function(){var a=$(this).attr('name').replace(/^([a-z]+)_.*$/,'$1');d.find('input').filter('[name='+a+'_2]').attr('disabled',this.checked)}),0<a.fullep.length&&$.each(a.fullep,function(a,b){d.find('input[type="checkbox"]').filter('[name="'+b+'_1_full"]').prop('checked',!0).trigger('change')})),0<Object.keys(a.vidlinks).length){var e=d.find('input[type="url"]');$.each(a.vidlinks,function(a,b){e.filter('[name='+a+']').val(b)})}$.Dialog.request(!1,d,'Save',function(b){if(a.airs&&new Date(a.airs).getTime()>new Date().getTime()){var c=$.mk('div').addClass('notice warn').text('If you add this video now, it will be shown as a livestream link!');b.append(c),b.on('change keydown','input',function(){setTimeout(function(){var a=b.mkData(),d=a.yt_1&&a.yt_1_full&&!(a.dm_1||a.dm_2);c[d?'show':'hide']()},1)}).triggerHandler('change')}b.on('submit',function(a){a.preventDefault();var c=b.mkData();$.Dialog.wait(!1,'Saving links'),$.post('/episode/video-data/'+f+'?action=set',c,$.mkAjaxHandler(function(){return this.status?void(this.epsection?(!i.length&&(i=$.mk('section').addClass('episode').insertBefore($content.children('section').first())),i.html($(this.epsection).filter('section').html()),bindVideoButtons()):i.length&&(i.remove(),i={length:0}),$.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))});var j=$content.children('section.appearances');$('#cg-relations').on('click',function(){$.Dialog.wait('Guide relation editor','Retrieving relations from server'),$.post('/episode/guide-relations/'+f+'?action=get',$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var a=this,b=$.mk('form').attr('id','guide-relation-editor'),c=$.mk('select').attr({name:'listed',multiple:!0}),d=$.mk('select').attr('multiple',!0);a.linked&&a.linked.length&&$.each(a.linked,function(a,b){c.append($.mk('option').attr('value',b.id).text(b.label))}),a.unlinked&&a.unlinked.length&&$.each(a.unlinked,function(a,b){d.append($.mk('option').attr('value',b.id).text(b.label))}),b.append($.mk('div').attr('class','split-select-wrap').append($.mk('div').attr('class','split-select').append('<span>Linked</span>',c),$.mk('div').attr('class','buttons').append($.mk('button').attr({'class':'typcn typcn-chevron-left green',title:'Link selected'}).on('click',function(a){a.preventDefault(),c.append(d.children(':selected').prop('selected',!1)).children().sort(function(c,a){return c.innerHTML.localeCompare(a.innerHTML)}).appendTo(c)}),$.mk('button').attr({'class':'typcn typcn-chevron-right red',title:'Unlink selected'}).on('click',function(a){a.preventDefault(),d.append(c.children(':selected').prop('selected',!1)).children().sort(function(c,a){return c.innerHTML.localeCompare(a.innerHTML)}).appendTo(d)})),$.mk('div').attr('class','split-select').append('<span>Available</span>',d))),$.Dialog.request(!1,b,'Save',function(a){a.on('submit',function(a){a.preventDefault();var b=[];c.children().each(function(a,c){b.push(c.value)}),$.Dialog.wait(!1,'Saving changes'),$.post('/episode/guide-relations/'+f+'?action=set',{ids:b.join(',')},$.mkAjaxHandler(function(){return this.status?void(this.section?(!j.length&&(j=$.mk('section').addClass('appearances').insertBefore($content.children('.admin'))),j.html($(this.section).filter('section').html())):j.length&&(j.remove(),j={length:0}),$.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))}),$('#edit-about_reservations, #edit-reservation_rules').on('click',function(a){a.preventDefault();var b=$(this).parent(),c=b.clone(),d=this.id.split('-').pop();c.children().remove();var e=c.text().trim();$.Dialog.wait('Editing "'+e+'"','Retrieving setting\u2019s value'),$.post('/setting/get/'+d,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var a=$.mk('form',d+'-editor').html('<span>'+e+'</span>'),c=this.value;$.Dialog.request(!1,a,'Save',function(a){var f;$.getAceEditor(!1,'html',function(b){var d=ace.edit($.mk('div').appendTo(a).get(0));d.setShowPrintMargin(!1),f=$.aceInit(d,b),f.setMode(b),f.setUseWrapMode(!0),f.setValue(c)}),a.on('submit',function(a){a.preventDefault();var c={value:f.getValue()};$.Dialog.wait(!1,'Saving'),$.post('/setting/set/'+d,c,$.mkAjaxHandler(function(){return this.status?void(b.siblings().remove(),b.parent().append(this.value),$.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))});var k=function(){var b=$(this),c=$._getLiTypeId(b),f=c.id,g=c.type.replace(/s$/,''),h=$.capitalize(g);b.children('button.reserve-request').off('click').on('click',function(c){c.preventDefault(),a(b,c.shiftKey,f,g)});var i=b.find('.actions').children();i.filter('.cancel').off('click').on('click',function(){$.Dialog.confirm('Cancel reservation','Are you sure you want to cancel this reservation?',function(a){a&&($.Dialog.wait(!1,'Cancelling reservation'),b.addClass('deleting'),$.post('/post/unreserve/'+g+'/'+f,$.mkAjaxHandler(function(){return this.status?!0===this.remove?($.Dialog.close(),b[window.WithinMobileBreakpoint()?'slideUp':'fadeOut'](500,function(){b.remove()})):void(this.reload&&b.reloadLi(!1),$.Dialog.close(),b.removeClass('deleting')):$.Dialog.fail(!1,this.message)})))})}),i.filter('.finish').off('click').on('click',function(){var a=$.mk('form').attr('id','finish-res').append($.mk('label').append($.mk('span').text('Deviation URL'),$.mk('input').attr({type:'text',name:'deviation',spellcheck:!1,autocomplete:'off',required:!0})));'undefined'!=typeof d&&a.append($.mk('label').append($.mk('span').text('Finished at'),$.mk('input').attr({type:'datetime',name:'finished_at',spellcheck:!1,autocomplete:'off',placeholder:'time()'}))),$.Dialog.request('Complete reservation',a,'Finish',function(a){a.on('submit',function(b){b.preventDefault();var c=a.find('[name=deviation]').val();if('string'!=typeof c||0===c.length)return $.Dialog.fail(!1,'Please enter a deviation URL');var d='/post/finish/'+g+'/'+f,e=a.mkData();$.Dialog.wait(!1,'Marking '+g+' as finished'),$.post(d,e,$.mkAjaxHandler(function(){var a=this,b=function(){$.Dialog.success(!1,h+' has been marked as finished'),$('#'+g+'s').trigger('pls-update',[function(){'string'==typeof a.message&&a.message?$.Dialog.success(!1,a.message,!0):$.Dialog.close()}])};a.status?b():a.retry?$.Dialog.confirm(!1,a.message,['Continue','Cancel'],function(c){c&&(e.allow_overwrite_reserver=!0,$.Dialog.wait(!1),$.post(d,e,$.mkAjaxHandler(function(){return this.status?void(a=this,b()):$.Dialog.fail(!1,this.message)})))}):$.Dialog.fail(!1,a.message)}))})})}),i.filter('.unfinish').off('click').on('click',function(){var a=$(this),b=a.hasClass('delete-only'),c=$.capitalize(g),d=g.replace(/s$/,'');$.Dialog.request((b?'Delete':'Unfinish')+' '+d,'<form id="unbind-check"><p>Are you sure you want to '+(b?'delete this reservation':'mark this '+d+' as unfinished')+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind '+d+' from user</label></form>','Unfinish',function(a){var d=a.find('[name=unbind]');b||a.prepend('<div class="notice info">By removing the "finished" flag, the post will be moved back to the "List of '+c+'" section</div>'),'reservation'===g?(d.on('click',function(){$('#dialogButtons').children().first().val(this.checked?'Delete':'Unfinish')}),b&&d.trigger('click').off('click').on('click keydown touchstart',function(){return!1}).css('pointer-events','none').parent().hide(),a.append('<div class="notice warn">Because this '+(b?'reservation was added directly, it cannot be marked unfinished, only deleted.':'is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.')+'</div>')):a.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),$w.trigger('resize'),a.on('submit',function(a){a.preventDefault();var b=d.prop('checked');$.Dialog.wait(!1,'Removing "finished" flag'+(b?' & unbinding from user':'')),$.post('/post/unfinish/'+g+'/'+f+(b?'?unbind':''),$.mkAjaxHandler(function(){return this.status?void($.Dialog.success(!1,'undefined'==typeof this.message?'"finished" flag removed successfully':this.message),$('#'+g+'s').trigger('pls-update')):$.Dialog.fail(!1,this.message)}))})})}),i.filter('.check').off('click').on('click',function(a){a.preventDefault(),$.Dialog.wait('Submission approval status','Checking'),$.post('/post/lock/'+g+'/'+f,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var a=this.message;b.reloadLi(),$.Dialog.success(!1,a,!0)}))}),i.filter('.unlock').off('click').on('click',function(a){a.preventDefault(),$.Dialog.confirm('Unlocking post','Are you sure you want to unlock this post?',function(a){a&&($.Dialog.wait(!1),$.post('/post/unlock/'+g+'/'+f,$.mkAjaxHandler(function(){return this.status?void $('#'+g+'s').trigger('pls-update'):$.Dialog.fail(!1,this.message)})))})}),i.filter('.delete').off('click').on('click',function(){var a=$(this);$.Dialog.confirm('Deleteing request #'+f,'You are about to permanently delete this request.<br>Are you sure about this?',function(c){c&&($.Dialog.wait(!1),b.addClass('deleting'),$.post('/post/delete-request/'+f,$.mkAjaxHandler(function(){return this.status?void($.Dialog.close(),a.closest('li')[window.WithinMobileBreakpoint()?'slideUp':'fadeOut'](500,function(){$(this).remove()})):(b.removeClass('deleting'),$.Dialog.fail(!1,this.message))})))})}),i.filter('.edit').off('click').on('click',function(){var a=$(this),b=a.parents('li'),c=b.attr('id').split('-'),d=c[1],f=c[0];$.Dialog.wait('Editing '+f+' #'+d,'Retrieving '+f+' details'),$.post('/post/get/'+f+'/'+d,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var a=this,c=$.mk('form').attr('id','post-edit-form').append($.mk('label').append($.mk('span').text('Description (3-255 chars.'+('reservation'===f?', optional':'')+')'),$.mk('input').attr({type:'text',maxlength:255,pattern:'^.{3,255}$',name:'label',required:'reservation'!==f})));'request'===f&&c.append($.mk('label').append($.mk('span').text('Request type'),$.mk('select').attr({name:'type',required:!0}).append($.mk('option').attr('value','chr').text('Character'),$.mk('option').attr('value','obj').text('Object'),$.mk('option').attr('value','bg').text('Backgound')))),'string'==typeof a.posted&&c.append($.mk('label').append($.mk('span').text('Post timestamp'),$.mk('input').attr({type:'datetime',name:'date',required:!0,spellcheck:!1,autocomplete:'off'}))),'string'==typeof a.reserved_at&&c.append($.mk('label').append($.mk('span').text('Reserved at'),$.mk('input').attr({type:'datetime',name:'reserved_at',spellcheck:!1,autocomplete:'off'}))),'string'==typeof a.finished_at&&c.append($.mk('label').append($.mk('span').text('Finished at'),$.mk('input').attr({type:'datetime',name:'finished_at',spellcheck:!1,autocomplete:'off'})));var g=0===b.children('.image').find('.typcn-tick').length,h='finished'===b.closest('div').attr('class'),i=h?b.children('.original'):b.children('.image').children('a'),j=i.attr('href'),k=!h&&!e.test(j)&&/deviantart\.net\//.test(j);(g||k)&&c.append($.mk('label').append(g?$.mk('a').text('Update Image').attr({href:'#update','class':'btn darkblue typcn typcn-pencil'}).on('click',function(a){a.preventDefault(),$.Dialog.close();var c=b.children('.image').find('img'),e=$.mk('form').attr('id','img-update-form').append($.mk('div').attr('class','oldimg').append($.mk('span').text('Current image'),c.clone()),$.mk('label').append($.mk('span').text('New image URL'),$.mk('input').attr({type:'text',maxlength:255,pattern:'^.{2,255}$',name:'image_url',required:!0,autocomplete:'off',spellcheck:'false'})));$.Dialog.request('Update image of '+f+' #'+d,e,'Update',function(a){a.on('submit',function(c){c.preventDefault();var e=a.mkData();$.Dialog.wait(!1,'Replacing image'),$.post('/post/set-image/'+f+'/'+d,e,$.mkAjaxHandler(function(){return this.status?void($.Dialog.success(!1,'Image has been updated'),b.reloadLi()):$.Dialog.fail(!1,this.message)}))})})}):void 0,k?$.mk('a').text('Sta.sh fullsize fix').attr({href:'#fix-stash-fullsize','class':'btn orange typcn typcn-spanner'}).on('click',function(a){a.preventDefault(),$.Dialog.close(),$.Dialog.wait('Fix Sta.sh fullsize URL','Fixing Sta.sh full size image URL'),$.post('/post/fix-stash/'+f+'/'+d,$.mkAjaxHandler(function(){if(!this.status){if(this.rmdirect){if(!h)return b.find('.post-date').children('a').first().triggerHandler('click'),$.Dialog.fail(!1,this.message+'<br>The post might be broken because of this, please check it for any issues.');b.children('.original').remove()}return $.Dialog.fail(!1,this.message)}i.attr('href',this.fullsize),$.Dialog.success(!1,'Fix successful',!0)}))}):void 0)),$.Dialog.request(!1,c,'Save',function(c){var e,g,h,i=c.find('[name=label]'),j=c.find('[name=type]');if(a.label&&i.val(a.label),a.type&&j.children('option').filter(function(){return this.value===a.type}).attr('selected',!0),'string'==typeof a.posted){e=c.find('[name=date]');var k=moment(a.posted);e.val(k.format('YYYY-MM-DDTHH:mm:ssZ'))}if('string'==typeof a.reserved_at&&(g=c.find('[name=reserved_at]'),a.reserved_at.length)){var l=moment(a.reserved_at);g.val(l.format('YYYY-MM-DDTHH:mm:ssZ'))}if('string'==typeof a.finished_at&&(h=c.find('[name=finished_at]'),a.finished_at.length)){var m=moment(a.finished_at);h.val(m.format('YYYY-MM-DDTHH:mm:ssZ'))}c.on('submit',function(c){c.preventDefault();var k={label:i.val()};if('request'===f&&(k.type=j.val()),'string'==typeof a.posted){if(k.posted=new Date(e.val()),isNaN(k.posted.getTime()))return $.Dialog.fail(!1,'Post timestamp is invalid');k.posted=k.posted.toISOString()}if('string'==typeof a.reserved_at){var l=g.val();if(l.length){if(k.reserved_at=new Date(l),isNaN(k.reserved_at.getTime()))return $.Dialog.fail(!1,'"Reserved at" timestamp is invalid');k.reserved_at=k.reserved_at.toISOString()}}if('string'==typeof a.finished_at){var m=h.val().trim();if(m.length){if(k.finished_at=new Date(m),isNaN(k.finished_at.getTime()))return $.Dialog.fail(!1,'"Finished at" timestamp is invalid');k.finished_at=k.finished_at.toISOString()}}$.Dialog.wait(!1,'Saving changes'),$.post('/post/set/'+f+'/'+d,k,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var a=$(this.li);b.hasClass('highlight')&&a.addClass('highlight'),b.replaceWith(a),Time.Update(),a.trigger('bind-more-handlers',[d,f])}$.Dialog.close()}))})})}))}),i.filter('.pls-transfer').off('click').on('click',function(){var c=b.children('.reserver').find('.name').text();$.Dialog.confirm('Take on reservation of '+g+' #'+f,'<p>Using this option, you can express your interest in finishing the '+g+' which '+c+' already reserved.</p>\n\t\t\t\t<p>They will be sent a notification letting them know you\'re interested and they\'ll be able to allow/deny the transfer of the reserver status as they see fit.</p>\n\t\t\t\t<p>Once '+c+' responds to your inquiry you\'ll receive a notification informing you about their decision. If they agreed, the post\u2019s reservation will be transferred to you immediately.</p>\n\t\t\t\t<p><strong>Are you sure you can handle this '+g+'?</strong></p>',function(c){c&&($.Dialog.wait(!1),$.post('/post/transfer/'+g+'/'+f,$.mkAjaxHandler(function(){if(this.canreserve)return $.Dialog.confirm(!1,this.message,function(c){c&&a(b,!1,f,g)});return this.status?void $.Dialog.success(!1,this.message,!0):$.Dialog.fail(!1,this.message)})))})})};$('#requests, #reservations').on('bind-more-handlers','li[id]',k).find('li[id]').each(k)},function(){'use strict';delete window.moment.tz});
//# sourceMappingURL=/js/min/episode-manage.js.map
