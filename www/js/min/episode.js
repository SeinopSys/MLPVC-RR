"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};DocReady.push(function(){function e(){"undefined"!=typeof p&&p.filter(".red").triggerHandler("click")}function t(){var e=void 0,t=$(".episode").find(".showplayers").on("scroll-video-into-view",function(){var t=$header.outerHeight();$.scrollTo(e.offset().top-($w.height()-$footer.outerHeight()-t-e.outerHeight())/2-t,500)}),i=t.parent(),n=void 0;t.length&&t.on("click",function(a){if(a.preventDefault(),"undefined"==typeof e)$.Dialog.wait(t.text()),$.post("/episode/videos/"+l,$.mkAjaxHandler(function(){return this.status?(2===this[0]&&(n=$.mk("button").attr("class","blue typcn typcn-media-fast-forward").text("Part 2").on("click",function(){$(this).toggleHtml(["Part 1","Part 2"]),e.children().toggle()}),i.append(n)),e=$.mk("div").attr("class","resp-embed-wrap").html(this[1]).insertAfter(i),t.removeClass("typcn-eye green").addClass("typcn-eye-outline blue").text("Hide on-site player").triggerHandler("scroll-video-into-view"),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}));else{var o=t.hasClass("typcn-eye");e[o?"show":"hide"](),n instanceof jQuery&&n.attr("disabled",!o),t.toggleClass("typcn-eye typcn-eye-outline").toggleHtml(["Show on-site player","Hide on-site player"]),o&&t.triggerHandler("scroll-video-into-view")}})}function i(e,t,a){e.children("button.reserve-request").off("click").on("click",function(n){n.preventDefault();var o="Reserving request",r=function(n){$.Dialog.wait(o,"Sending reservation to the server"),$.post("/post/reserve-request/"+t,n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var n=$(this.li);e.hasClass("highlight")&&n.addClass("highlight"),e.replaceWith(n),n.rebindFluidbox(),Time.Update(),i(n,t,a),$.Dialog.close()}))};if("undefined"!=typeof s&&n.shiftKey){var l=$.mk("form").attr("id","reserve-as").append($.mk("label").append("<span>Reserve as</span>",$.mk("input").attr({type:"text",name:"post_as",required:!0,placeholder:"Username"}).patternAttr(s)),$.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",spellcheck:!1,autocomplete:"off",placeholder:"time()"})));$.Dialog.request(o,l,"Reserve",function(e){e.on("submit",function(t){t.preventDefault(),r(e.mkData())})})}else r({})});var o=e.find(".actions").children();o.filter(".cancel").off("click").on("click",function(){$.Dialog.confirm("Cancel reservation","Are you sure you want to cancel this reservation?",function(n){n&&($.Dialog.wait(!1,"Cancelling reservation"),$.post("/post/unreserve-"+a+"/"+t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.remove===!0)return $.Dialog.close(),e.remove();var n=$(this.li);e.hasClass("highlight")&&n.addClass("highlight"),e.replaceWith(n),n.rebindFluidbox(),Time.Update(),i(n,t,a),$.Dialog.close()})))})}),o.filter(".finish").off("click").on("click",function(){var e=$.mk("form").attr("id","finish-res").append($.mk("label").append($.mk("span").text("Deviation URL"),$.mk("input").attr({type:"text",name:"deviation",spellcheck:!1,autocomplete:"off",required:!0})));"undefined"!=typeof s&&e.append($.mk("label").append($.mk("span").text("Finished at"),$.mk("input").attr({type:"datetime",name:"finished_at",spellcheck:!1,autocomplete:"off",placeholder:"time()"}))),$.Dialog.request("Finish reservation",e,"Finish",function(e){e.on("submit",function(i){i.preventDefault();var o=e.find("[name=deviation]").val();if("string"!=typeof o||0===o.length)return $.Dialog.fail(!1,"Please enter a deviation URL");var s="/post/finish-"+a+"/"+t,r=e.mkData();$.Dialog.wait(!1,"Marking reservation as finished"),$.post(s,r,$.mkAjaxHandler(function(){var e=this,t=function(){$.Dialog.success(!1,"Reservation has been marked as finished"),n(a,function(){"string"==typeof e.message&&e.message?$.Dialog.success(!1,e.message,!0):$.Dialog.close()})};e.status?t():e.retry?$.Dialog.confirm(!1,e.message,["Continue","Cancel"],function(i){i&&(r.allow_overwrite_reserver=!0,$.post(s,r,$.mkAjaxHandler(function(){return this.status?(e=this,void t()):$.Dialog.fail(!1,this.message)})))}):$.Dialog.fail(!1,e.message)}))})})}),o.filter(".unfinish").off("click").on("click",function(){var e=$(this),i=e.hasClass("delete-only"),o=$.capitalize(a),s=a.replace(/s$/,"");$.Dialog.request((i?"Delete":"Unfinish")+" "+s,'<form id="unbind-check"><p>Are you sure you want to '+(i?"delete this reservation":"mark this "+s+" as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind '+s+" from user</label></form>","Unfinish",function(e){var s=e.find("[name=unbind]");i||e.prepend('<div class="notice info">By removing the "finished" flag, the post will be moved back to the "List of '+o+'" section</div>'),"reservation"===a?(s.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Unfinish")}),i&&s.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(i?"reservation was added directly, it cannot be marked unfinished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),$w.trigger("resize"),e.on("submit",function(e){e.preventDefault();var i=s.prop("checked");$.Dialog.wait(!1,'Removing "finished" flag'+(i?" & unbinding from user":"")),$.post("/post/unfinish-"+a+"/"+t+(i?"?unbind":""),$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,"undefined"!=typeof this.message?this.message:'"finished" flag removed successfully'),void n(a)):$.Dialog.fail(!1,this.message)}))})})}),o.filter(".check").off("click").on("click",function(e){e.preventDefault(),$.Dialog.wait("Submission approval status","Checking"),$.post("/post/lock-"+a+"/"+t,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this.message;n(a,function(){$.Dialog.success(!1,e,!0)})}))}),o.filter(".unlock").off("click").on("click",function(e){e.preventDefault(),$.Dialog.confirm("Unlocking post","Are you sure you want to unlock this post?",function(e){e&&($.Dialog.wait(!1),$.post("/post/unlock-"+a+"/"+t,$.mkAjaxHandler(function(){return this.status?void n(a):$.Dialog.fail(!1,this.message)})))})}),o.filter(".delete").on("click",function(){var e=$(this);$.Dialog.confirm("Deleteing request","You are about to permanently delete this request.<br>Are you sure about this?",function(i){i&&($.Dialog.wait(!1),$.post("/post/delete-request/"+t,$.mkAjaxHandler(function(){return this.status?($.Dialog.close(),void e.closest("li").fadeOut(1e3,function(){$(this).remove()})):$.Dialog.fail(!1,this.message)})))})}),o.filter(".edit").on("click",function(){var e=$(this),t=e.parents("li"),a=t.attr("id").split("-"),o=a[1],s=a[0];$.Dialog.wait("Editing "+s+" #"+o,"Retrieving "+s+" details"),$.post("/post/get-"+s+"/"+o,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this,a=$.mk("form").attr("id","post-edit-form").append($.mk("label").append($.mk("span").text("Description (3-255 chars."+("reservation"===s?", optional":"")+")"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{3,255}$",name:"label",required:"reservation"!==s})));"request"===s&&a.append($.mk("label").append($.mk("span").text("Request type"),$.mk("select").attr({name:"type",required:!0}).append($.mk("option").attr("value","chr").text("Character"),$.mk("option").attr("value","obj").text("Object"),$.mk("option").attr("value","bg").text("Backgound")))),"string"==typeof e.posted&&a.append($.mk("label").append($.mk("span").text("Post timestamp"),$.mk("input").attr({type:"datetime",name:"date",required:!0,spellcheck:!1,autocomplete:"off"}))),"string"==typeof e.reserved_at&&a.append($.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",spellcheck:!1,autocomplete:"off"}))),"string"==typeof e.finished_at&&a.append($.mk("label").append($.mk("span").text("Finished at"),$.mk("input").attr({type:"datetime",name:"finished_at",spellcheck:!1,autocomplete:"off"})));var l=0===t.children(".image").find(".typcn-tick").length,d="finished"===t.closest("div").attr("class"),c=d?t.children(".original"):t.children(".image").children("a"),u=c.attr("href"),p=!d&&!r.test(u)&&/deviantart\.net\//.test(u);(l||p)&&a.append($.mk("label").append(l?$.mk("a").text("Update Image").attr({href:"#update","class":"btn darkblue typcn typcn-pencil"}).on("click",function(e){e.preventDefault(),$.Dialog.close();var i=t.children(".image").find("img"),a=$.mk("form").attr("id","img-update-form").append($.mk("div").attr("class","oldimg").append($.mk("span").text("Current image"),i.clone()),$.mk("label").append($.mk("span").text("New image URL"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{2,255}$",name:"image_url",required:!0,autocomplete:"off",spellcheck:"false"})));$.Dialog.request("Update image of "+s+" #"+o,a,"Update",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();$.Dialog.wait(!1,"Replacing image"),$.post("/post/set-"+s+"-image/"+o,i,$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,"Image has been updated"),void n(s)):$.Dialog.fail(!1,this.message)}))})})}):void 0,p?$.mk("a").text("Sta.sh fullsize fix").attr({href:"#fix-stash-fullsize","class":"btn orange typcn typcn-spanner"}).on("click",function(e){e.preventDefault(),$.Dialog.close(),$.Dialog.wait("Fix Sta.sh fullsize URL","Fixing Sta.sh full size image URL"),$.post("/post/fix-"+s+"-stash/"+o,$.mkAjaxHandler(function(){if(!this.status){if(this.rmdirect){if(!d)return t.find(".post-date").children("a").first().triggerHandler("click"),$.Dialog.fail(!1,this.message+"<br>The post might be broken because of this, please check it for any issues.");t.children(".original").remove()}return $.Dialog.fail(!1,this.message)}c.attr("href",this.fullsize),$.Dialog.success(!1,"Fix successful",!0)}))}):void 0)),$.Dialog.request(!1,a,"Save",function(n){var a=n.find("[name=label]"),r=n.find("[name=type]"),l=void 0,d=void 0,c=void 0;if(e.label&&a.val(e.label),e.type&&r.children("option").filter(function(){return this.value===e.type}).attr("selected",!0),"string"==typeof e.posted){l=n.find("[name=date]");var u=moment(e.posted);l.val(u.format("YYYY-MM-DDTHH:mm:ssZ"))}if("string"==typeof e.reserved_at&&(d=n.find("[name=reserved_at]"),e.reserved_at.length)){var p=moment(e.reserved_at);d.val(p.format("YYYY-MM-DDTHH:mm:ssZ"))}if("string"==typeof e.finished_at&&(c=n.find("[name=finished_at]"),e.finished_at.length)){var f=moment(e.finished_at);c.val(f.format("YYYY-MM-DDTHH:mm:ssZ"))}n.on("submit",function(n){n.preventDefault();var u={label:a.val()};if("request"===s&&(u.type=r.val()),"string"==typeof e.posted){if(u.posted=new Date(l.val()),isNaN(u.posted.getTime()))return $.Dialog.fail(!1,"Post timestamp is invalid");u.posted=u.posted.toISOString()}if("string"==typeof e.reserved_at){var p=d.val();if(p.length){if(u.reserved_at=new Date(p),isNaN(u.reserved_at.getTime()))return $.Dialog.fail(!1,'"Reserved at" timestamp is invalid');u.reserved_at=u.reserved_at.toISOString()}}if("string"==typeof e.finished_at){var f=c.val().trim();if(f.length){if(u.finished_at=new Date(f),isNaN(u.finished_at.getTime()))return $.Dialog.fail(!1,'"Finished at" timestamp is invalid');u.finished_at=u.finished_at.toISOString()}}$.Dialog.wait(!1,"Saving changes"),$.post("/post/set-"+s+"/"+o,u,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.li){var e=$(this.li);t.hasClass("highlight")&&e.addClass("highlight"),t.replaceWith(e),e.rebindFluidbox(),Time.Update(),i(e,o,s)}$.Dialog.close()}))})})}))}),o.filter(".share").on("click",function(){var e=$(this),i=e.parents("li").children(".post-date").children("a").first().prop("href");$.Dialog.info("Sharing "+a+" #"+t,$.mk("div").attr("class","align-center").append("Use the link below to link to this post directly:",$.mk("div").attr("class","share-link").text(i),$.mk("button").attr("class","blue typcn typcn-clipboard").text("Copy to clipboard").on("click",function(e){$.copy(i,e)})))})}function n(e,t,i,n){if(u&&!n)return f(t,i);var s=$.capitalize(e),r=e.replace(/([^s])$/,"$1s"),l=function(){return"function"==typeof t&&i===!0?t(!1):void window.location.reload()};i!==!0&&$.Dialog.wait(!$.Dialog.isOpen()&&s,"Updating list of "+r,!0),$.ajax("/episode/"+r+"/S"+a+"E"+o,{method:"POST",success:$.mkAjaxHandler(function(){if(!this.status)return l();var n=$("#"+r),a=$(this.render).filter("section").children();n.empty().append(a).rebindHandlers(),n.find(".post-form").attr("data-type",e).formBind(),Time.Update(),"function"==typeof t?t():i!==!0&&$.Dialog.close()}),error:l})}var a=window.SEASON,o=window.EPISODE,s=window.USERNAME_REGEX,r=window.FULLSIZE_MATCH_REGEX,l="S"+a+"E"+o,d=$content.children("section.episode"),c=$("#live-update"),u=c.length,p=void 0,f=function(e,t){n("reservation",e,t,!0),n("request",e,t,!0)},h=void 0;window._HighlightHash=function(e){$(".highlight").removeClass("highlight");var t=$(location.hash);t.length&&(t.addClass("highlight"),setTimeout(function(){$.scrollTo(t.offset().top-$navbar.outerHeight()-10,500,function(){"object"===("undefined"==typeof e?"undefined":_typeof(e))&&"load"===e.type&&$.Dialog.close()})},1))},$w.on("hashchange",window._HighlightHash),u&&!function(){var t=void 0,i=30,n=function(){"undefined"!=typeof window._rlinterval&&(clearInterval(window._rlinterval),window._rlinterval=void 0)},a=c.find(".timer"),o=c.find("button.reload").on("click",function(t){t.preventDefault(),n();var i=function(t){a.html("&hellip;").css("color",""),o.disable().html("Reloading&hellip;");var i=0,n=2,s=function(a){return a===!1?e():(i++,void(i<n||(window._HighlightHash(),h(),t&&$.Dialog.close())))};f(s,!0)};$(".post-form").filter(":visible").length>0?$.Dialog.confirm("Reloading posts","You are in the process of posting a request/reservation. Reloading the posts will clear your progress.<br><br>Continue reloading?",function(e){e&&($.Dialog.wait(!1,"Updating posts"),i(!0))}):i()}),s=function(){var e=Math.round((t.getTime()-(new Date).getTime())/1e3)*-1,n=e>i?255:e/i*255;a.text(i-e+"s").css("color","rgb(255,"+(255-n/2)+","+(255-n)+")"),e>=i&&o.triggerHandler("click")};h=function(){o.html("Reload now").enable(),n(),p.hasClass("green")||(t=new Date,a.text(i+"s").css("color",""),window._rlinterval=setInterval(s,1e3))},p=c.find("button.disable").on("click",function(e){e.preventDefault();var t=p.hasClass("red");p.toggleHtml(["Enable","Disable"]).toggleClass("red green typcn-times typcn-tick"),t?a.parent().hide().next().show():a.parent().show().next().hide(),h()}),t=new Date,s(),window._rlinterval=setInterval(s,1e3),$w.on("dialog-opened",e)}(),$("#video").on("click",function(){$.Dialog.wait("Set video links","Requesting links from the server"),$.post("/episode/getvideos/"+l,$.mkAjaxHandler(function(){var e=this;if(!e.status)return $.Dialog.fail(!1,e.message);var i="<input type='url' class='yt' name='yt_1' placeholder='YouTube' spellcheck='false' autocomplete='off'>",n="<input type='url' class='dm' name='dm_1' placeholder='Dailymotion' spellcheck='false' autocomplete='off'>",a=$.mk("form").attr("id","vidlinks").attr("class","align-center").html("<p>Enter vido links below, leave any input blank to remove that video from the episode page.</p>\n\t\t\t\t\t<div class='input-group-2'>\n\t\t\t\t\t\t"+i+"\n\t\t\t\t\t\t"+n+"\n\t\t\t\t\t</div>");e.twoparter&&($.mk("p").html("<strong>~ Part 1 ~</strong>").insertBefore(a.children("input").first()),a.append("<p>Check below if either link contains the full episode instead of just one part</p>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label><input type='checkbox' name='yt_1_full'> YouTube</label> &nbsp; <label><input type='checkbox' name='dm_1_full'> Dailymotion</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p><strong>~ Part 2 ~</strong></p>\n\t\t\t\t\t<div class='input-group-2'>\n\t\t\t\t\t\t"+i.replace("yt_1","yt_2")+"\n\t\t\t\t\t\t"+n.replace("dm_1","dm_2")+"\n\t\t\t\t\t</div>"),a.find('input[type="checkbox"]').on("change",function(){var e=$(this).attr("name").replace(/^([a-z]+)_.*$/,"$1");a.find("input").filter("[name="+e+"_2]").attr("disabled",this.checked)}),e.fullep.length>0&&$.each(e.fullep,function(e,t){a.find('input[type="checkbox"]').filter('[name="'+t+'_1_full"]').prop("checked",!0).trigger("change")})),Object.keys(e.vidlinks).length>0&&!function(){var t=a.find('input[type="url"]');$.each(e.vidlinks,function(e,i){t.filter("[name="+e+"]").val(i)})}(),$.Dialog.request(!1,a,"Save",function(i){e.airs&&new Date(e.airs).getTime()>(new Date).getTime()&&!function(){var e=$.mk("div").addClass("notice warn").text("If you add this video now, it will be shown as a livestream link!");i.append(e),i.on("change keydown","input",function(){setTimeout(function(){var t=i.mkData(),n=t.yt_1&&t.yt_1_full&&!(t.dm_1||t.dm_2);e[n?"show":"hide"]()},1)}).triggerHandler("change")}(),i.on("submit",function(e){e.preventDefault();var n=i.mkData();$.Dialog.wait(!1,"Saving links"),$.post("/episode/setvideos/"+l,n,$.mkAjaxHandler(function(){return this.status?(this.epsection?(d.length||(d=$.mk("section").addClass("episode").insertBefore($content.children("section").first())),d.html($(this.epsection).filter("section").html()),t()):d.length&&(d.remove(),d={length:0}),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))});var g=$content.children("section.appearances");$("#cg-relations").on("click",function(){$.Dialog.wait("Guide relation editor","Retrieving relations from server"),$.post("/episode/getcgrelations/"+l,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this,t=$.mk("form").attr("id","guide-relation-editor"),i=$.mk("select").attr({name:"listed",multiple:!0}),n=$.mk("select").attr("multiple",!0);e.linked&&e.linked.length&&$.each(e.linked,function(e,t){i.append($.mk("option").attr("value",t.id).text(t.label))}),e.unlinked&&e.unlinked.length&&$.each(e.unlinked,function(e,t){n.append($.mk("option").attr("value",t.id).text(t.label))}),t.append($.mk("div").attr("class","split-select-wrap").append($.mk("div").attr("class","split-select").append("<span>Linked</span>",i),$.mk("div").attr("class","buttons").append($.mk("button").attr({"class":"typcn typcn-chevron-left green",title:"Link selected"}).on("click",function(e){e.preventDefault(),i.append(n.children(":selected").prop("selected",!1)).children().sort(function(e,t){return e.innerHTML.localeCompare(t.innerHTML)}).appendTo(i)}),$.mk("button").attr({"class":"typcn typcn-chevron-right red",title:"Unlink selected"}).on("click",function(e){e.preventDefault(),n.append(i.children(":selected").prop("selected",!1)).children().sort(function(e,t){return e.innerHTML.localeCompare(t.innerHTML)}).appendTo(n)})),$.mk("div").attr("class","split-select").append("<span>Available</span>",n))),$.Dialog.request(!1,t,"Save",function(e){e.on("submit",function(e){e.preventDefault();var t=[];i.children().each(function(e,i){t.push(i.value)}),$.Dialog.wait(!1,"Saving changes"),$.post("/episode/setcgrelations/"+l,{ids:t.join(",")},$.mkAjaxHandler(function(){return this.status?(this.section?(g.length||(g=$.mk("section").addClass("appearances").insertBefore($content.children(".admin"))),g.html($(this.section).filter("section").html())):g.length&&(g.remove(),g={length:0}),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))}),$("#edit-about_reservations, #edit-reservation_rules").on("click",function(e){e.preventDefault();var t=$(this).parent(),i=t.clone(),n=this.id.split("-").pop();i.children().remove();var a=i.text().trim();$.Dialog.wait('Editing "'+a+'"',"Retrieving setting's value"),$.post("/setting/get/"+n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("form",n+"-editor").html("<span>"+a+"</span>"),i=this.value;$.Dialog.request(!1,e,"Save",function(e){var a=void 0;$.getAceEditor(!1,"html",function(t){var n=ace.edit($.mk("div").appendTo(e).get(0));n.setShowPrintMargin(!1),a=$.aceInit(n,t),a.setMode(t),a.setUseWrapMode(!0),a.setValue(i)}),e.on("submit",function(e){e.preventDefault();var i={value:a.getValue()};$.Dialog.wait(!1,"Saving"),$.post("/setting/set/"+n,i,$.mkAjaxHandler(function(){return this.status?(t.siblings().remove(),t.parent().append(this.value),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))}),t();var m=$("#voting");m.on("click",".rate",function(e){e.preventDefault();var t=function(e){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:e}),$.mk("span")).on("mouseenter mouseleave",function(e){var t=$(this),i=t.parent().find("input:checked"),n=i.parent(),a=t.closest("div").next().children("strong");switch(e.type){case"mouseleave":if(0===n.length){t.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}t=n;case"mouseenter":t.prevAll().addBack().children("span").attr("class","active"),t.nextAll().children("span").attr("class",""),a.text(t.children("input").attr("value"))}t.siblings().addBack().removeClass("selected"),n.addClass("selected")})},i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(t(1),t(2),t(3),t(4),t(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5")),n=m.children(".rate");$.Dialog.request("Rating "+l,i,"Rate",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();return"undefined"==typeof i.vote?$.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins"):($.Dialog.wait(!1,"Submitting your rating"),void $.post("/episode/vote/"+l,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=n.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml),m.bindDetails(),$.Dialog.close()})))})})}),m.find("time").data("dyntime-beforeupdate",function(e){if(e.past===!0)return m.children(".rate").length?void 0:($.post("/episode/vote/"+l+"?html",$.mkAjaxHandler(function(){return this.status?(m.children("h2").nextAll().remove(),m.append(this.html),void m.bindDetails()):$.Dialog.fail("Display voting buttons",this.message)})),$(this).removeData("dyntime-beforeupdate"),!1)}),$.fn.bindDetails=function(){$(this).find("a.detail").on("click",function(e){e.preventDefault(),e.stopPropagation(),$.Dialog.wait("Voting details","Getting vote distribution information"),$.post("/episode/vote/"+l+"?detail",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("canvas"),t=e.get(0).getContext("2d"),i=$.mk("p").attr("class","tooltip");$.Dialog.info(!1,[$.mk("p").text("Here's a chart showing how the votes are distributed. Mouse over the different segments to see the exact number of votes."),$.mk("div").attr("id","vote-distrib").append(e,i)]);var n=[void 0,"#FF5454","#FFB554","#FFFF54","#8CD446","#4DC742"],a=this.data,o=0;return a.datasets[0].backgroundColor=[],a.datasets[0].hoverBackgroundColor=[],a.datasets[0].borderWidth=[],a.datasets[0].hoverBorderColor=[],$.each(a.datasets[0].data,function(e,t){var i=n[parseInt(a.labels[e],10)];a.datasets[0].backgroundColor.push(i);var s=$.hex2rgb(i),r=1.06;s.r=Math.min(255,s.r*r),s.g=Math.min(255,s.g*r),s.b=Math.min(255,s.b*r),a.datasets[0].hoverBackgroundColor.push($.rgb2hex(s)),a.datasets[0].borderWidth.push(2),a.datasets[0].hoverBorderColor.push("rgba("+s.r+","+s.g+","+s.b+",0.9)"),o+=parseInt(t,10)}),0===o?(e.remove(),void i.text("There are no votes for this episode yet")):void new Chart(t,{type:"pie",data:a,options:{titleFontColor:"#000",bodyFontColor:"#000",animation:{easing:"easeInOutExpo"},legend:{display:!1},tooltips:{callbacks:{title:function(e,t){var i=parseInt(t.labels[e[0].index],10);return i+" muffin"+(1!==i?"s":"")},label:function(e,t){var i=parseInt(t.datasets[e.datasetIndex].data[e.index],10),n=Math.round(i/o*1e3)/10;return i+" user"+(1!==i?"s":"")+" ("+n+"%)"}}}}})}))})},m.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find(".screencap > a").fluidbox({immediateOpen:!0,loader:!0}).on("openstart.fluidbox",function(){e(),$body.addClass("no-distractions")}).on("closestart.fluidbox",function(){$body.removeClass("no-distractions")})},$.fn.rebindHandlers=function(){return this.find("li[id]").each(function(){var e=$(this),t=parseInt(e.attr("id").replace(/\D/g,"")),n=e.closest("section[id]").attr("id").replace(/s$/,"");i(e,t,n)}),this.closest("section").find(".unfinished").rebindFluidbox(),this},$("#requests, #reservations").rebindHandlers(),$.fn.formBind=function(){function t(e){var t=u.data("prev-url"),i="string"==typeof t&&t.trim()===u.val().trim();if(r.attr("disabled",e===!0||i),e===!0||i?r.attr("title","You need to change the URL before chacking again."):r.removeAttr("title"),"keyup"===e.type){var n=u.val();k.test(n)&&u.val(u.val().replace(k,""))}}function i(){var e=u.val(),i=v+" process";r.removeClass("red"),t(!0),$.Dialog.wait(i,"Checking image"),$.post("/post",{image_url:e},$.mkAjaxHandler(function(){function t(n,a){$.Dialog.wait(i,"Checking image availability"),g.attr("src",n.preview).show().off("load error").on("load",function(){f.children("p:not(.keep)").remove(),u.data("prev-url",e),n.title&&!p.val().trim()?$.Dialog.confirm("Confirm "+m+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+n.title+"</strong></p><br>Would you like to use this as the "+m+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===m?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+m+" a description before clicking the "+b+" button.</p>",function(e){return e?(p.val(n.title),void $.Dialog.close()):s.find("input[name=label]").focus()}):$.Dialog.close(function(){s.find("input[name=label]").focus()})}).on("error",function(){return a<1?($.Dialog.wait("Can't load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){t(n,a+1)},2e3)):void $.Dialog.fail(i,"There was an error while attempting to load the image. Make sure the URL is correct and try again!")})}var n=this;return n.status?void t(n,0):(f.children("p:not(.keep)").remove(),f.prepend($.mk("p").attr("class","color-red").html(n.message)).show(),g.hide(),$.Dialog.close())}))}var s=$(this),r=s.find(".check-img"),d=s.find(".img-preview"),c=s.find("[name=label]"),u=s.find("[name=image_url]"),p=s.find("[name=label]"),f=d.children(".notice"),h=f.html(),g=d.children("img"),m=s.attr("data-type"),v=$.capitalize(m);0===g.length&&(g=$(new Image).appendTo(d)),$("#"+m+"-btn").on("click",function(){e(),s.is(":visible")||(s.show(),c.focus(),$.scrollTo(s.offset().top-$navbar.outerHeight()-10,500))}),"reservation"===m&&$("#add-reservation-btn").on("click",function(){var e=$.mk("form","add-reservation").html('<div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div>\n\t\t\t\t<div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div>\n\t\t\t\t<label>\n\t\t\t\t\t<span>Deviation URL</span>\n\t\t\t\t\t<input type="text" name="deviation">\n\t\t\t\t</label>');$.Dialog.request("Add a reservation",e,"Finish",function(e){e.on("submit",function(t){t.preventDefault();var i=e.find("[name=deviation]").val();return"string"!=typeof i||0===i.length?$.Dialog.fail(!1,"Please enter a deviation URL"):($.Dialog.wait(!1,"Adding reservation"),void $.post("/post/add-reservation",{deviation:i,epid:l},$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,this.message),void n(m)):$.Dialog.fail(!1,this.message)})))})})}),u.on("keyup change paste",t);var k=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,b='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';r.on("click",function(e){e.preventDefault(),i()}),s.on("submit",function(e,t,i){e.preventDefault();var r=v+" process";if("undefined"==typeof u.data("prev-url"))return $.Dialog.fail(r,"Please click the "+b+" button before submitting your "+m+"!");if(!t&&u.data("prev-url")!==u.val())return $.Dialog.confirm(r,"You modified the image URL without clicking the "+b+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&s.triggerHandler("submit",[!0])});if(!i&&"request"===m){var l=function(){var e=c.val(),i=s.find("select");if(e.indexOf("character")>-1&&"chr"!==i.val())return{v:$.Dialog.confirm(r,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){i.focus()}):s.triggerHandler("submit",[t,!0])})}}();if("object"===("undefined"==typeof l?"undefined":_typeof(l)))return l.v}var d=s.mkData({what:m,episode:o,season:a,image_url:u.data("prev-url")});!function p(){$.Dialog.wait(r,"Submitting "+m),$.post("/post",d,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,["Go ahead","Nevermind"],function(e){e&&(d.allow_nonmember=!0,p())}):$.Dialog.fail(!1,this.message);$.Dialog.success(!1,v+" posted");var e=this.id;n(m,function(){$.Dialog.close(),$("#"+m+"-"+e).find("em.post-date").children("a").triggerHandler("click")})}))}()}).on("reset",function(){r.attr("disabled",!1).addClass("red"),f.html(h).show(),g.hide(),u.removeData("prev-url"),$(this).hide()})},$(".post-form").each($.fn.formBind);var v=$content.find("img[src]"),k=v.length,b=0,y=/^#(request|reservation)-\d+$/,D=location.hash.length>1;k>0&&D?!function(){var e=void 0;D&&($.Dialog.wait("Scroll post into view","Waiting for page to load"),e=$.mk("progress").attr({max:k,value:0}).css({display:"block",width:"100%",marginTop:"5px"}),$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(e)),$content.imagesLoaded().progress(function(t,n){n.isLoaded?(b++,D&&e.attr("value",b)):n.img.src&&!function(){var t=$(n.img).closest("li[id]");1===t.length&&!function(){var e=t.attr("id").split("-"),n=e[0],a=e[1];$.post("/post/reload-"+n+"/"+a,$.mkAjaxHandler(function(){if(this.status){var e=$(this.li);t.hasClass("highlight")&&e.addClass("highlight"),t.replaceWith(e),e.rebindFluidbox(),Time.Update(),i(e,a,n)}}))}(),k--,D&&e.attr("max",k)}()}).always(function(){window._HighlightHash({type:"load"})})}():D&&y.test(location.hash)&&$.Dialog.info("Scroll post into view","The "+location.hash.replace(y,"$1")+" you were linked to has either been deleted or didn't exist in the first place. Sorry.<div class='align-center'><span class='sideways-smiley-face'>:\\</div>")},function(){$body.removeClass("no-distractions"),$(".fluidbox--opened").fluidbox("close"),"number"==typeof window._rlinterval&&clearInterval(window._rlinterval),$w.off("hashchange",window._HighlightHash),delete window._HighlightHash});
//# sourceMappingURL=/js/min/episode.js.map
