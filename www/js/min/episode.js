"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};DocReady.push(function(){function e(){var t=void 0,i=$(".episode"),o=i.find(".showplayers").on("scroll-video-into-view",function(){var e=$header.outerHeight();$.scrollTo(t.offset().top-($w.height()-$footer.outerHeight()-e-t.outerHeight())/2-e,500)}),n=o.parent(),r=void 0;if(o.length){var s=i.find(".reportbroken");o.on("click",function(e){if(e.preventDefault(),void 0===t)$.Dialog.wait(o.text()),$.post("/episode/video-embeds/"+a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);2===this.parts&&(r=$.mk("button").attr("class","blue typcn typcn-media-fast-forward").text("Part 2").on("click",function(){$(this).toggleHtml(["Part 1","Part 2"]),t.children().toggleClass("hidden")}),n.append(r)),t=$.mk("div").attr("class","resp-embed-wrap").html(this.html).insertAfter(n),o.removeClass("typcn-eye green").addClass("typcn-eye-outline blue").text("Hide on-site player").triggerHandler("scroll-video-into-view"),$.Dialog.close()}));else{var i=o.hasClass("typcn-eye");t[i?"show":"hide"](),r instanceof jQuery&&r.attr("disabled",!i),o.toggleClass("typcn-eye typcn-eye-outline").toggleHtml(["Show on-site player","Hide on-site player"]),i&&o.triggerHandler("scroll-video-into-view")}}),s.on("click",function(t){t.preventDefault(),$.Dialog.confirm("Report broken video",'<p>Have any of the linked videos been removed from their respective platform?<p><p>Please note that availability checking is automatic, bad video quality or sound issues cannot be detected this way. You should <a class="send-feedback">tell us</a> directly if that is the case.</p>',["Send report","Nevermind"],function(t){t&&($.Dialog.wait(!1,"Sending report"),$.post("/episode/broken-videos/"+a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);void 0!==this.epsection&&(this.epsection.length>0?(i.html(this.epsection),e()):i.remove()),$.Dialog.success(!1,this.message,!0)})))})})}}var t=window.SEASON,i=window.EPISODE,a="S"+t+"E"+i;window._HighlightHash=function(e){$(".highlight").removeClass("highlight");var t=$(location.hash);if(!t.length)return!1;t.addClass("highlight"),setTimeout(function(){$.scrollTo(t.offset().top-$navbar.outerHeight()-10,500,function(){"object"===(void 0===e?"undefined":_typeof(e))&&"load"===e.type&&$.Dialog.close()})},1)},$w.on("hashchange",window._HighlightHash);var o=$("#voting");o.on("click",".rate",function(e){e.preventDefault();var t=function(e){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:e}),$.mk("span")).on("mouseenter mouseleave",function(e){var t=$(this),i=t.parent().find("input:checked").parent(),a=t.closest("div").next().children("strong");switch(e.type){case"mouseleave":if(0===i.length){t.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}t=i;case"mouseenter":t.prevAll().addBack().children("span").attr("class","active"),t.nextAll().children("span").attr("class",""),a.text(t.children("input").attr("value"))}t.siblings().addBack().removeClass("selected"),i.addClass("selected")})},i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(t(1),t(2),t(3),t(4),t(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5")),n=o.children(".rate");$.Dialog.request("Rating "+a,i,"Rate",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();if(void 0===i.vote)return $.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins");$.Dialog.wait(!1,"Submitting your rating"),$.post("/episode/vote/"+a,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=n.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml),o.bindDetails(),$.Dialog.close()}))})})}),o.find("time").data("dyntime-beforeupdate",function(e){if(!0===e.past)return o.children(".rate").length?void 0:($.post("/episode/vote/"+a+"?html",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Display voting buttons",this.message);o.children("h2").nextAll().remove(),o.append(this.html),o.bindDetails()})),$(this).removeData("dyntime-beforeupdate"),!1)}),$.fn.bindDetails=function(){$(this).find("a.detail").on("click",function(e){e.preventDefault(),e.stopPropagation(),$.Dialog.wait("Voting details","Getting vote distribution information"),$.post("/episode/vote/"+a+"?detail",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("canvas"),t=e.get(0).getContext("2d"),i=$.mk("p").attr("class","tooltip");$.Dialog.info(!1,[$.mk("p").text("Here’s a chart showing how the votes are distributed. Mouse over the different segments to see the exact number of votes."),$.mk("div").attr("id","vote-distrib").append(e,i)]);var a=[void 0,"#FF5454","#FFB554","#FFFF54","#8CD446","#4DC742"],o=this.data,n=0;if(o.datasets[0].backgroundColor=[],o.datasets[0].hoverBackgroundColor=[],o.datasets[0].borderWidth=[],o.datasets[0].hoverBorderColor=[],$.each(o.datasets[0].data,function(e,t){var i=a[parseInt(o.labels[e],10)];o.datasets[0].backgroundColor.push(i);var r=$.hex2rgb(i);r.r=Math.round(Math.min(255,1.06*r.r)),r.g=Math.round(Math.min(255,1.06*r.g)),r.b=Math.round(Math.min(255,1.06*r.b)),o.datasets[0].hoverBackgroundColor.push($.rgb2hex(r)),o.datasets[0].borderWidth.push(2),o.datasets[0].hoverBorderColor.push("rgba("+r.r+","+r.g+","+r.b+",0.9)"),n+=parseInt(t,10)}),0===n)return e.remove(),void i.text("There are no votes for this episode yet");new Chart(t,{type:"pie",data:o,options:{titleFontColor:"#000",bodyFontColor:"#000",animation:{easing:"easeInOutExpo"},legend:{display:!1},tooltips:{callbacks:{title:function(e,t){var i=parseInt(t.labels[e[0].index],10);return i+" muffin"+(1!==i?"s":"")},label:function(e,t){var i=parseInt(t.datasets[e.datasetIndex].data[e.index],10),a=Math.round(i/n*1e3)/10;return i+" user"+(1!==i?"s":"")+" ("+a+"%)"}}}}})}))})},o.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find(".screencap > a:not(.fluidbox--initialized)").fluidboxThis()},$._getLiTypeId=function(e){var t=e.attr("id").split("-");return{id:t[1],type:t[0]+"s"}},$.fn.rebindHandlers=function(e){return(e?this:this.find("li[id]")).trigger("bind-more-handlers"),this.closest("section").rebindFluidbox(),this};var n=function(){var e=$(this),t=$._getLiTypeId(e),i=t.type,a=t.id,o=e.find(".actions").children();e.rebindFluidbox(),o.filter(".share").on("click",function(){var e=$(this),t=window.location.href.replace(/([^:/]\/).*$/,"$1")+"s/"+e.parents("li").attr("id").replace(/^(re[qs])[^-]+?-(\d+)$/,"$1/$2");$.Dialog.info("Sharing "+i.replace(/s$/,"")+" #"+a,$.mk("div").attr("class","align-center").append("Use the link below to link to this post directly:",$.mk("div").attr("class","share-link").text(t),$.mk("button").attr("class","blue typcn typcn-clipboard").text("Copy to clipboard").on("click",function(e){$.copy(t,e)})),function(){$("#dialogContent").find(".share-link").select()})})};$("#requests, #reservations").on("pls-update",function(e,t,i){var o=$(this),n=o.attr("id"),r=$.capitalize(n),s=n.replace(/([^s])$/,"$1s");!0!==i&&$.Dialog.wait(!$.Dialog.isOpen()&&r,"Updating list of "+s,!0),$.ajax("/episode/postlist/"+a+"?section="+s,{method:"POST",success:$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$(this.render).filter("section").children();o.empty().append(e).rebindHandlers(),o.find(".post-form").attr("data-type",n).formBind(),o.find("h2 > button").enable(),Time.Update(),window._HighlightHash(),"function"==typeof t?t():!0!==i&&$.Dialog.close()})})}).on("bind-more-handlers","li[id]",n).find("li[id]").each(n),$.fn.formBind=function(){function e(e){var t=d.data("prev-url"),i="string"==typeof t&&t.trim()===d.val().trim();if(r.attr("disabled",!0===e||i),!0===e||i?r.attr("title","You need to change the URL before chacking again."):r.removeAttr("title"),"keyup"===e.type){var a=d.val();v.test(a)&&d.val(d.val().replace(v,""))}}function o(){var t=d.val(),i=g+" process";r.removeClass("red"),e(!0),$.Dialog.wait(i,"Checking image"),$.post("/post/check-image",{image_url:t},$.mkAjaxHandler(function(){function e(a,o){$.Dialog.wait(i,"Checking image availability"),p.attr("src",a.preview).show().off("load error").on("load",function(){h.children("p:not(.keep)").remove(),d.data("prev-url",t),a.title&&!c.val().trim()?$.Dialog.confirm("Confirm "+f+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+a.title+"</strong></p><br>Would you like to use this as the "+f+"’s description?<br>Keep in mind that it should describe the thing(s) "+("request"===f?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+f+" a description before clicking the "+m+" button.</p>",function(e){if(!e)return n.find("input[name=label]").focus();c.val(a.title),$.Dialog.close()}):$.Dialog.close(function(){n.find("input[name=label]").focus()})}).on("error",function(){if(o<1)return $.Dialog.wait("Can’t load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){e(a,o+1)},2e3);$.Dialog.fail(i,"There was an error while attempting to load the image. Make sure the URL is correct and try again!"),r.enable()})}var a=this;if(!a.status)return h.children("p:not(.keep)").remove(),h.prepend($.mk("p").attr("class","color-red").html(a.message)).show(),p.hide(),r.enable(),$.Dialog.close();e(a,0)}))}var n=$(this);if(n.length){var r=n.find(".check-img"),s=n.find(".img-preview"),l=n.find("[name=label]"),d=n.find("[name=image_url]"),c=n.find("[name=label]"),h=s.children(".notice"),u=h.html(),p=s.children("img"),f=n.attr("data-type").replace(/s$/,""),g=$.capitalize(f);0===p.length&&(p=$(new Image).appendTo(s)),$("#"+f+"-btn").on("click",function(){n.is(":visible")||(n.removeClass("hidden"),l.focus(),$.scrollTo(n.offset().top-$navbar.outerHeight()-10,500))}),"reservation"===f&&$("#add-reservation-btn").on("click",function(){var e=$.mk("form","add-reservation").html('<div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div>\n\t\t\t\t<div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div>\n\t\t\t\t<label>\n\t\t\t\t\t<span>Deviation URL</span>\n\t\t\t\t\t<input type="text" name="deviation">\n\t\t\t\t</label>');$.Dialog.request("Add a reservation",e,"Finish",function(e){e.on("submit",function(t){t.preventDefault();var i=e.find("[name=deviation]").val();if("string"!=typeof i||0===i.length)return $.Dialog.fail(!1,"Please enter a deviation URL");$.Dialog.wait(!1,"Adding reservation"),$.post("/post/add-reservation",{deviation:i,epid:a},$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,this.message),$("#"+f+"s").trigger("pls-update")}))})})}),d.on("keyup change paste",e);var v=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,m='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';r.on("click",function(e){e.preventDefault(),o()}),n.on("submit",function(e,a,o){e.preventDefault();var r=g+" process";if(void 0===d.data("prev-url"))return $.Dialog.fail(r,"Please click the "+m+" button before submitting your "+f+"!");if(!a&&d.data("prev-url")!==d.val())return $.Dialog.confirm(r,"You modified the image URL without clicking the "+m+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&n.triggerHandler("submit",[!0])});if(!o&&"request"===f){var s=l.val(),c=n.find("select");if(s.indexOf("character")>-1&&"chr"!==c.val())return $.Dialog.confirm(r,'Your request label contains the word "character", but the request type isn’t set to Character.<br>Are you sure you\'re not requesting one (or more) character(s)?',["Let me change the type","Carray on"],function(e){if(!e)return n.triggerHandler("submit",[a,!0]);$.Dialog.close(function(){c.focus()})})}var h=n.mkData({what:f,episode:i,season:t,image_url:d.data("prev-url")});!function e(){$.Dialog.wait(r,"Submitting "+f),$.post("/post/add",h,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,["Go ahead","Nevermind"],function(t){t&&(h.allow_nonmember=!0,e())}):$.Dialog.fail(!1,this.message);$.Dialog.success(!1,g+" posted");var t=this.id;$("#"+f+"s").trigger("pls-update",[function(){$.Dialog.close(),$.Dialog.confirm(g+" posted","Would you like to view it or make another?",["View","Make another"],function(e){$.Dialog.close(),e||$("#"+f+"-btn").trigger("click")}),window.location.hash="#"+t}])}))}()}).on("reset",function(){r.attr("disabled",!1).addClass("red"),h.html(u).show(),p.hide(),d.removeData("prev-url"),$(this).hide()})}},$.each(["requests","reservations"],function(e,t){$("#"+t).trigger("bind-more-handlers").find(".post-form").attr("data-type",t).formBind()}),function(){var e=$content.find("img[src]").length,t=0;if(!e)return $.Dialog.close();var i=void 0;l&&($.Dialog.wait("Scroll post into view","Waiting for page to load"),i=$.mk("progress").attr({max:e,value:0}).css({display:"block",width:"100%",marginTop:"5px"}),$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(i)),$content.imagesLoaded().progress(function(a,o){if(o.isLoaded)t++,l&&i.attr("value",t);else if(o.img.src){var n=$(o.img).closest("li[id]");1===n.length&&n.reloadLi(),e--,l&&i.attr("max",e)}}).always(function(){!1===window._HighlightHash({type:"load"})&&l&&$.Dialog.info("Scroll post into view","The "+location.hash.replace(s,"$1")+" you were linked to has either been deleted or didn’t exist in the first place. Sorry.<div class='align-center'><span class='sideways-smiley-face'>:\\</div>")})}();var r=function(){$(".post-deviation-promise:not(.loading)").each(function(){var e=$(this);if(e.isInViewport()){var t=e.attr("data-post").replace("-","/"),i=e.attr("data-viewonly");e.addClass("loading"),$.get("/post/lazyload/"+t,{viewonly:i},$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Cannot load "+t.replace("/"," #"),this.message);$.loadImages(this.html).then(function(t){e.closest(".image").replaceWith(t)})}))}})};window._EpisodeScroll=$.throttle(400,function(){r()}),$w.on("scroll mousewheel",window._EpisodeScroll),window._EpisodeScroll();var s=/^#(request|reservation)-\d+$/,l=location.hash.length>1&&s.test(location.hash);l&&$.Dialog.wait("Scroll post into view","Preloading all posts, please wait");var d={};$.fn.reloadLi=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=this,a=i.attr("id");if("string"!=typeof a||i.hasClass("admin-break"))return this;if(!0===d[a])return this;d[a]=!0;var o=a.split("-"),n=o[0],r=o[1];return e&&console.log("[POST-FIX] Attemting to reload "+n+" #"+r),$.post("/post/reload/"+n+"/"+r,{cache:e},$.mkAjaxHandler(function(){if(d[a]=!1,this.status){if(!0===this.broken)return i.remove(),void console.log("[POST-FIX] Hid (broken) "+n+" #"+r);var o=$(this.li);((i=$("#"+o.attr("id"))).hasClass("highlight")||o.is(location.hash))&&o.addClass("highlight"),i.replaceWith(o),o.rebindFluidbox(),Time.Update(),o.rebindHandlers(!0),o.parent().is(this.section)||o.appendTo(this.section),o.parent().reorderPosts(),e&&console.log("[POST-FIX] Reloaded "+n+" #"+r),$.callCallback(t)}})),this},$.fn.reorderPosts=function(){var e=this;e.children().sort(function(e,t){var i=$(e),a=$(t),o=new Date(i.find(".post-date time").attr("datetime")).getTime()-new Date(a.find(".post-date time").attr("datetime")).getTime();return 0===o?parseInt(i.attr("id").replace("/D/g",""),10)-parseInt(a.attr("id").replace("/D/g",""),10):o}).appendTo(e)},window.bindVideoButtons=e,e(),$.WS.recvPostUpdates(!0)},function(){$body.removeClass("fluidbox-open"),$(".fluidbox--opened").fluidbox("close"),"number"==typeof window._rlinterval&&clearInterval(window._rlinterval),$w.off("hashchange",window._HighlightHash),delete window.bindVideoButtons,delete window._HighlightHash,delete $.fn.rebindFluidbox,window.EpisodePage=void 0,$.WS.recvPostUpdates(!1),delete $.fn.reloadLi,$w.off("scroll mousewheel",window._EpisodeScroll),delete window._EpisodeScroll});
//# sourceMappingURL=/js/min/episode.js.map
