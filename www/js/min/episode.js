'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};DocReady.push(function(){'use strict';function a(){var a=$content.find('img[src]'),b=a.length,c=0;if(!b)return $.Dialog.close();var d;m&&($.Dialog.wait('Scroll post into view','Waiting for page to load'),d=$.mk('progress').attr({max:b,value:0}).css({display:'block',width:'100%',marginTop:'5px'}),$('#dialogContent').children('div:not([id])').last().addClass('align-center').append(d)),$content.imagesLoaded().progress(function(a,e){if(e.isLoaded)c++,m&&d.attr('value',c);else if(e.img.src){var f=$(e.img).closest('li[id]');1===f.length&&f.reloadLi(),b--,m&&d.attr('max',b)}}).always(function(){var a=window._HighlightHash({type:'load'});!1===a&&m&&$.Dialog.info('Scroll post into view','The '+location.hash.replace(l,'$1')+' you were linked to has either been deleted or didn\u2019t exist in the first place. Sorry.<div class=\'align-center\'><span class=\'sideways-smiley-face\'>:\\</div>')})}function b(){var a,c,d=$('.episode'),g=d.find('.showplayers').on('scroll-video-into-view',function(){var b=$header.outerHeight();$.scrollTo(a.offset().top-($w.height()-$footer.outerHeight()-b-a.outerHeight())/2-b,500)}),e=g.parent();if(g.length){var h=d.find('.reportbroken');g.on('click',function(b){if(b.preventDefault(),'undefined'==typeof a)$.Dialog.wait(g.text()),$.post('/episode/video-embeds/'+f,$.mkAjaxHandler(function(){return this.status?void(2===this.parts&&(c=$.mk('button').attr('class','blue typcn typcn-media-fast-forward').text('Part 2').on('click',function(){$(this).toggleHtml(['Part 1','Part 2']),a.children().toggleClass('hidden')}),e.append(c)),a=$.mk('div').attr('class','resp-embed-wrap').html(this.html).insertAfter(e),g.removeClass('typcn-eye green').addClass('typcn-eye-outline blue').text('Hide on-site player').triggerHandler('scroll-video-into-view'),$.Dialog.close()):$.Dialog.fail(!1,this.message)}));else{var d=g.hasClass('typcn-eye');a[d?'show':'hide'](),c instanceof jQuery&&c.attr('disabled',!d),g.toggleClass('typcn-eye typcn-eye-outline').toggleHtml(['Show on-site player','Hide on-site player']),d&&g.triggerHandler('scroll-video-into-view')}}),h.on('click',function(a){a.preventDefault(),$.Dialog.confirm('Report broken video','<p>Have any of the linked videos been removed from their respective platform?<p><p>Please note that availability checking is automatic, bad video quality or sound issues cannot be detected this way. You should <a class="send-feedback">tell us</a> directly if that is the case.</p>',['Send report','Nevermind'],function(a){a&&($.Dialog.wait(!1,'Sending report'),$.post('/episode/broken-videos/'+f,$.mkAjaxHandler(function(){return this.status?void('undefined'!=typeof this.epsection&&(0<this.epsection.length?(d.html(this.epsection),b()):d.remove()),$.Dialog.success(!1,this.message,!0)):$.Dialog.fail(!1,this.message)})))})})}}var c=window.SEASON,d=window.EPISODE,f='S'+c+'E'+d;window._HighlightHash=function(a){$('.highlight').removeClass('highlight');var b=$(location.hash);return!!b.length&&void(b.addClass('highlight'),setTimeout(function(){$.scrollTo(b.offset().top-$navbar.outerHeight()-10,500,function(){'object'===('undefined'==typeof a?'undefined':_typeof(a))&&'load'===a.type&&$.Dialog.close()})},1))},$w.on('hashchange',window._HighlightHash);var g=$('#voting');g.on('click','.rate',function(a){a.preventDefault();var b=function(a){return $.mk('label').append($.mk('input').attr({type:'radio',name:'vote',value:a}),$.mk('span')).on('mouseenter mouseleave',function(a){var b=$(this),c=b.parent().find('input:checked'),d=c.parent(),e=b.closest('div').next().children('strong');switch(a.type){case'mouseleave':if(0===d.length){b.siblings().addBack().find('.typcn').attr('class',''),e.text('?');break}b=d;case'mouseenter':b.prevAll().addBack().children('span').attr('class','active'),b.nextAll().children('span').attr('class',''),e.text(b.children('input').attr('value'));}b.siblings().addBack().removeClass('selected'),d.addClass('selected')})},c=$.mk('form').attr('id','star-rating').append($.mk('p').text('Rate the episode on a scale of 1 to 5. This cannot be changed later.'),$.mk('div').attr('class','rate').append(b(1),b(2),b(3),b(4),b(5)),$.mk('p').css('font-size','1.1em').append('Your rating: <strong>?</strong>/5')),d=g.children('.rate');$.Dialog.request('Rating '+f,c,'Rate',function(a){a.on('submit',function(b){b.preventDefault();var c=a.mkData();return'undefined'==typeof c.vote?$.Dialog.fail(!1,'Please choose a rating by clicking on one of the muffins'):void($.Dialog.wait(!1,'Submitting your rating'),$.post('/episode/vote/'+f,c,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var a=d.closest('section');a.children('h2').nextAll().remove(),a.append(this.newhtml),g.bindDetails(),$.Dialog.close()})))})})}),g.find('time').data('dyntime-beforeupdate',function(a){return!0===a.past?g.children('.rate').length?void 0:($.post('/episode/vote/'+f+'?html',$.mkAjaxHandler(function(){return this.status?void(g.children('h2').nextAll().remove(),g.append(this.html),g.bindDetails()):$.Dialog.fail('Display voting buttons',this.message)})),$(this).removeData('dyntime-beforeupdate'),!1):void 0}),$.fn.bindDetails=function(){$(this).find('a.detail').on('click',function(a){a.preventDefault(),a.stopPropagation(),$.Dialog.wait('Voting details','Getting vote distribution information'),$.post('/episode/vote/'+f+'?detail',$.mkAjaxHandler(function(){var a=Math.round;if(!this.status)return $.Dialog.fail(!1,this.message);var b=$.mk('canvas'),c=b.get(0).getContext('2d'),d=$.mk('p').attr('class','tooltip');$.Dialog.info(!1,[$.mk('p').text('Here\u2019s a chart showing how the votes are distributed. Mouse over the different segments to see the exact number of votes.'),$.mk('div').attr('id','vote-distrib').append(b,d)]);var e=[void 0,'#FF5454','#FFB554','#FFFF54','#8CD446','#4DC742'],f=this.data,g=0;return f.datasets[0].backgroundColor=[],f.datasets[0].hoverBackgroundColor=[],f.datasets[0].borderWidth=[],f.datasets[0].hoverBorderColor=[],$.each(f.datasets[0].data,function(b,c){var d=Math.min,h=e[parseInt(f.labels[b],10)];f.datasets[0].backgroundColor.push(h);var i=$.hex2rgb(h),j=1.06;i.r=a(d(255,i.r*j)),i.g=a(d(255,i.g*j)),i.b=a(d(255,i.b*j)),f.datasets[0].hoverBackgroundColor.push($.rgb2hex(i)),f.datasets[0].borderWidth.push(2),f.datasets[0].hoverBorderColor.push('rgba('+i.r+','+i.g+','+i.b+',0.9)'),g+=parseInt(c,10)}),0===g?(b.remove(),void d.text('There are no votes for this episode yet')):void new Chart(c,{type:'pie',data:f,options:{titleFontColor:'#000',bodyFontColor:'#000',animation:{easing:'easeInOutExpo'},legend:{display:!1},tooltips:{callbacks:{title:function title(a,b){var c=parseInt(b.labels[a[0].index],10);return c+' muffin'+(1===c?'':'s')},label:function label(b,c){var d=parseInt(c.datasets[b.datasetIndex].data[b.index],10),e=a(1e3*(d/g))/10;return d+' user'+(1===d?'':'s')+' ('+e+'%)'}}}}})}))})},g.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find('.screencap > a:not(.fluidbox--initialized)').fluidboxThis()},$._getLiTypeId=function(a){var b=a.attr('id').split('-');return{id:b[1],type:b[0]+'s'}},$.fn.rebindHandlers=function(a){var b=a?this:this.find('li[id]');return b.each(function(){var a=$(this),b=$._getLiTypeId(a);a.trigger('bind-more-handlers',[b.id,b.type])}),this.closest('section').rebindFluidbox(),this};var e=function(){var a=$(this),b=$._getLiTypeId(a),c=b.type,d=b.id,e=a.find('.actions').children();a.rebindFluidbox(),e.filter('.share').on('click',function(){var a=$(this),b=window.location.href.replace(/([^:/]\/).*$/,'$1')+'s/'+a.parents('li').attr('id').replace(/^(re[qs])[^-]+?-(\d+)$/,'$1/$2');$.Dialog.info('Sharing '+c.replace(/s$/,'')+' #'+d,$.mk('div').attr('class','align-center').append('Use the link below to link to this post directly:',$.mk('div').attr('class','share-link').text(b),$.mk('button').attr('class','blue typcn typcn-clipboard').text('Copy to clipboard').on('click',function(a){$.copy(b,a)})),function(){$('#dialogContent').find('.share-link').select()})})};$('#requests, #reservations').on('pls-update',function(a,b,c){var d=$(this),e=d.attr('id'),g=$.capitalize(e),h=e.replace(/([^s])$/,'$1s');!0!==c&&$.Dialog.wait(!$.Dialog.isOpen()&&g,'Updating list of '+h,!0),$.ajax('/episode/postlist/'+f+'?section='+h,{method:'POST',success:$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var a=$(this.render).filter('section').children();d.empty().append(a).rebindHandlers(),d.find('.post-form').attr('data-type',e).formBind(),d.find('h2 > button').enable(),Time.Update(),window._HighlightHash(),'function'==typeof b?b():!0!==c&&$.Dialog.close()})})}).on('bind-more-handlers','li[id]',e).find('li[id]').each(e),$.fn.formBind=function(){function a(a){var b=j.data('prev-url'),c='string'==typeof b&&b.trim()===j.val().trim();if(e.attr('disabled',!0===a||c),!0===a||c?e.attr('title','You need to change the URL before chacking again.'):e.removeAttr('title'),'keyup'===a.type){var d=j.val();q.test(d)&&j.val(j.val().replace(q,''))}}function b(){var b=j.val(),c=p+' process';e.removeClass('red'),a(!0),$.Dialog.wait(c,'Checking image'),$.post('/post/check-image',{image_url:b},$.mkAjaxHandler(function(){function a(d,f){$.Dialog.wait(c,'Checking image availability'),n.attr('src',d.preview).show().off('load error').on('load',function(){l.children('p:not(.keep)').remove(),j.data('prev-url',b),!d.title||k.val().trim()?$.Dialog.close(function(){g.find('input[name=label]').focus()}):$.Dialog.confirm('Confirm '+o+' title','The image you just checked had the following title:<br><br><p class="align-center"><strong>'+d.title+'</strong></p><br>Would you like to use this as the '+o+'\u2019s description?<br>Keep in mind that it should describe the thing(s) '+('request'===o?'being requested':'you plan to vector')+'.<p>This dialog will not appear if you give your '+o+' a description before clicking the '+r+' button.</p>',function(a){return a?void(k.val(d.title),$.Dialog.close()):g.find('input[name=label]').focus()})}).on('error',function(){return 1>f?($.Dialog.wait('Can\u2019t load image','Image could not be loaded, retrying in 2 seconds'),void setTimeout(function(){a(d,f+1)},2e3)):void($.Dialog.fail(c,'There was an error while attempting to load the image. Make sure the URL is correct and try again!'),e.enable())})}var d=this;return d.status?void a(d,0):(l.children('p:not(.keep)').remove(),l.prepend($.mk('p').attr('class','color-red').html(d.message)).show(),n.hide(),e.enable(),$.Dialog.close())}))}var g=$(this);if(g.length){var e=g.find('.check-img'),h=g.find('.img-preview'),i=g.find('[name=label]'),j=g.find('[name=image_url]'),k=g.find('[name=label]'),l=h.children('.notice'),m=l.html(),n=h.children('img'),o=g.attr('data-type').replace(/s$/,''),p=$.capitalize(o);0===n.length&&(n=$(new Image).appendTo(h)),$('#'+o+'-btn').on('click',function(){g.is(':visible')||(g.removeClass('hidden'),i.focus(),$.scrollTo(g.offset().top-$navbar.outerHeight()-10,500))}),'reservation'===o&&$('#add-reservation-btn').on('click',function(){var a=$.mk('form','add-reservation').html('<div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div>\n\t\t\t\t<div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div>\n\t\t\t\t<label>\n\t\t\t\t\t<span>Deviation URL</span>\n\t\t\t\t\t<input type="text" name="deviation">\n\t\t\t\t</label>');$.Dialog.request('Add a reservation',a,'Finish',function(a){a.on('submit',function(b){b.preventDefault();var c=a.find('[name=deviation]').val();return'string'!=typeof c||0===c.length?$.Dialog.fail(!1,'Please enter a deviation URL'):void($.Dialog.wait(!1,'Adding reservation'),$.post('/post/add-reservation',{deviation:c,epid:f},$.mkAjaxHandler(function(){return this.status?void($.Dialog.success(!1,this.message),$('#'+o+'s').trigger('pls-update')):$.Dialog.fail(!1,this.message)})))})})}),j.on('keyup change paste',a);var q=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,r='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';e.on('click',function(a){a.preventDefault(),b()}),g.on('submit',function(a,b,e){a.preventDefault();var f=p+' process';if('undefined'==typeof j.data('prev-url'))return $.Dialog.fail(f,'Please click the '+r+' button before submitting your '+o+'!');if(!b&&j.data('prev-url')!==j.val())return $.Dialog.confirm(f,'You modified the image URL without clicking the '+r+' button.<br>Do you want to continue with the last checked URL?',function(a){a&&g.triggerHandler('submit',[!0])});if(!e&&'request'===o){var k=i.val(),l=g.find('select');if(-1<k.indexOf('character')&&'chr'!==l.val())return $.Dialog.confirm(f,'Your request label contains the word "character", but the request type isn\u2019t set to Character.<br>Are you sure you\'re not requesting one (or more) character(s)?',['Let me change the type','Carray on'],function(a){return a?void $.Dialog.close(function(){l.focus()}):g.triggerHandler('submit',[b,!0])})}var h=g.mkData({what:o,episode:d,season:c,image_url:j.data('prev-url')});(function a(){$.Dialog.wait(f,'Submitting '+o),$.post('/post/add',h,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,['Go ahead','Nevermind'],function(b){b&&(h.allow_nonmember=!0,a())}):$.Dialog.fail(!1,this.message);$.Dialog.success(!1,p+' posted');var b=this.id;$('#'+o+'s').trigger('pls-update',[function(){$.Dialog.close(),$.Dialog.confirm(p+' posted','Would you like to view it or make another?',['View','Make another'],function(a){$.Dialog.close(),a||$('#'+o+'-btn').trigger('click')}),window.location.hash='#'+b}])}))})()}).on('reset',function(){e.attr('disabled',!1).addClass('red'),l.html(m).show(),n.hide(),j.removeData('prev-url'),$(this).hide()})}};var h=['requests','reservations'],i=0,j={},k=function(b,c){$.each(h,function(b,d){(function(b){var d=$('#'+b);!0!==j[b]&&($.isInViewport(d.get(0))||c)&&(j[b]=!0,console.log('[DYN-POSTS] Loading %s section (force=%s)',b,c),d.trigger('pls-update',[function(){h.splice(h.indexOf(b),1),console.log('[DYN-POSTS] Loaded %s section',b),2==++i&&($w.off('scroll',k),a(!0))},!0,!0]))})(d)})};$w.on('scroll touchmove',$.throttle(250,k)),k();var l=/^#(request|reservation)-\d+$/,m=1<location.hash.length&&l.test(location.hash);m&&($.Dialog.wait('Scroll post into view','Preloading all posts, please wait'),k(null,!0));var n={};$.fn.reloadLi=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,b=this,c=b.attr('id');if('string'!=typeof c||b.hasClass('admin-break'))return this;if(!0===n[c])return this;n[c]=!0;var d=c.split('-'),e=d[0],f=d[1];return a&&console.log('[POST-FIX] Attemting to reload '+e+' #'+f),$.post('/post/reload/'+e+'/'+f,{cache:a},$.mkAjaxHandler(function(){if(n[c]=!1,!!this.status){if(!0===this.broken)return b.remove(),void console.log('[POST-FIX] Hid (broken) '+e+' #'+f);var d=$(this.li);b=$('#'+d.attr('id')),(b.hasClass('highlight')||d.is(location.hash))&&d.addClass('highlight'),b.replaceWith(d),d.rebindFluidbox(),Time.Update(),d.rebindHandlers(!0),d.parent().is(this.section)||d.appendTo(this.section),d.parent().reorderPosts(),a&&console.log('[POST-FIX] Reloaded '+e+' #'+f)}})),this},$.fn.reorderPosts=function(){var a=this;a.children().sort(function(c,a){var b=$(c),d=$(a),e=new Date(b.find('.post-date time').attr('datetime')).getTime()-new Date(d.find('.post-date time').attr('datetime')).getTime();return 0==e?parseInt(b.attr('id').replace('/D/g',''),10)-parseInt(d.attr('id').replace('/D/g',''),10):e}).appendTo(a)},window.bindVideoButtons=b,b(),$.WS.recvPostUpdates(!0)},function(){'use strict';$body.removeClass('fluidbox-open'),$('.fluidbox--opened').fluidbox('close'),'number'==typeof window._rlinterval&&clearInterval(window._rlinterval),$w.off('hashchange',window._HighlightHash),delete window.bindVideoButtons,delete window._HighlightHash,delete $.fn.rebindFluidbox,window.EpisodePage=void 0,$.WS.recvPostUpdates(!1),delete $.fn.reloadLi});
//# sourceMappingURL=/js/min/episode.js.map
