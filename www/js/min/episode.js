"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};DocReady.push(function(){function e(){"undefined"!=typeof r&&r.filter(".red").triggerHandler("click")}var t=window.SEASON,i=window.EPISODE,n="S"+t+"E"+i,a=$("#live-update"),o=a.length,r=void 0,s=function(e,t){$("#reservations, #requests").trigger("pls-update",[e,t,!0])},l=void 0;window._HighlightHash=function(e){$(".highlight").removeClass("highlight");var t=$(location.hash);return!!t.length&&(t.addClass("highlight"),void setTimeout(function(){$.scrollTo(t.offset().top-$navbar.outerHeight()-10,500,function(){"object"===("undefined"==typeof e?"undefined":_typeof(e))&&"load"===e.type&&$.Dialog.close()})},1))},$w.on("hashchange",window._HighlightHash),o&&!function(){var t=void 0,i=30,n=function(){"undefined"!=typeof window._rlinterval&&(clearInterval(window._rlinterval),window._rlinterval=void 0)},o=a.find(".timer"),d=a.find("button.reload").on("click",function(t){t.preventDefault(),n();var i=function(t){o.html("&hellip;").css("color",""),d.disable().html("Reloading&hellip;");var i=0,n=2,a=function(a){return a===!1?e():(i++,void(i<n||(window._HighlightHash(),l(),t&&$.Dialog.close())))};s(a,!0)};$(".post-form").filter(":visible").length>0?$.Dialog.confirm("Reloading posts","You are in the process of posting a request/reservation. Reloading the posts will clear your progress.<br><br>Continue reloading?",function(e){e&&($.Dialog.wait(!1,"Updating posts"),i(!0))}):i()}),c=function(){var e=Math.round((t.getTime()-(new Date).getTime())/1e3)*-1,n=e>i?255:e/i*255;o.text(i-e+"s").css("color","rgb(255,"+(255-n/2)+","+(255-n)+")"),e>=i&&d.triggerHandler("click")};l=function(){d.html("Reload now").enable(),n(),r.hasClass("green")||(t=new Date,o.text(i+"s").css("color",""),window._rlinterval=setInterval(c,1e3))},r=a.find("button.disable").on("click",function(e){e.preventDefault();var t=r.hasClass("red");r.toggleHtml(["Enable","Disable"]).toggleClass("red green typcn-times typcn-tick"),t?o.parent().hide().next().show():o.parent().show().next().hide(),l()}),t=new Date,c(),window._rlinterval=setInterval(c,1e3),$w.on("dialog-opened",e)}();var d=$("#voting");d.on("click",".rate",function(e){e.preventDefault();var t=function(e){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:e}),$.mk("span")).on("mouseenter mouseleave",function(e){var t=$(this),i=t.parent().find("input:checked"),n=i.parent(),a=t.closest("div").next().children("strong");switch(e.type){case"mouseleave":if(0===n.length){t.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}t=n;case"mouseenter":t.prevAll().addBack().children("span").attr("class","active"),t.nextAll().children("span").attr("class",""),a.text(t.children("input").attr("value"))}t.siblings().addBack().removeClass("selected"),n.addClass("selected")})},i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(t(1),t(2),t(3),t(4),t(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5")),a=d.children(".rate");$.Dialog.request("Rating "+n,i,"Rate",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();return"undefined"==typeof i.vote?$.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins"):($.Dialog.wait(!1,"Submitting your rating"),void $.post("/episode/vote/"+n,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=a.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml),d.bindDetails(),$.Dialog.close()})))})})}),d.find("time").data("dyntime-beforeupdate",function(e){if(e.past===!0)return d.children(".rate").length?void 0:($.post("/episode/vote/"+n+"?html",$.mkAjaxHandler(function(){return this.status?(d.children("h2").nextAll().remove(),d.append(this.html),void d.bindDetails()):$.Dialog.fail("Display voting buttons",this.message)})),$(this).removeData("dyntime-beforeupdate"),!1)}),$.fn.bindDetails=function(){$(this).find("a.detail").on("click",function(e){e.preventDefault(),e.stopPropagation(),$.Dialog.wait("Voting details","Getting vote distribution information"),$.post("/episode/vote/"+n+"?detail",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("canvas"),t=e.get(0).getContext("2d"),i=$.mk("p").attr("class","tooltip");$.Dialog.info(!1,[$.mk("p").text("Here's a chart showing how the votes are distributed. Mouse over the different segments to see the exact number of votes."),$.mk("div").attr("id","vote-distrib").append(e,i)]);var n=[void 0,"#FF5454","#FFB554","#FFFF54","#8CD446","#4DC742"],a=this.data,o=0;return a.datasets[0].backgroundColor=[],a.datasets[0].hoverBackgroundColor=[],a.datasets[0].borderWidth=[],a.datasets[0].hoverBorderColor=[],$.each(a.datasets[0].data,function(e,t){var i=n[parseInt(a.labels[e],10)];a.datasets[0].backgroundColor.push(i);var r=$.hex2rgb(i),s=1.06;r.r=Math.min(255,r.r*s),r.g=Math.min(255,r.g*s),r.b=Math.min(255,r.b*s),a.datasets[0].hoverBackgroundColor.push($.rgb2hex(r)),a.datasets[0].borderWidth.push(2),a.datasets[0].hoverBorderColor.push("rgba("+r.r+","+r.g+","+r.b+",0.9)"),o+=parseInt(t,10)}),0===o?(e.remove(),void i.text("There are no votes for this episode yet")):void new Chart(t,{type:"pie",data:a,options:{titleFontColor:"#000",bodyFontColor:"#000",animation:{easing:"easeInOutExpo"},legend:{display:!1},tooltips:{callbacks:{title:function(e,t){var i=parseInt(t.labels[e[0].index],10);return i+" muffin"+(1!==i?"s":"")},label:function(e,t){var i=parseInt(t.datasets[e.datasetIndex].data[e.index],10),n=Math.round(i/o*1e3)/10;return i+" user"+(1!==i?"s":"")+" ("+n+"%)"}}}}})}))})},d.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find(".screencap > a").fluidbox({immediateOpen:!0,loader:!0}).on("openstart.fluidbox",function(){e(),$body.addClass("no-distractions")}).on("closestart.fluidbox",function(){$body.removeClass("no-distractions")})},$._getLiTypeId=function(e){var t=e.attr("id").split("-");return{id:t[1],type:t[0]+"s"}},$.fn.rebindHandlers=function(){return this.find("li[id]").each(function(){var e=$(this),t=$._getLiTypeId(e);e.trigger("bind-more-handlers",[t.id,t.type])}),this.closest("section").find(".unfinished").rebindFluidbox(),this};var c=function(){var e=$(this),t=$._getLiTypeId(e),i=t.type,n=t.id,a=e.find(".actions").children();a.filter(".share").on("click",function(){var e=$(this),t=e.parents("li").children(".post-date").children("a").first().prop("href");$.Dialog.info("Sharing "+i+" #"+n,$.mk("div").attr("class","align-center").append("Use the link below to link to this post directly:",$.mk("div").attr("class","share-link").text(t),$.mk("button").attr("class","blue typcn typcn-clipboard").text("Copy to clipboard").on("click",function(e){$.copy(t,e)})))})};$("#requests, #reservations").on("pls-update",function(e,n,a,r){if(o&&!r)return s(n,a);var l=$(this),d=l.attr("id"),c=$.capitalize(d),u=d.replace(/([^s])$/,"$1s"),h=function(){return"function"==typeof n&&a===!0?n(!1):void window.location.reload()};a!==!0&&$.Dialog.wait(!$.Dialog.isOpen()&&c,"Updating list of "+u,!0),$.ajax("/episode/"+u+"/S"+t+"E"+i,{method:"POST",success:$.mkAjaxHandler(function(){if(!this.status)return h();var e=$(this.render).filter("section").children();l.empty().append(e).trigger("rebind-handlers"),l.find(".post-form").attr("data-type",d).formBind(),Time.Update(),"function"==typeof n?n():a!==!0&&$.Dialog.close()}),error:h})}).on("bind-more-handlers","li[id]",c).find("li[id]").each(c),$.fn.formBind=function(){function a(e){var t=c.data("prev-url"),i="string"==typeof t&&t.trim()===c.val().trim();if(s.attr("disabled",e===!0||i),e===!0||i?s.attr("title","You need to change the URL before chacking again."):s.removeAttr("title"),"keyup"===e.type){var n=c.val();m.test(n)&&c.val(c.val().replace(m,""))}}function o(){var e=c.val(),t=v+" process";s.removeClass("red"),a(!0),$.Dialog.wait(t,"Checking image"),$.post("/post",{image_url:e},$.mkAjaxHandler(function(){function i(n,a){$.Dialog.wait(t,"Checking image availability"),p.attr("src",n.preview).show().off("load error").on("load",function(){h.children("p:not(.keep)").remove(),c.data("prev-url",e),n.title&&!u.val().trim()?$.Dialog.confirm("Confirm "+g+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+n.title+"</strong></p><br>Would you like to use this as the "+g+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===g?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+g+" a description before clicking the "+b+" button.</p>",function(e){return e?(u.val(n.title),void $.Dialog.close()):r.find("input[name=label]").focus()}):$.Dialog.close(function(){r.find("input[name=label]").focus()})}).on("error",function(){return a<1?($.Dialog.wait("Can't load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){i(n,a+1)},2e3)):void $.Dialog.fail(t,"There was an error while attempting to load the image. Make sure the URL is correct and try again!")})}var n=this;return n.status?void i(n,0):(h.children("p:not(.keep)").remove(),h.prepend($.mk("p").attr("class","color-red").html(n.message)).show(),p.hide(),$.Dialog.close())}))}var r=$(this),s=r.find(".check-img"),l=r.find(".img-preview"),d=r.find("[name=label]"),c=r.find("[name=image_url]"),u=r.find("[name=label]"),h=l.children(".notice"),f=h.html(),p=l.children("img"),g=r.attr("data-type"),v=$.capitalize(g);0===p.length&&(p=$(new Image).appendTo(l)),$("#"+g+"-btn").on("click",function(){e(),r.is(":visible")||(r.show(),d.focus(),$.scrollTo(r.offset().top-$navbar.outerHeight()-10,500))}),"reservation"===g&&$("#add-reservation-btn").on("click",function(){var e=$.mk("form","add-reservation").html('<div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div>\n\t\t\t\t<div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div>\n\t\t\t\t<label>\n\t\t\t\t\t<span>Deviation URL</span>\n\t\t\t\t\t<input type="text" name="deviation">\n\t\t\t\t</label>');$.Dialog.request("Add a reservation",e,"Finish",function(e){e.on("submit",function(t){t.preventDefault();var i=e.find("[name=deviation]").val();return"string"!=typeof i||0===i.length?$.Dialog.fail(!1,"Please enter a deviation URL"):($.Dialog.wait(!1,"Adding reservation"),void $.post("/post/add-reservation",{deviation:i,epid:n},$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,this.message),void $("#"+g+"s").trigger("pls-update")):$.Dialog.fail(!1,this.message)})))})})}),c.on("keyup change paste",a);var m=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,b='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';s.on("click",function(e){e.preventDefault(),o()}),r.on("submit",function(e,n,a){e.preventDefault();var o=v+" process";if("undefined"==typeof c.data("prev-url"))return $.Dialog.fail(o,"Please click the "+b+" button before submitting your "+g+"!");if(!n&&c.data("prev-url")!==c.val())return $.Dialog.confirm(o,"You modified the image URL without clicking the "+b+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&r.triggerHandler("submit",[!0])});if(!a&&"request"===g){var s=function(){var e=d.val(),t=r.find("select");if(e.indexOf("character")>-1&&"chr"!==t.val())return{v:$.Dialog.confirm(o,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){t.focus()}):r.triggerHandler("submit",[n,!0])})}}();if("object"===("undefined"==typeof s?"undefined":_typeof(s)))return s.v}var l=r.mkData({what:g,episode:i,season:t,image_url:c.data("prev-url")});!function u(){$.Dialog.wait(o,"Submitting "+g),$.post("/post",l,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,["Go ahead","Nevermind"],function(e){e&&(l.allow_nonmember=!0,u())}):$.Dialog.fail(!1,this.message);$.Dialog.success(!1,v+" posted");var e=this.id;$("#"+g+"s").trigger("pls-update",[function(){$.Dialog.close(),$("#"+g+"-"+e).find("em.post-date").children("a").triggerHandler("click")}])}))}()}).on("reset",function(){s.attr("disabled",!1).addClass("red"),h.html(f).show(),p.hide(),c.removeData("prev-url"),$(this).hide()})},$(".post-form").each($.fn.formBind);var u=$content.find("img[src]"),h=u.length,f=0,p=/^#(request|reservation)-\d+$/,g=location.hash.length>1&&p.test(location.hash);h>0&&g&&!function(){var e=void 0;g&&($.Dialog.wait("Scroll post into view","Waiting for page to load"),e=$.mk("progress").attr({max:h,value:0}).css({display:"block",width:"100%",marginTop:"5px"}),$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(e)),$content.imagesLoaded().progress(function(t,i){i.isLoaded?(f++,g&&e.attr("value",f)):i.img.src&&!function(){var t=$(i.img).closest("li[id]");1===t.length&&!function(){var e=t.attr("id").split("-"),i=e[0],n=e[1];$.post("/post/reload-"+i+"/"+n,$.mkAjaxHandler(function(){if(this.status){var e=$(this.li);t.hasClass("highlight")&&e.addClass("highlight"),t.replaceWith(e),e.rebindFluidbox(),Time.Update(),e.trigger("rebind-handlers",[n,i])}}))}(),h--,g&&e.attr("max",h)}()}).always(function(){var e=window._HighlightHash({type:"load"});e===!1&&$.Dialog.info("Scroll post into view","The "+location.hash.replace(p,"$1")+" you were linked to has either been deleted or didn't exist in the first place. Sorry.<div class='align-center'><span class='sideways-smiley-face'>:\\</div>")})}()},function(){$body.removeClass("no-distractions"),$(".fluidbox--opened").fluidbox("close"),"number"==typeof window._rlinterval&&clearInterval(window._rlinterval),$w.off("hashchange",window._HighlightHash),delete window._HighlightHash});
//# sourceMappingURL=/js/min/episode.js.map
