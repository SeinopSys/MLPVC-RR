"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){var e=$("#wss").attr("src").replace(/^(.*?:\d+\/).*$/,"$1"),t=function(e){return function(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(e){}e(t)}},n=void 0,o=void 0,i=void 0,s=!1,a=void 0;if("function"!=typeof window.io)return console.log("%c[WS] Server down!","color:red"),$.WS={down:!0},void $sidebar.find(".notif-list").on("click",".mark-read",function(e){e.preventDefault(),$.Dialog.fail("Mark notification read",'The notification server appears to be down. Please <a class="send-feedback">let us know</a>, and sorry for the inconvenience.')});var c=function(){function c(){_classCallCheck(this,c),this.down=!1,this.substatus={postUpdates:!1,entryUpdates:!1}}return _createClass(c,[{key:"connect",value:function(){var c=this;this.conn||(this.conn=io(e,{reconnectionDelay:1e4}),this.conn.on("connect",function(){console.log("[WS] %cConnected","color:green"),c.navigate()}),this.conn.on("auth",t(function(e){a=e.clientid,s=!0,console.log("[WS] %cAuthenticated as "+e.name,"color:teal")})),this.conn.on("auth-guest",t(function(e){a=e.clientid,console.log("[WS] %cReceiving events as a guest","color:teal")})),this.conn.on("notif-cnt",t(function(e){var t=e.cnt?parseInt(e.cnt,10):0;console.log("[WS] Unread notification count: %d",t),c.essentialElements(),0===t?o.stop().slideUp("fast",function(){i.empty(),n.empty()}):$.post("/notifications/get",$.mkAjaxHandler(function(e){n.text(t),i.html(e.list),Time.Update(),c.bindMarkRead(),o.stop().slideDown()}))})),this.conn.on("post-delete",t(function(e){if(e.type&&e.id){var t=e.type+"-"+e.id,n=$("#"+t+":not(.deleting)");console.log("[WS] Post deleted (postid=%s)",t),n.length&&(n.find(".fluidbox--opened").fluidbox("close"),n.find(".fluidbox--initialized").fluidbox("destroy"),n.attr({class:"deleted",title:"This post has been deleted; click here to hide"}).on("click",function(e){var t=$(e.target);t[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){t.remove()})}))}})),this.conn.on("post-break",t(function(e){if(e.type&&e.id){var t=e.type+"-"+e.id,n=$("#"+t+":not(.admin-break)");console.log("[WS] Post broken (postid=%s)",t),n.length&&(n.find(".fluidbox--opened").fluidbox("close"),n.find(".fluidbox--initialized").fluidbox("destroy"),n.reloadLi())}})),this.conn.on("post-add",t(function(e){e.type&&e.id&&window.EPISODE===e.episode&&window.SEASON===e.season&&($(".posts #"+e.type+"-"+e.id).length>0||$.post("/post/reload/"+e.type+"/"+e.id,$.mkAjaxHandler(function(t){if(t.status&&!($(".posts #"+e.type+"-"+e.id).length>0)){var n=$(t.li);$(t.section).append(n),n.rebindFluidbox(),Time.Update(),n.rebindHandlers(!0).parent().reorderPosts(),console.log("[WS] Post added (postid="+e.type+"-#"+e.id+") to container "+c.section)}})))})),this.conn.on("post-update",t(function(e){if(e.type&&e.id){var t=e.type+"-"+e.id,n=$("#"+t+":not(.deleting)");console.log("[WS] Post updated (postid=%s)",t),n.length&&n.reloadLi(!1)}})),this.conn.on("entry-score",t(function(e){if(void 0!==e.entryid){var t=$("#entry-"+e.entryid);console.log("[WS] Entry score updated (entryid=%s, score=%s)",e.entryid,e.score),t.length&&t.refreshVoting()}})),this.conn.on("devaction",t(function(e){if(console.log("[WS] DevAction",e),"string"==typeof e.remoteAction)switch(e.remoteAction){case"reload":window.location.reload();break;case"message":$.Dialog.info("Message from the developer",e.data.html)}})),this.conn.on("hello",t(function(e){console.log("[WS] %cHello response (priv=%s)","color:green",e.priv),$w.trigger("ws-hello",[e])})),this.conn.on("disconnect",function(){s=!1,console.log("[WS] %cDisconnected","color:red")}))}},{key:"navigate",value:function(){if(void 0!==this.conn){var e=location.pathname+location.search+location.hash;this.conn.emit("navigate",{page:e})}}},{key:"recvPostUpdates",value:function(e){var n=this;if(void 0===this.conn)return setTimeout(function(){n.recvPostUpdates(e)},2e3);"boolean"==typeof e&&this.substatus.postUpdates!==e&&this.conn.emit("post-updates",String(e),t(function(t){if(!t.status)return console.log("[WS] %cpost-updates subscription status change failed (subscribe=%s)","color:red",e);n.substatus.postUpdates=e,$("#episode-live-update")[n.substatus.postUpdates?"removeClass":"addClass"]("hidden"),console.log("[WS] %c%s","color:green",t.message)}))}},{key:"recvEntryUpdates",value:function(e){var n=this;if(void 0===this.conn)return setTimeout(function(){n.recvEntryUpdates(e)},2e3);"boolean"==typeof e&&this.substatus.entryUpdates!==e&&this.conn.emit("entry-updates",String(e),t(function(t){if(!t.status)return console.log("[WS] %centry-updates subscription status change failed (subscribe=%s)","color:red",e);n.substatus.entryUpdates=e,$("#entry-live-update")[n.substatus.entryUpdates&&"contest"===window.EventType?"removeClass":"addClass"]("hidden"),console.log("[WS] %c%s","color:green",t.message)}))}},{key:"authme",value:function(){var e=this;void 0!==this.conn&&!0!==s&&(console.log("[WS] %cReconnection needed for identity change","color:teal"),this.conn.disconnect(0),setTimeout(function(){e.conn.connect()},100))}},{key:"unauth",value:function(){void 0!==this.conn&&!0===s&&this.conn.emit("unauth",null,t(function(e){if(!e.status)return console.log("[WS] %cUnauth failed","color:red");s=!1,console.log("[WS] %cAuthentication dropped","color:brown")}))}},{key:"disconnect",value:function(e){void 0!==this.conn&&(console.log("[WS] Forced disconnect (reason="+e+")"),this.conn.disconnect(0))}},{key:"status",value:function(){var e=this;if(void 0===this.conn)return setTimeout(function(){e.status()},2e3);this.conn.emit("status",null,t(function(e){if(!e.status)return console.log("[WS] Status: %c"+e.message,"color:red");console.log("[WS] Status: ID=%s; Name=%s; Rooms=%s",e.User.id,e.User.name,e.rooms.join(","))}))}},{key:"devquery",value:function(e){var n=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(void 0===this.conn)return setTimeout(function(){n.devquery(e,o,i)},2e3);this.conn.emit("devquery",{what:e,data:o},t(function(e){if("function"==typeof i)return i(e);console.log("[WS] DevQuery "+(e.status?"Success":"Fail"),e)}))}},{key:"devaction",value:function(e,n){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(void 0===this.conn)return setTimeout(function(){o.devaction(e,n,i)},2e3);this.conn.emit("devaction",{clientId:e,remoteAction:n,data:i},t(function(e){console.log("[WS] DevAction "+(e.status?"Success":"Fail"),e)}))}},{key:"essentialElements",value:function(){0===(n=$sbToggle.children(".notif-cnt")).length&&(n=$.mk("span").attr({class:"notif-cnt",title:"New notifications"}).prependTo($sbToggle)),o=$sidebar.children(".notifications"),i=o.children(".notif-list"),this.bindMarkRead()}},{key:"bindMarkRead",value:function(){i.off("click",".mark-read").on("click",".mark-read",function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target).closest(".mark-read");if(!t.hasClass("disabled")){var n=t.attr("data-id"),o={read_action:t.attr("data-value")},i=t.attr("data-action")||"Mark notification as read",s=function(){t.siblings(".mark-read").addBack().addClass("disabled"),$.post("/notifications/mark-read/"+n,o,$.mkAjaxHandler(function(e){return e.status?e.message?$.Dialog.success(i,e.message,!0):void $.Dialog.close():$.Dialog.fail(i,e.message)})).always(function(){t.siblings(".mark-read").addBack().removeClass("disabled")})};o.read_action&&t.hasAttr("data-confirm")?$.Dialog.confirm("Actionable notification",'Please confirm your choice: <strong class="color-'+t.attr("class").replace(/^.*variant-(\w+)\b.*$/,"$1")+'">'+t.attr("title")+"</strong>",["Confirm","Cancel"],function(e){e&&($.Dialog.wait(i),s())}):s()}})}},{key:"getClientId",value:function(){return a}}]),c}();$.WS=new c,$.WS.essentialElements(),$.WS.connect()}();
//# sourceMappingURL=/js/min/websocket.js.map
