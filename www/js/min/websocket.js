"use strict";var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(){var t="https://ws."+location.hostname+":8667/",e=function(t){return function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}t(e)}},n=void 0,o=void 0,i=void 0,s=!1;$.ajax({url:t+"socket.io/socket.io.js",cache:"true",dataType:"script",success:function(){$.WS.essentialElements(),$.WS.connect()},statusCode:{404:function(){console.log("%c[WS] Server down!","color:red"),$.WS.down=!0,$sidebar.find(".notif-list").on("click",".mark-read",function(t){t.preventDefault(),$.Dialog.fail("Mark notification read",'The notification server appears to be down. Please <a class="send-feedback">let us know</a>, and sorry for the inconvenience.')})}}});var a=function(){function a(){_classCallCheck(this,a),this.down=!1,this.substatus={postUpdates:!1,entryUpdates:!1}}return _createClass(a,[{key:"connect",value:function(){var a=this;this.conn||(this.conn=io(t,{reconnectionDelay:1e4}),this.conn.on("connect",function(){console.log("[WS] %cConnected","color:green"),a.recvPostUpdates(void 0!==window.EpisodePage),a.navigate()}),this.conn.on("auth",e(function(t){s=!0,console.log("[WS] %cAuthenticated as "+t.name,"color:teal")})),this.conn.on("auth-guest",e(function(){console.log("[WS] %cReceiving events as a guest","color:teal")})),this.conn.on("notif-cnt",e(function(t){var e=t.cnt?parseInt(t.cnt,10):0;console.log("[WS] Unread notification count: %d",e),a.essentialElements(),0===e?o.stop().slideUp("fast",function(){i.empty(),n.empty()}):$.post("/notifications/get",$.mkAjaxHandler(function(t){n.text(e),i.html(t.list),Time.Update(),a.bindMarkRead(),o.stop().slideDown()}))})),this.conn.on("post-delete",e(function(t){if(t.type&&t.id){var e=t.type+"-"+t.id,n=$("#"+e+":not(.deleting)");console.log("[WS] Post deleted (postid=%s)",e),n.length&&(n.find(".fluidbox--opened").fluidbox("close"),n.find(".fluidbox--initialized").fluidbox("destroy"),n.attr({class:"deleted",title:"This post has been deleted; click here to hide"}).on("click",function(t){var e=$(t.target);e[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){e.remove()})}))}})),this.conn.on("post-break",e(function(t){if(t.type&&t.id){var e=t.type+"-"+t.id,n=$("#"+e+":not(.admin-break)");console.log("[WS] Post broken (postid=%s)",e),n.length&&(n.find(".fluidbox--opened").fluidbox("close"),n.find(".fluidbox--initialized").fluidbox("destroy"),n.reloadLi())}})),this.conn.on("post-add",e(function(t){t.type&&t.id&&window.EPISODE===t.episode&&window.SEASON===t.season&&($(".posts #"+t.type+"-"+t.id).length>0||$.post("/post/reload/"+t.type+"/"+t.id,$.mkAjaxHandler(function(e){if(e.status&&!($(".posts #"+t.type+"-"+t.id).length>0)){var n=$(e.li);$(e.section).append(n),n.rebindFluidbox(),Time.Update(),n.rebindHandlers(!0).parent().reorderPosts(),console.log("[WS] Post added (postid="+t.type+"-#"+t.id+") to container "+a.section)}})))})),this.conn.on("post-update",e(function(t){if(t.type&&t.id){var e=t.type+"-"+t.id,n=$("#"+e+":not(.deleting)");console.log("[WS] Post updated (postid=%s)",e),n.length&&n.reloadLi(!1)}})),this.conn.on("entry-score",e(function(t){if(void 0!==t.entryid){var e=$("#entry-"+t.entryid);console.log("[WS] Entry score updated (entryid=%s, score=%s)",t.entryid,t.score),e.length&&e.refreshVoting()}})),this.conn.on("devaction",e(function(t){if(console.log("[WS] DevAction",t),"string"==typeof t.remoteAction)switch(t.remoteAction){case"reload":window.location.reload();break;case"message":$.Dialog.info("Message from the developer",t.data.html)}})),this.conn.on("disconnect",function(){s=!1,console.log("[WS] %cDisconnected","color:red")}))}},{key:"navigate",value:function(){if(void 0!==this.conn){var t=location.pathname+location.search+location.hash;this.conn.emit("navigate",{page:t})}}},{key:"recvPostUpdates",value:function(t){var n=this;if(void 0===this.conn)return setTimeout(function(){n.recvPostUpdates(t)},2e3);"boolean"==typeof t&&this.substatus.postUpdates!==t&&this.conn.emit("post-updates",String(t),e(function(e){if(!e.status)return console.log("[WS] %cpost-updates subscription status change failed (subscribe=%s)","color:red",t);n.substatus.postUpdates=t,$("#episode-live-update")[n.substatus.postUpdates?"removeClass":"addClass"]("hidden"),console.log("[WS] %c%s","color:green",e.message)}))}},{key:"recvEntryUpdates",value:function(t){var n=this;if(void 0===this.conn)return setTimeout(function(){n.recvEntryUpdates(t)},2e3);"boolean"==typeof t&&this.substatus.entryUpdates!==t&&this.conn.emit("entry-updates",String(t),e(function(e){if(!e.status)return console.log("[WS] %centry-updates subscription status change failed (subscribe=%s)","color:red",t);n.substatus.entryUpdates=t,$("#entry-live-update")[n.substatus.entryUpdates&&"contest"===window.EventType?"removeClass":"addClass"]("hidden"),console.log("[WS] %c%s","color:green",e.message)}))}},{key:"authme",value:function(){var t=this;void 0!==this.conn&&!0!==s&&(console.log("[WS] %cReconnection needed for identity change","color:teal"),this.conn.disconnect(0),setTimeout(function(){t.conn.connect()},100))}},{key:"unauth",value:function(){void 0!==this.conn&&!0===s&&this.conn.emit("unauth",null,e(function(t){if(!t.status)return console.log("[WS] %cUnauth failed","color:red");s=!1,console.log("[WS] %cAuthentication dropped","color:brown")}))}},{key:"disconnect",value:function(t){void 0!==this.conn&&(console.log("[WS] Forced disconnect (reason="+t+")"),this.conn.disconnect(0))}},{key:"status",value:function(){var t=this;if(void 0===this.conn)return setTimeout(function(){t.status()},2e3);this.conn.emit("status",null,e(function(t){if(!t.status)return console.log("[WS] Status: %c"+t.message,"color:red");console.log("[WS] Status: ID=%s; Name=%s; Rooms=%s",t.User.id,t.User.name,t.rooms.join(","))}))}},{key:"devquery",value:function(t){var n=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(void 0===this.conn)return setTimeout(function(){n.devquery(t,o,i)},2e3);this.conn.emit("devquery",{what:t,data:o},e(function(t){if("function"==typeof i)return i(t);console.log("[WS] DevQuery "+(t.status?"Success":"Fail"),t)}))}},{key:"devaction",value:function(t,n){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(void 0===this.conn)return setTimeout(function(){o.devaction(t,n,i)},2e3);this.conn.emit("devaction",{clientId:t,remoteAction:n,data:i},e(function(t){console.log("[WS] DevAction "+(t.status?"Success":"Fail"),t)}))}},{key:"essentialElements",value:function(){0===(n=$sbToggle.children(".notif-cnt")).length&&(n=$.mk("span").attr({class:"notif-cnt",title:"New notifications"}).prependTo($sbToggle)),o=$sidebar.children(".notifications"),i=o.children(".notif-list"),this.bindMarkRead()}},{key:"bindMarkRead",value:function(){i.off("click",".mark-read").on("click",".mark-read",function(t){t.preventDefault(),t.stopPropagation();var e=$(t.target).closest(".mark-read");if(!e.hasClass("disabled")){var n=e.attr("data-id"),o={read_action:e.attr("data-value")},i=e.attr("data-action")||"Mark notification as read",s=function(){e.siblings(".mark-read").addBack().addClass("disabled"),$.post("/notifications/mark-read/"+n,o,$.mkAjaxHandler(function(t){return t.status?t.message?$.Dialog.success(i,t.message,!0):void $.Dialog.close():$.Dialog.fail(i,t.message)})).always(function(){e.siblings(".mark-read").addBack().removeClass("disabled")})};o.read_action&&e.hasAttr("data-confirm")?$.Dialog.confirm("Actionable notification",'Please confirm your choice: <strong class="color-'+e.attr("class").replace(/^.*variant-(\w+)\b.*$/,"$1")+'">'+e.attr("title")+"</strong>",["Confirm","Cancel"],function(t){t&&($.Dialog.wait(i),s())}):s()}})}}]),a}();$.WS=new a}();
//# sourceMappingURL=/js/min/websocket.js.map
