"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();!function(e,t){var i={menubar:t,statusbar:t,tabbar:t,picker:t,settings:t},a=function(){return{low:0,high:255}},n={hand:0,picker:1,zoom:2},s={min:.004,max:32,step:1.1},o=function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)},r=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},l=function(){return r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r()},c="string"==typeof navigator.userAgent&&/(macos|iphone|os ?x|ip[ao]d)/i.test(navigator.userAgent),h=function(){function e(i,a,n,s){var o=arguments.length>4&&arguments[4]!==t&&arguments[4];_classCallCheck(this,e),this.red=i,this.green=a,this.blue=n,this.alpha=!1!==o?o:s}return _createClass(e,[{key:"invert",value:function(){return this.red=255-this.red,this.green=255-this.green,this.blue=255-this.blue,this}}]),e}(),u=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getPixels",value:function(e){for(var i=arguments.length>1&&arguments[1]!==t?arguments[1]:t,a=[],n="function"==typeof i,s=0;s<e.data.length;s+=4){if(n){var o=s/4;if(!1===i(o%e.width,Math.floor(o/e.width)))continue}a.push(new(Function.prototype.bind.apply(h,[null].concat(_toConsumableArray(e.data.slice(s,s+4))))))}return a}}]),e}(),g=function(){function i(e){_classCallCheck(this,i),this.id=l(),this.boundingRect=e,this._tab=t}return _createClass(i,[{key:"belongsToTab",value:function(e){this._tab=e}},{key:"_getImageData",value:function(){if(!(this._tab instanceof z))throw new Error("Attempting to get image data without being bound to a tab");var e=this._tab.getCanvasCtx(),t=Math.max(0,this.boundingRect.topLeft.x),i=Math.max(0,this.boundingRect.topLeft.y),a=Math.min(this.boundingRect.sideLength,e.canvas.width-t),n=Math.min(this.boundingRect.sideLength,e.canvas.height-i);return e.getImageData(t,i,a,n)}},{key:"_getPixels",value:function(){var e=arguments.length>0&&arguments[0]!==t?arguments[0]:t;return u.getPixels(this._getImageData(),e)}}],[{key:"averageColor",value:function(t){var i=t.length,a=0,n=0,s=0,o=0;return e.each(t,function(e,t){a+=t.red,n+=t.green,s+=t.blue,o+=t.alpha}),new h(Math.round(a/i),Math.round(n/i),Math.round(s/i),Math.round(o/i))}},{key:"draw",value:function(t,i){t instanceof d?i.fillRect(t.boundingRect.topLeft.x,t.boundingRect.topLeft.y,t.boundingRect.sideLength,t.boundingRect.sideLength):t instanceof v&&e.each(t.slices,function(e,a){var n=t.boundingRect.topLeft.x+a.skip,s=t.boundingRect.topLeft.y+e;i.fillRect(n,s,a.length,1)})}},{key:"getArea",value:function(e,t,i){var a=p.calcRectanglePoints(e.left,e.top,t);if(i)return new d(a);var n=p.calcCircleSlices(t);return new v(a,n)}}]),i}(),d=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"resize",value:function(e){this.boundingRect=p.calcRectanglePoints(this.boundingRect.center.x,this.boundingRect.center.y,e)}},{key:"getAverageColor",value:function(){return g.averageColor(this._getPixels())}},{key:"toRound",value:function(){var e=p.calcCircleSlices(this.boundingRect.sideLength);return new v(this.boundingRect,e)}},{key:"toSquare",value:function(){return!1}}]),t}(g),v=function(e){function t(e,i){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.slices=i,a}return _inherits(t,e),_createClass(t,[{key:"resize",value:function(e){this.boundingRect=p.calcRectanglePoints(this.boundingRect.center.x,this.boundingRect.center.y,e),this.slices=p.calcCircleSlices(e)}},{key:"getAverageColor",value:function(){var e=this;return g.averageColor(this._getPixels(function(t,i){return e.slices[i].skip<t&&t<e.slices[i].skip+e.slices[i].length}))}},{key:"toRound",value:function(){return!1}},{key:"toSquare",value:function(){return new d(this.boundingRect)}}]),t}(g),p=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"calcRectanglePoints",value:function(e,t,i){var a=Math.floor(i/2);return{sideLength:i,topLeft:{x:e-a,y:t-a},center:{x:e,y:t}}}},{key:"distance",value:function(e,i){var a=arguments.length>2&&arguments[2]!==t?arguments[2]:0,n=arguments.length>3&&arguments[3]!==t?arguments[3]:0;return Math.sqrt(Math.pow(n-i,2)+Math.pow(a-e,2))}},{key:"calcCircleSlices",value:function(t){var a=t/2,n=new Array(t);e.each(n,function(e){n[e]=new Array(t)});for(var s=0;s<n.length;s++)for(var o=0;o<n[s].length;o++)n[s][o]=i.distance(s,o,a-.5,a-.5)<=a?1:0;return e.each(n,function(e,t){var i=t.join("").replace(/(^|0)1/g,"$1|1").replace(/1(0|$)/g,"1|$1").split("|");n[e]={skip:i[0].length,length:i[1].length}}),n}}]),i}(),f={pickingAreaSize:25,pickerWidth:"85%",sidebarColorFormat:"hex"},m="picker_settings",k=function(){function t(){var i=this;_classCallCheck(this,t),this._settings=e.extend(!0,{},f);var a={};try{a=JSON.parse(e.LocalStorage.get(m))}catch(e){}a&&e.each(f,function(e){void 0!==a[e]&&a[e]!==i._settings[e]&&(i._settings[e]=a[e])}),this.save()}return _createClass(t,[{key:"get",value:function(e){if(void 0===f[e])throw new Error("Trying to get non-existant setting: "+e);return this._settings[e]}},{key:"set",value:function(e,t){if(void 0===f[e])throw new Error("Trying to set non-existant setting: "+e);this._settings[e]=t,this.save()}},{key:"save",value:function(){e.LocalStorage.set(m,JSON.stringify(this._settings))}}],[{key:"getInstance",value:function(){return void 0===i.settings&&(i.settings=new t),i.settings}},{key:"clear",value:function(){e.LocalStorage.remove(m)}}]),t}(),_=function(){function i(t){_classCallCheck(this,i);var a=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([01]|(?:0?\.\d+)))?\)$/i,n=/^#([a-f0-9]{3}|[a-f0-9]{6})$/i;if("string"==typeof t){var s=(t=t.trim()).match(a);if(s&&s[1]<=255&&s[2]<=255&&s[3]<=255&&(!s[4]||s[4]<=1))this.red=parseInt(s[1],10),this.green=parseInt(s[2],10),this.blue=parseInt(s[3],10),this.alpha=s[4]?parseFloat(s[4]):1;else{var o=t.match(n);if(!o)throw new Error("Unrecognized color format: "+t);var r=o[1];3===r.length&&(r=r[0]+r[0]+r[1]+r[1]+r[2]+r[2]);var l=e.hex2rgb("#"+r);this.red=l.r,this.green=l.g,this.blue=l.b,this.alpha=1}}else{if(isNaN(t.red)||isNaN(t.green)||isNaN(t.blue))throw new Error("Unrecognized color format: "+JSON.stringify(t));this.red=t.red,this.green=t.green,this.blue=t.blue,this.alpha=t instanceof h?t.alpha/255:isNaN(t.alpha)?1:t.alpha}this.opacity=Math.round(100*this.alpha)}return _createClass(i,[{key:"toString",value:function(){var e=arguments.length>0&&arguments[0]!==t&&arguments[0];return 1===this.alpha||e?this.toHexString():this.toRGBString()}},{key:"toHexString",value:function(){return e.rgb2hex({r:this.red,g:this.green,b:this.blue})}},{key:"toRGBString",value:function(){var e=!(arguments.length>0&&arguments[0]!==t&&arguments[0])&&1!==this.alpha;return"rgb"+(e?"a":"")+"("+this.red+","+this.green+","+this.blue+(e?","+this.alpha:"")+")"}}]),i}(),y=function(){function t(){var i=this;_classCallCheck(this,t),this._$menubar=e("#menubar"),this._$menubar.children().children("a.dropdown").on("click",function(t){t.preventDefault(),t.stopPropagation(),i._$menubar.addClass("open"),e(t.target).trigger("mouseenter")}).on("mouseenter",function(t){if(i._$menubar.hasClass("open")){var a=e(t.target);a.hasClass("dropdown")&&(i._$menubar.find("a.active").removeClass("active").next().addClass("hidden"),a.addClass("active").next().removeClass("hidden"))}}),this._$filein=e.mk("input","screenshotin").attr({type:"file",accept:"image/png,image/jpeg",tabindex:-1,class:"fileinput"}).prop("multiple",!0).appendTo($body),this._$openImage=e("#open-image").on("click",function(e){e.preventDefault(),i.requestFileOpen()}),this._$filein.on("change",function(){var t=i._$filein[0].files;if(0!==t.length){var a=1!==t.length?"s":"";e.Dialog.wait("Opening file"+a,"Reading opened file"+a+", please wait");var n=0;!function a(){if(void 0===t[n])return i._$openImage.removeClass("disabled"),i._$filein.val(""),void e.Dialog.close();i.handleFileOpen(t[n],function(t){if(t)return n++,a();i._$openImage.removeClass("disabled"),e.Dialog.fail("Drag and drop","Failed to read file #"+n+", aborting")})}()}}),this._$clearSettings=e("#clear-settings").on("click",function(t){t.preventDefault(),e.Dialog.confirm("Clear settings",'<p>The editor remembers your picking area size, sidebar color format and sidebar width settings.</p><p>If you want to reset these to their defaults, click the "Clear settings" button below.</p><p><strong>This will reload the picker, and any progress will be lost.</strong></p>',["Clear settings","Nevermind"],function(t){t&&(e.Dialog.wait(!1,"Clearing settings"),k.clear(),window.location.reload())})});var a=e("#about-dialog-template").children();this._$aboutDialog=e("#about-dialog").on("click",function(){e.Dialog.info("About",a.clone())}),$body.on("click",function(){i._$menubar.removeClass("open"),i._$menubar.find("a.active").removeClass("active"),i._$menubar.children("li").children("ul").addClass("hidden")})}return _createClass(t,[{key:"requestFileOpen",value:function(){this._$filein.trigger("click")}},{key:"handleFileOpen",value:function(t,i){if(!/^image\/(png|jpeg)$/.test(t.type))return e.Dialog.fail("Invalid file","You may only use PNG or JPG images with this tool"),void i(!1);var a=new FileReader;a.onload=function(){P.getInstance().openImage(a.result,t.name,i)},a.readAsDataURL(t)}}],[{key:"getInstance",value:function(){return void 0===i.menubar&&(i.menubar=new t),i.menubar}}]),t}(),b=function(){function a(){var t=this;_classCallCheck(this,a),this._$el=e("#statusbar"),this._$info=this._$el.children(".info"),this._$pos=this._$el.children(".pos"),this._$colorat=this._$el.children(".colorat"),this._$color=this._$colorat.children(".color"),this._$opacity=this._$colorat.children(".opacity"),this.infoLocked=!1,this.Pos={mouse:"mousepos"},this["_$"+this.Pos.mouse]=this._$pos.children(".mouse"),e.each(this.Pos,function(e){t.setPosition(e)})}return _createClass(a,[{key:"lockInfo",value:function(){this.infoLocked=!0}},{key:"unlockInfo",value:function(){this.infoLocked=!1}},{key:"setInfo",value:function(){var e=arguments.length>0&&arguments[0]!==t?arguments[0]:"";this.infoLocked||(c&&e.replace(/Shift/g,"Option").replace(/Ctrl/g,"Command"),this._$info.text(e))}},{key:"setPosition",value:function(i){var a=arguments.length>1&&arguments[1]!==t?arguments[1]:{top:NaN,left:NaN},n=arguments.length>2&&arguments[2]!==t?arguments[2]:1,s=this.Pos[i];if("string"!=typeof s)throw new Error("[Statusbar.setPosition] Invalid position display key: "+i);1!==n&&(a.left*=n,a.top*=n),this["_$"+s].text(isNaN(a.left)||isNaN(a.top)?"":e.roundTo(a.left,2)+","+e.roundTo(a.top,2))}},{key:"setColorAt",value:function(){var i=arguments.length>0&&arguments[0]!==t?arguments[0]:"",a=arguments.length>1&&arguments[1]!==t?arguments[1]:"";i.length?this._$color.css({backgroundColor:i,color:e.yiq(i)>127?"black":"white"}):this._$color.css({backgroundColor:"",color:""}),this._$color.text(i||""),this._$opacity.text(a||"")}}],[{key:"getInstance",value:function(){return void 0===i.statusbar&&(i.statusbar=new a),i.statusbar}}]),a}(),C=function(t,i){t.find(".color-preview").html(e.mk("div").css("background-color","rgba("+i.red+","+i.green+","+i.blue+","+i.opacity/100+")"))},w=function(t){var i=e(t.target).closest("form"),a=i.mkData();C(i,a)},$=e.mk("form","set-area-color").append('<div class="label">\n\t\t\t\t<span>Red, Green, Blue (0-255)</span>\n\t\t\t\t<div class="input-group-3">\n\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="red"   class="change input-red">\n\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="green" class="change input-green">\n\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="blue"  class="change input-blue">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="label">\n\t\t\t\t<span>Opacity (%)</span>\n\t\t\t\t<input type="number" min="0" max="100" step="1" name="opacity" class="change">\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<div class="color-preview"></div>\n\t\t\t</div>').on("change keyup input",".change",w).on("set-color",function(t,i){var a=e(this);e.each(["red","green","blue","opacity"],function(e,t){a.find('input[name="'+t+'"]').val(i[t])}),C(a,i)}),z=function(){function i(a,n){var s=this;_classCallCheck(this,i),this._fileHash=n,this._canvas=mk("canvas"),this._imgdata={},this._pickingAreas={},this._zoomlevel=t,this._levels={low:0,high:255},this._pickingSize=t,this.file={extension:t,name:t},this.setName(a),this._$pickAreaColorDisplay=e.mk("span").attr({class:"pickcolor","data-info":"Change the color of the picking areas on this tab"}),this._$el=e.mk("li").attr("class","tab").append(this._$pickAreaColorDisplay,e.mk("span").attr({class:"filename","data-info":this.file.name+"."+this.file.extension}).text(this.file.name),e.mk("span").attr("class","fileext").text(this.file.extension),e.mk("span").attr({class:"close","data-info":"Close tab"}).text("×")),this._$el.on("click",function(t){switch(t.preventDefault(),t.target.className){case"close":return e.Dialog.confirm("Close tab","Please confirm that you want to close this tab.",["Close","Cancel"],function(t){t&&(s.close(),e.Dialog.close())});case"pickcolor":return e.Dialog.request("Select a picking area color",$.clone(!0,!0),"Set",function(t){t.triggerHandler("set-color",[s.loadPickingAreaColor()]),t.on("submit",function(i){i.preventDefault();var a=t.mkData();e.Dialog.wait(!1,"Setting picking area color");try{s.savePickingAreaColor("rgba("+a.red+","+a.green+","+a.blue+","+Math.round(a.opacity)/100+")")}catch(t){return e.Dialog.fail(!1,i.message)}e.Dialog.close()})})}I.getInstance().activateTab(s)})}return _createClass(i,[{key:"activate",value:function(){this._$el.addClass("active")}},{key:"deactivate",value:function(){this._$el.removeClass("active")}},{key:"isActive",value:function(){return this._$el.hasClass("active")}},{key:"getFileHash",value:function(){return this._fileHash}},{key:"setImage",value:function(t,i){var a=this,n=new Image;e(n).attr("src",t).on("load",function(){if(a._imgdata.size={width:n.width,height:n.height},a._canvas.width=a._imgdata.size.width,a._canvas.height=a._imgdata.size.height,a._canvas.getContext("2d").drawImage(n,0,0),void 0===a._pickingAreaColor){var e=mk("canvas");e.width=1,e.height=1;var t=e.getContext("2d");t.drawImage(n,0,0,1,1);var s=(new(Function.prototype.bind.apply(h,[null].concat(_toConsumableArray(t.getImageData(0,0,1,1).data),[127])))).invert();a.savePickingAreaColor(new _(s))}i(!0)}).on("error",function(){i(!1)})}},{key:"setName",value:function(e){var t=e.split(/\./g);this.file.extension=t.pop(),this.file.name=t.join(".")}},{key:"getName",value:function(){return this.file.name+"."+this.file.extension}},{key:"getImageSize",value:function(){return this._imgdata.size}},{key:"loadImagePosition",value:function(){return this._imgdata.position}},{key:"saveImagePosition",value:function(e){this._imgdata.position=e}},{key:"loadZoomLevel",value:function(){return this._zoomlevel}},{key:"saveZoomLevel",value:function(e){this._zoomlevel=e}},{key:"loadLevels",value:function(){return this._levels}},{key:"saveLevels",value:function(e){this._levels=e}},{key:"loadPickingSize",value:function(){return this._pickingSize}},{key:"savePickingSize",value:function(e){this._pickingSize=e}},{key:"getElement",value:function(){return this._$el}},{key:"getCanvasCtx",value:function(){return this._canvas.getContext("2d")}},{key:"placeArea",value:function(e,i){var a=!(arguments.length>2&&arguments[2]!==t)||arguments[2];this.addPickingArea(g.getArea(e,i,a))}},{key:"addPickingArea",value:function(e){e.belongsToTab(this),this._pickingAreas[e.id]=e}},{key:"loadPickingAreas",value:function(){return this._pickingAreas}},{key:"clearPickingAreas",value:function(){var e=arguments.length>0&&arguments[0]!==t&&arguments[0];this._pickingAreas={},this.isActive()&&(e||P.getInstance().redrawPickingAreas())}},{key:"removePickingArea",value:function(e){var i=arguments.length>1&&arguments[1]!==t&&arguments[1];if(void 0===this._pickingAreas[e])throw new Error("Trying to remove non-existing area, guid: "+e);delete this._pickingAreas[e],this.isActive()&&(i||P.getInstance().redrawPickingAreas())}},{key:"replacePickingArea",value:function(e,t){t.id=e,t.belongsToTab(this),this._pickingAreas[e]=t}},{key:"loadPickingAreaColor",value:function(){return this._pickingAreaColor||"rgba(255,0,255,.5)"}},{key:"savePickingAreaColor",value:function(t){this._pickingAreaColor=new _(t),this._$pickAreaColorDisplay.html(e.mk("span").css("background-color",this._pickingAreaColor.toString())),this.isActive()&&P.getInstance().redrawPickingAreas()}},{key:"drawImage",value:function(){P.getInstance().getImageCanvasCtx().drawImage(this._canvas,0,0,this._imgdata.size.width,this._imgdata.size.height,0,0,this._imgdata.size.width,this._imgdata.size.height)}},{key:"close",value:function(){I.getInstance().closeTab(this)}}]),i}(),I=function(){function a(){_classCallCheck(this,a),this._$tabbar=e("#tabbar"),this._activeTab=!1,this._tabStorage=[]}return _createClass(a,[{key:"newTab",value:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var a=new(Function.prototype.bind.apply(z,[null].concat(t)));return this._tabStorage.push(a),this.updateTabs(),a}},{key:"activateTab",value:function(t){var i=this;t instanceof z&&(t=this.indexOf(t)),this._tabStorage[t]instanceof z?this._activeTab=t:this._activeTab=!1,e.each(this._tabStorage,function(e,t){e===i._activeTab?t.activate():t.deactivate()}),!1!==this._activeTab&&P.getInstance().openTab(this._tabStorage[this._activeTab])}},{key:"indexOf",value:function(t){var i=parseInt(t.getElement().attr("data-ix"),10);if(isNaN(i)&&e.each(this._tabStorage,function(e,a){if(a===t)return i=e,!1}),isNaN(i))throw console.log(t),new Error("Could not find index of the tab logged above");return i}},{key:"updateTabs",value:function(){var t=this;this._$tabbar.children().detach(),e.each(this._tabStorage,function(e,i){t._$tabbar.append(i.getElement().attr("data-ix",e))})}},{key:"getActiveTab",value:function(){return!1!==this._activeTab?this._tabStorage[this._activeTab]:t}},{key:"getTabs",value:function(){return this._tabStorage}},{key:"hasTabs",value:function(){return this._tabStorage.length>0}},{key:"closeTab",value:function(e){var t=this.indexOf(e),i=this._tabStorage.length,a=i>1;a||P.getInstance().clearImage(),this._tabStorage.splice(t,1),a&&this.activateTab(Math.min(i-2,t)),this.updateTabs(),P.getInstance().updatePickingState()}},{key:"closeActiveTabConfirm",value:function(){this._activeTab instanceof z&&this._activeTab.getElement().find(".close").trigger("click")}}],[{key:"getInstance",value:function(){return void 0===i.tabbar&&(i.tabbar=new a),i.tabbar}}]),a}(),S=e.mk("form","levels-changer").append('<div class="label">\n\t\t\t<span>Range</span>\n\t\t\t<div class="slider-holder">\n\t\t\t\t<div class="slider"></div>\n\t\t\t\t<div class="inputs">\n\t\t\t\t\t<div class="low">\n\t\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="low">\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="high">\n\t\t\t\t\t\t<input type="number" min="0" max="255" step="1" name="high">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="notice info">These settings do not affect the returned average color values in any way.</div>\n\t\t<fieldset>\n\t\t\t<legend>Preview</legend>\n\t\t\t<div id="levels-preview"><canvas></canvas></div>\n\t\t</fieldset>',e.mk("button").attr("class","darkblue").text("Reset to defaults").on("click",function(t){t.preventDefault();var i=e(this).closest("form");i.find('input[name="low"]').val(0),i.find('input[name="high"]').val(255),i.trigger("submit")})).on("update-disp",function(){var t=e(this),i=t.find("#levels-preview"),n=t.find('input[name="low"]'),s=parseInt(n.val(),10),o=t.find('input[name="high"]'),r=parseInt(o.val(),10),l=i.data("hdrcontext");void 0===l&&(l=i.children()[0].getContext("hdr2d"),i.data("hdrcontext",l));var c={low:s,high:r};l.range={r:c,g:c,b:c,a:a()},l.invalidate()}),P=function(){function r(){var i=this;_classCallCheck(this,r),this._mouseImagePos={top:NaN,left:NaN},this._zoomlevel=1,this._levels=a(),this._moveMode=!1,this._$picker=e("#picker"),this.updatePickerSize(),this._$imageOverlay=e.mk("canvas").attr("class","image-overlay"),this._$imageCanvas=e.mk("canvas").attr("class","image-element"),this._$mouseOverlay=e.mk("canvas").attr("class","mouse-overlay"),this._$handTool=e.mk("button").attr({class:"fa fa-hand-paper-o","data-info":"Hand Tool (H) - Move around without having to hold Space"}).on("click",function(e){e.preventDefault(),i.switchTool("hand")}),this._$pickerTool=e.mk("button").attr({class:"fa fa-eyedropper","data-info":"Eyedropper Tool (I) - Click to place picking areas on the image (Hold Alt for rounded area)"}).on("click",function(e){e.preventDefault(),i.switchTool("picker")}),this._$zoomTool=e.mk("button").attr({class:"fa fa-search","data-info":"Zoom Tool (Z) - Left click to zoom in, right click to zoom out"}).on("click",function(e){e.preventDefault(),i.switchTool("zoom")}),this.switchTool("hand"),this._$levelsChanger=e.mk("button").attr({class:"fa fa-sliders","data-info":"Adjust levels…"}).on("click",function(t){t.preventDefault();var a=I.getInstance().getActiveTab();if(a){var n=a.getImageSize();e.Dialog.request("Adjust levels",S.clone(!0,!0),"Set",function(t){var a=t.find(".slider")[0],s=noUiSlider.create(a,{start:[i._levels.low||0,i._levels.high||255],margin:1,limit:255,connect:!0,direction:"ltr",orientation:"horizontal",behaviour:"tap-drag",step:1,tooltips:!1,range:{min:0,max:255},format:{to:function(e){return parseInt(e,10)},from:function(e){return e}}}),o=t.find(".slider-holder input"),r=!1;s.on("update",function(e,i){r||(o.eq(i).val(e[i]),t.triggerHandler("update-disp"))}),o.on("change input",function(){r=!0,s.set([o.eq(0).val(),o.eq(1).val()]),r=!1,t.triggerHandler("update-disp")});var l=s.get();o.eq(0).val(l[0]),o.eq(1).val(l[1]),t.triggerHandler("update-disp");var c=t.find("#levels-preview"),h=c.children()[0],u=e.scaleResize(n.width,n.height,{height:150},!1);h.width=u.width,h.height=u.height,c.data("hdrcontext").drawImage(i._$imageCanvas[0],0,0,n.width,n.height,0,0,u.width,u.height),t.on("submit",function(a){a.preventDefault();var n=t.mkData(),s={low:n.low,high:n.high};e.Dialog.wait(!1,"CHanging levels"),i.setLevels(s),e.Dialog.close()})})}}),this._$zoomin=e.mk("button").attr({class:"zoom-in fa fa-search-plus","data-info":"Zoom in (Alt+Scroll Up)"}).on("click",function(e,t){e.preventDefault(),i.setZoomLevel(i._zoomlevel*s.step,t),t&&i.updateMousePosition(t),i.drawPickerCursor(!e.altKey)}),this._$zoomout=e.mk("button").attr({class:"zoom-out fa fa-search-minus","data-info":"Zoom out (Alt+Scroll Down)"}).on("click",function(e,t){e.preventDefault(),i.setZoomLevel(i._zoomlevel/s.step,t),t&&i.updateMousePosition(t),i.drawPickerCursor(!e.altKey)}),this._$zoomfit=e.mk("button").attr({class:"zoom-fit fa fa-window-maximize","data-info":"Fit in view (Ctrl+0)"}).on("click",function(e){e.preventDefault(),i.setZoomFit()}),this._$zoomorig=e.mk("button").attr({class:"zoom-orig fa fa-search","data-info":"Original size (Ctrl+1)"}).on("click",function(e){e.preventDefault(),i.setZoomOriginal()}),this._$zoomperc=e.mk("span").attr({class:"zoom-perc","data-info":"Current zoom level (Click to enter a custom value between 0.4% and 3200%)",contenteditable:!0,spellcheck:"false",autocomplete:"off"}).text("100%").on("keydown",function(t){if(e.isKey(Key.Enter,t)){t.preventDefault();var a=parseFloat(i._$zoomperc.text());isNaN(a)||i.setZoomLevel(a/100),e.clearFocus(),i.updateZoomLevelInputs()}}).on("mousedown",function(){i._$zoomperc.data("mousedown",!0)}).on("mouseup",function(){i._$zoomperc.data("mousedown",!1)}).on("click",function(){!0!==i._$zoomperc.data("focused")&&(i._$zoomperc.data("focused",!0),i._$zoomperc.select())}).on("dblclick",function(e){e.preventDefault(),i._$zoomperc.select()}).on("blur",function(){i._$zoomperc.data("mousedown")||i._$zoomperc.data("focused",!1),0===i._$zoomperc.html().trim().length&&i.updateZoomLevelInputs(),e.clearSelection()}),this._$actionTopLeft=e.mk("div").attr("class","actions actions-tl").append(e.mk("div").attr("class","picking-tools").append("<span class='label'>Picking</span>",this._$handTool,this._$pickerTool,this._$zoomTool,this._$levelsChanger),e.mk("div").attr("class","zoom-controls").append("<span class='label'>Zooming</span>",this._$zoomin,this._$zoomout,this._$zoomfit,this._$zoomorig,this._$zoomperc)).on("mousedown",function(e){e.stopPropagation(),i._$zoomperc.triggerHandler("blur")}),this._$pickingSize=e.mk("span").attr({class:"picking-size","data-info":"Size of newly placed picking areas (Click to enter a custom value between 1px and 400px)",contenteditable:!0,spellcheck:"false",autocomplete:"off"}).on("keydown",function(a){if(e.isKey(Key.Enter,a)){a.preventDefault();var n=parseInt(i._$pickingSize.text().trim());i.setPickingSize(isNaN(n)?t:n),e.clearFocus()}}).on("mousedown",function(){i._$pickingSize.data("mousedown",!0)}).on("mouseup",function(){i._$pickingSize.data("mousedown",!1)}).on("click",function(){!0!==i._$pickingSize.data("focused")&&(i._$pickingSize.data("focused",!0),i._$pickingSize.select())}).on("dblclick",function(e){e.preventDefault(),i._$pickingSize.select()}).on("blur",function(){i._$pickingSize.data("mousedown")||i._$pickingSize.data("focused",!1),0===i._$pickingSize.text().trim().length&&i.setPickingSize(),e.clearSelection()}),this._pickingSizeDecreaseInterval=t,this._pickingSizeIncreaseInterval=t,this._$decreasePickingSize=e.mk("button").attr({class:"fa fa-minus-circle","data-info":"Decrease picking area size (Down Arrow)"}).on("mousedown",function(e){e.preventDefault(),void 0!==i._pickingSizeIncreaseInterval&&(clearInterval(i._pickingSizeIncreaseInterval),i._pickingSizeIncreaseInterval=t);var a=!e.altKey;i.decreasePickingSize(a,!1),i._pickingSizeDecreaseInterval=setInterval(function(){i.decreasePickingSize(a,!1)},150)}).on("mouseup mouseleave",function(){void 0!==i._pickingSizeDecreaseInterval&&(clearInterval(i._pickingSizeDecreaseInterval),i._pickingSizeDecreaseInterval=t)}),this._$increasePickingSize=e.mk("button").attr({class:"fa fa-plus-circle","data-info":"Increase picking area size (Up Arrow)"}).on("mousedown",function(e){e.preventDefault(),void 0!==i._pickingSizeDecreaseInterval&&(clearInterval(i._pickingSizeDecreaseInterval),i._pickingSizeDecreaseInterval=t);var a=!e.altKey;i.increasePickingSize(a,!1),i._pickingSizeIncreaseInterval=setInterval(function(){i.increasePickingSize(a,!1)},150)}).on("mouseup mouseleave",function(){void 0!==i._pickingSizeIncreaseInterval&&(clearInterval(i._pickingSizeIncreaseInterval),i._pickingSizeIncreaseInterval=t)}),this.setPickingSize(k.getInstance().get("pickingAreaSize"),!1),this._$areaCounter=e.mk("span"),this._$areaImageCounter=e.mk("span"),this._$averageColor=e.mk("span").attr("class","average text"),this._$copyColorBtn=e.mk("button").attr({class:"fa fa-clipboard","data-info":"Copy average color to clipboard"}).on("click",function(t){var a=i._$averageColor.children().eq(0).text();e.copy(a,t)}),this._$actionsBottomLeft=e.mk("div").attr("class","actions actions-bl").append(e.mk("div").append('<span class="label">Picking tool settings</span>',e.mk("div").attr("class","picking-controls text").append(this._$decreasePickingSize,this._$pickingSize,this._$increasePickingSize)),e.mk("div").append('<span class="label">Picking status</span>',e.mk("span").attr("class","counters text").append(this._$areaCounter," & ",this._$areaImageCounter),this._$averageColor)).on("mousedown",function(e){e.stopPropagation(),i._$zoomperc.triggerHandler("blur")}),this._$areasList=e.mk("ul");var o=!1;this._$listResizeHandle=e.mk("div").attr("class","resize-handle").on("mousedown",function(){o=!0,$body.addClass("area-list-resizing")}),this._$areasDeleteSelected=e.mk("button").attr({class:"fa fa-trash","data-info":"Delete selected areas (Del)"}).on("click",function(e){e.preventDefault(),i.deleteSelectedAreas()}),this._$displayFormatSwitch=e.mk("button").attr("class","fa"),this._$selectAllAreas=e.mk("button").attr({class:"fa fa-check-circle","data-info":"Selects all areas (Ctrl+A). Shift+Click to deselect (Ctrl+Shift+A)."}).on("click",function(e){e.preventDefault(),i.selectAllAreas(e.shiftKey)}),this.setSidebarDisplayFormat(k.getInstance().get("sidebarColorFormat"),!1),this._$areasListButtons=e.mk("div").attr("class","action-buttons").append(this._$areasDeleteSelected,this._$displayFormatSwitch,this._$selectAllAreas),this._$areasSidebar=e("#areas-sidebar").append(this._$listResizeHandle,this._$areasListButtons,this._$areasList).on("mousewheel",function(e){e.stopPropagation()}).on("click",".select-handle",function(t){t.preventDefault();var a=e(t.target).closest("li");if(t.ctrlKey&&!t.altKey){if(a.closest("ul").parent().hasClass("selected"))return;a.toggleClass("selected").find(".selected").removeClass("selected")}else if(!t.shiftKey||t.altKey||t.ctrlKey)i._$areasSidebar.find("li.selected").removeClass("selected"),a.addClass("selected");else{var n=i._$areasSidebar.find(".lastclicked"),s=n.length;if(s>0){var o=void 0,r=void 0,l=void 0;if(a.children("ul").length>0?n.children("ul").length>0?(o=n.index(),r=a.index(),l=a.parent().children()):a.addClass("selected"):(o=n.index(),r=a.index(),l=a.parent().find(".entry"),a.parent().is(n.parent())||(o=Math.min(r,a.siblings().first().index()))),i._$areasSidebar.find("li.selected").removeClass("selected"),void 0!==o){if(o>r){var c=o;o=r,r=c}for(var h=o;h<=r||h<s;h++)l.eq(h).addClass("selected")}}}i._$areasSidebar.find("li.lastclicked").removeClass("lastclicked"),a.addClass("lastclicked")}).on("dblclick",".entry",function(t){t.preventDefault();var a=e(t.target).closest("li");if(!(a.children("ul").length>0)){var n=a.parents("li").index(),s=a.attr("id").replace(/^picking-area-/,""),o=I.getInstance().getTabs()[n],r=o.loadPickingAreas()[s],l=r instanceof v,c=e.mk("form","area-update-form").append('<div class="label">\n\t\t\t\t\t\t<span>Area type</span>\n\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t<label><input type="radio" name="type" value="round" '+(l?"checked":"")+'><span>Rounded</span></label>\n\t\t\t\t\t\t\t<label><input type="radio" name="type" value="square" '+(l?"":"checked")+"><span>Square</span></label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>",e.mk("label").append("<span>Area size (1-400px)</span>",e.mk("input").attr({type:"number",min:1,max:400,step:1,name:"size"}).val(r.boundingRect.sideLength)));e.Dialog.request("Edit picking area",c,"Update",function(){c.on("submit",function(t){t.preventDefault();var a=c.mkData();e.Dialog.wait(!1,"Updating area");var n=e.rangeLimit(parseInt(a.size,10),!1,1,400);n!==r.boundingRect.sideLength&&r.resize(n);var l=r["to"+e.capitalize(a.type)]();!1!==l&&o.replacePickingArea(s,l),i.updatePickingState(),o.isActive()&&i.redrawPickingAreas(),e.Dialog.close()})})}}),this.setPickerWidth(k.getInstance().get("pickerWidth")),this.updatePickingState(),this._$loader=e.mk("div").attr("class","loader"),$w.on("resize",e.throttle(250,function(){i.resizeHandler()})),this._$picker.append(this._$actionTopLeft,this._$actionsBottomLeft,this._$mouseOverlay,this._$imageOverlay,this._$loader);var l=void 0,c=void 0;$body.on("mousemove",e.throttle(50,function(t){if(o){var a=Math.max(t.pageX-2,0)/$body.width();i.setPickerWidth(e.roundTo(100*a,2))}else if(I.getInstance().getActiveTab()&&!e.Dialog.isOpen()&&(i.updateMousePosition(t),l&&c)){var n={top:t.pageY,left:t.pageX},s=i.getPickerPosition(),r=l.top+(n.top-c.top)-s.top,h=l.left+(n.left-c.left)-s.left;i.move({top:r,left:h}),i.updateZoomLevelInputs()}})),this._$mouseOverlay.on("mousemove",function(e){i.updateMousePosition(e),i.drawPickerCursor(!e.altKey)}).on("mousedown",function(t){I.getInstance().getActiveTab()&&!e.Dialog.isOpen()&&(t.preventDefault(),i._activeTool===n.picker&&i.placeArea(i._mouseImagePos,i._pickingAreaSize,!t.altKey))}).on("click",function(e){i._activeTool===n.zoom&&1===e.which&&(e.preventDefault(),i._$zoomin.trigger("click",[e]))}).on("contextmenu",function(e){i._activeTool===n.zoom&&(e.preventDefault(),i._$zoomout.trigger("click",[e]))}).on("mouseleave",function(){i.clearMouseOverlay()}),$w.on("mousewheel",function(e){e.altKey&&(e.preventDefault(),e.originalEvent.deltaY>0?i._$zoomout.trigger("click",[e]):i._$zoomin.trigger("click",[e]))}),this._$picker.on("mousewheel",function(e){if(!e.altKey){e.preventDefault();var t=i._pickerHeight*(e.shiftKey?.1:.025)*Math.sign(e.originalEvent.wheelDelta);e.ctrlKey?i.move({left:"+="+t+"px"}):i.move({top:"+="+t+"px"}),i.updateMousePosition(e)}}),$body.on("mousedown",function(t){I.getInstance().getActiveTab()&&e(t.target).is(i._$imageOverlay)&&i._$imageOverlay.hasClass("draggable")&&(t.preventDefault(),i._$imageOverlay.addClass("dragging"),l=i.getImagePosition(),c={top:t.pageY,left:t.pageX})}),$body.on("mouseup mouseleave blur",function(e){o&&"mouseup"===e.type&&(o=!1,i.storeSidebarWidth(),$body.removeClass("area-list-resizing")),I.getInstance().getActiveTab()&&"mouseup"===e.type&&(l=t,c=t,i._$imageOverlay.removeClass("dragging"))})}return _createClass(r,[{key:"getZoomedTopLeft",value:function(e,i){var a=arguments.length>2&&arguments[2]!==t?arguments[2]:this.getPickerCenterPosition(),n=e.left,s=e.top,o=a.left,r=a.top;return{top:r+i*(s-r),left:o+i*(n-o)}}},{key:"getImageCanvasSize",value:function(){return{width:this._$imageCanvas.width(),height:this._$imageCanvas.height()}}},{key:"getImagePosition",value:function(){var e=arguments.length>0&&arguments[0]!==t?arguments[0]:this._$imageCanvas.offset(),i=this.getPickerPosition();return e.left-=i.left,e.right-=i.right,e}},{key:"getPickerCenterPosition",value:function(){return{top:this._pickerHeight/2,left:this._pickerWidth/2}}},{key:"getPickerPosition",value:function(){var e=this._$picker.offset();return e.top-=(this._pickerHeight-this._$picker.outerHeight())/2,e.left-=(this._pickerWidth-this._$picker.outerWidth())/2,e}},{key:"setPickingSize",value:function(){var i=arguments.length>0&&arguments[0]!==t?arguments[0]:t,a=!(arguments.length>1&&arguments[1]!==t)||arguments[1];isNaN(i)||(this._pickingAreaSize=e.rangeLimit(i,!1,1,400)),this._$pickingSize.text(this._pickingAreaSize+"px"),this._$decreasePickingSize.attr("disabled",1===this._pickingAreaSize),this._$increasePickingSize.attr("disabled",400===this._pickingAreaSize),a&&k.getInstance().set("pickingAreaSize",this._pickingAreaSize);var n=I.getInstance().getActiveTab();n&&n.savePickingSize(this._pickingAreaSize)}},{key:"decreasePickingSize",value:function(e){var i=!(arguments.length>1&&arguments[1]!==t)||arguments[1];this.setPickingSize(this._pickingAreaSize-5),i&&this.drawPickerCursor(e)}},{key:"increasePickingSize",value:function(e){var i=!(arguments.length>1&&arguments[1]!==t)||arguments[1];this.setPickingSize(1===this._pickingAreaSize?5:this._pickingAreaSize+5),i&&this.drawPickerCursor(e)}},{key:"drawPickerCursor",value:function(t){var i=I.getInstance().getActiveTab();if(i&&!e.Dialog.isOpen()&&this._activeTool===n.picker){var a=g.getArea(this._mouseImagePos,this._pickingAreaSize,t);this.clearMouseOverlay();var s=this.getMouseOverlayCtx();s.fillStyle=i.loadPickingAreaColor().toString(),g.draw(a,s)}}},{key:"placeArea",value:function(e,i){var a=!(arguments.length>2&&arguments[2]!==t)||arguments[2],n=I.getInstance().getActiveTab();n&&(n.placeArea(e,i,a),this.redrawPickingAreas())}},{key:"redrawPickingAreas",value:function(){var t=I.getInstance().getActiveTab();if(t){this.clearImageOverlay();var i=this.getImageOverlayCtx();i.fillStyle=t.loadPickingAreaColor().toString(),e.each(t.loadPickingAreas(),function(e,t){g.draw(t,i)}),this.updatePickingState()}}},{key:"updatePickingState",value:function(){var t=this,i=0,a=0,n=[];if(this._$areasList.empty(),e.each(I.getInstance().getTabs(),function(s,o){var r=o.loadPickingAreas(),l=Object.keys(r),c=e.mk("ul"),h=e.mk("li").append(e.mk("span").attr("class","entry").append(e.mk("span").attr("class","name").text(o.getName()),e.mk("span").attr({class:"select-handle","data-info":"Picking area tab selection handle (Click to select, Ctrl/Shift+Click to select multiple)"})),c);if(t._$areasList.append(h),l.length){a++,i+=l.length;var u=0;e.each(r,function(i,a){var s=a.getAverageColor(),o="hex"===t._sidebarDisplayFormat,r=new _(s).toHexString(),l=void 0,h=void 0;if(o)l=new _(s).toString(),h=r+(255!==s.alpha?" @ "+e.roundTo(s.alpha/255*100,2)+"%":"");else if(l=new _(s).toRGBString(),4===(h=l.replace(/^rgba?\((.+)\)$/,"$1").split(",")).length){var g=e.roundTo(100*parseFloat(h.pop()),2);h=h.join(", ")+" @ "+g+"%"}else h=h.join(", ");c.append(e.mk("li","picking-area-"+a.id).attr({class:"entry","data-info":"Picking area (Double click to change shape and size)"}).append(e.mk("span").attr("class","index").text(++u),e.mk("span").attr("class","color").css({backgroundColor:l,color:e.yiq(r)>127?"black":"white"}).html(h),e.mk("span").attr("class","size "+(a instanceof v?"rounded":"square")).html(e.mk("span").text(a.boundingRect.sideLength)),e.mk("span").attr({class:"select-handle","data-info":"Picking area selection handle (Click to select, Ctrl/Shift+Click to select multiple)"}))),n.push(s)})}}),this._$areaCounter.text(i+" area"+(1!==i?"s":"")),this._$areaImageCounter.text(a+" image"+(1!==a?"s":"")),this._$averageColor.empty(),n.length){var s=new _(g.averageColor(n)),o=s.toString(!0);this._$averageColor.append(e.mk("span").attr("class","color").css({backgroundColor:s.toString(),color:e.yiq(o)>127?"black":"white"}).text(o),this._$copyColorBtn.clone(!0,!0))}}},{key:"selectAllAreas",value:function(){var e=arguments.length>0&&arguments[0]!==t&&arguments[0];this._$areasList.children()[e?"removeClass":"addClass"]("selected")}},{key:"deleteSelectedAreas",value:function(){var t=this._$areasList.find(".selected");if(t.length){var i={},a=I.getInstance().getTabs();t.each(function(t,n){var s=e(n);if(s.children("ul").length>0){var o=s.index();a[o].clearPickingAreas(!0)}else{var r=s.parents("li").index();void 0===i[r]&&(i[r]=[]),i[r].push(s.attr("id").replace(/^picking-area-/,""))}}),e.each(i,function(t,i){e.each(i,function(e,i){a[t].removePickingArea(i,!0)})}),r.getInstance().redrawPickingAreas()}}},{key:"setSidebarDisplayFormat",value:function(i){var a=this,n=!(arguments.length>1&&arguments[1]!==t)||arguments[1];if(!/^(hex|rgb)$/.test(i))throw new Error("Invalid sidebar displa format: "+i);var s="hex"===i;this._$displayFormatSwitch.attr({class:"fa fa-"+(s?"tint":"hashtag"),"data-info":"Switch to displaying colors in the sidebar in "+(s?"RGB":"HEX")+" format"}).off("click").on("click",function(t){t.preventDefault(),a.setSidebarDisplayFormat(s?"rgb":"hex");var i=e(t.target);i.is(":hover")&&b.getInstance().setInfo(i.attr("data-info"))}),this._sidebarDisplayFormat=i,this.updatePickingState(),n&&k.getInstance().set("sidebarColorFormat",i)}},{key:"clearImageOverlay",value:function(){o(this.getImageOverlayCtx())}},{key:"clearMouseOverlay",value:function(){o(this.getMouseOverlayCtx())}},{key:"updateZoomLevelInputs",value:function(){this._$zoomperc.text(e.roundTo(100*this._zoomlevel,2)+"%"),document.activeElement.blur(),this._$zoomout.attr("disabled",this._zoomlevel<=s.min),this._$zoomin.attr("disabled",this._zoomlevel>=s.max)}},{key:"updateMousePosition",value:function(t){var i=this.getImagePosition();this._mouseImagePos.top=Math.floor((t.pageY-i.top)/this._zoomlevel),this._mouseImagePos.left=Math.floor((t.pageX-i.left)/this._zoomlevel),b.getInstance().setPosition("mouse",this._mouseImagePos);var a=I.getInstance().getActiveTab();if(a instanceof z){var n=a.getImageSize();if(this._mouseImagePos.top<0||this._mouseImagePos.top>n.height-1||this._mouseImagePos.left<0||this._mouseImagePos.left>n.width-1)b.getInstance().setColorAt();else{var s=this.getImageCanvasCtx().getImageData(this._mouseImagePos.left,this._mouseImagePos.top,1,1).data;b.getInstance().setColorAt(e.rgb2hex({r:s[0],g:s[1],b:s[2]}),e.roundTo(s[3]/255*100,2)+"%")}}}},{key:"setLevels",value:function(){var e=arguments.length>0&&arguments[0]!==t?arguments[0]:a(),i=I.getInstance().getActiveTab();if(i){var n=this.getImageCanvasCtx();n.range.r=e,n.range.g=e,n.range.b=e,n.invalidate(),this._levels=e,i.saveLevels(e)}}},{key:"setZoomLevel",value:function(i,a){var n=I.getInstance().getActiveTab();if(n){var o=n.getImageSize(),r=e.rangeLimit(i,!1,s.min,s.max),l=void 0,c=void 0;if(this._zoomlevel!==r){l=e.scaleResize(o.width,o.height,{scale:r}),c=this._zoomlevel,this._zoomlevel=l.scale;var h=this.getPickerPosition(),u=this.getZoomedTopLeft(this.getImagePosition(),r/c,a?{top:a.pageY,left:a.pageX}:t);this.move({top:u.top-h.top,left:u.left-h.left,width:l.width,height:l.height})}n.saveZoomLevel(this._zoomlevel),this.updateZoomLevelInputs()}}},{key:"setZoomFit",value:function(){var t=this;this._fitImageHandler(function(i){var a=t._pickerWidth>t._pickerHeight,n=i.width===i.height?a:i.width>i.height,s=e.scaleResize(i.width,i.height,n?{height:t._pickerHeight}:{width:t._pickerWidth});return a&&(s.width>t._pickerWidth?s=e.scaleResize(i.width,i.height,{width:t._pickerWidth}):s.height>t._pickerHeight&&(s=e.scaleResize(i.width,i.height,{height:t._pickerHeight}))),a||(s.height>t._pickerHeight?s=e.scaleResize(i.width,i.height,{height:t._pickerHeight}):s.width>t._pickerWidth&&(s=e.scaleResize(i.width,i.height,{width:t._pickerWidth}))),s})}},{key:"setZoomOriginal",value:function(){this._fitImageHandler(function(e,t){return{width:e.width,height:e.height,scale:1}})}},{key:"_fitImageHandler",value:function(e){var t=I.getInstance().getActiveTab();if(t){var i=e(t.getImageSize()),a=(this._pickerHeight-i.height)/2,n=(this._pickerWidth-i.width)/2;this.move({top:a,left:n,width:i.width,height:i.height}),this._zoomlevel=i.scale,this.setZoomLevel(this._zoomlevel)}}},{key:"setPickerWidth",value:function(t){var i=e.rangeLimit(parseFloat(t),!1,50,85);this._$picker.width(i+"%"),this._$areasSidebar.outerWidth(100-i+"%"),this.resizeHandler()}},{key:"storeSidebarWidth",value:function(){k.getInstance().set("pickerWidth",e.roundTo(this._$picker.width()/$w.width()*100,2)+"%")}},{key:"move",value:function(e){var i=arguments.length>1&&arguments[1]!==t&&arguments[1],a=I.getInstance().getActiveTab();a&&(this._$imageOverlay.add(this._$imageCanvas).add(this._$mouseOverlay).css(e),i||a.saveImagePosition({top:this._$imageOverlay.css("top"),left:this._$imageOverlay.css("left"),width:this._$imageOverlay.css("width"),height:this._$imageOverlay.css("height")},a))}},{key:"updatePickerSize",value:function(){this._pickerWidth=this._$picker.innerWidth(),this._pickerHeight=this._$picker.innerHeight()}},{key:"resizeHandler",value:function(){this.updatePickerSize(),"number"==typeof this._zoomlevel&&this.setZoomLevel(this._zoomlevel)}},{key:"_setCanvasSize",value:function(e,t){this._$mouseOverlay[0].width=this._$imageOverlay[0].width=this._$imageCanvas[0].width=e,this._$mouseOverlay[0].height=this._$imageOverlay[0].height=this._$imageCanvas[0].height=t}},{key:"openImage",value:function(t,i,a){var n=this;if(this._$picker.hasClass("loading"))throw new Error("The picker is already loading another image");this._$picker.addClass("loading"),b.getInstance().setInfo();var s=CryptoJS.MD5(t).toString(),o=I.getInstance().getTabs(),r=void 0;if(e.each(o,function(e,t){if(t.getFileHash()===s)return r=t,!1}),void 0!==r)return this._$picker.removeClass("loading"),I.getInstance().activateTab(r),void a(!0);var l=I.getInstance().newTab(i,s);l.setImage(t,function(t){n._$picker.removeClass("loading"),t?I.getInstance().activateTab(l):e.Dialog.fail("Oh no","The provided image could not be loaded. This is usually caused by attempting to open a file that is, in fact, not an image."),a(t)})}},{key:"openTab",value:function(e){var t=e.getImageSize();if(!t)throw new Error("Attempt to open a tab without an image");this._$imageCanvas.appendTo(this._$picker),this._setCanvasSize(t.width,t.height),e.drawImage();var i=e.loadImagePosition();if(i){this.move(i,!0);var a=e.loadZoomLevel();void 0!==a&&(this._zoomlevel=a,this.setZoomLevel(a))}else this.setZoomFit();this.setLevels(e.loadLevels()||this._levels),this.setPickingSize(e.loadPickingSize()),this.updatePickerSize(),this.redrawPickingAreas()}},{key:"clearImage",value:function(){I.getInstance().getActiveTab()&&(this._$imageCanvas.detach(),this._$mouseOverlay.removeClass("picking zooming"),o(this.getImageCanvasCtx()),o(this.getImageOverlayCtx()),b.getInstance().setColorAt(),b.getInstance().setPosition("mouse"),this._zoomlevel=1,this.updateZoomLevelInputs(),e.Dialog.close())}},{key:"moveMode",value:function(e){var i=arguments.length>1&&arguments[1]!==t&&arguments[1],a=this._activeTool===n.hand;!e||this._moveMode||!i&&a?e||!this._moveMode||!i&&a||(this._moveMode=!1,this._$imageOverlay.removeClass("draggable dragging")):(this._moveMode=!0,this._$imageOverlay.addClass("draggable"))}},{key:"getImageCanvasCtx",value:function(){return this.__imageCanvasCtx||(this.__imageCanvasCtx=this._$imageCanvas[0].getContext("hdr2d"))}},{key:"getImageOverlayCtx",value:function(){return this._$imageOverlay[0].getContext("2d")}},{key:"getMouseOverlayCtx",value:function(){return this._$mouseOverlay[0].getContext("2d")}},{key:"switchTool",value:function(e){if(this._activeTool!==e){switch(this._activeTool){case n.hand:this.moveMode(!1,!0);break;case n.picker:this._$mouseOverlay.removeClass("picking"),this.clearMouseOverlay();break;case n.zoom:this._$mouseOverlay.removeClass("zooming")}switch(n[e]){case n.hand:this.moveMode(!0,!0);break;case n.picker:this._$mouseOverlay.addClass("picking");break;case n.zoom:this._$mouseOverlay.addClass("zooming")}"zoom"!==e&&this._$zoomTool.removeClass("selected"),"picker"!==e&&this._$pickerTool.removeClass("selected"),"hand"!==e&&this._$handTool.removeClass("selected"),this["_$"+e+"Tool"].addClass("selected"),this._activeTool=n[e]}}}],[{key:"getInstance",value:function(){return void 0===i.picker&&(i.picker=new r),i.picker}}]),r}();y.getInstance(),b.getInstance(),I.getInstance(),P.getInstance(),$body.on("keydown",function(e){var t=e.target.tagName.toLowerCase();if(("input"!==t||"file"===e.target.type)&&"textarea"!==t&&null===e.target.getAttribute("contenteditable")){switch(e.keyCode){case Key[0]:if(!e.ctrlKey||e.altKey)return;P.getInstance().setZoomFit();break;case Key[1]:if(!e.ctrlKey||e.altKey)return;P.getInstance().setZoomOriginal();break;case Key.Space:if(e.ctrlKey||e.altKey)return;P.getInstance().moveMode(!0);break;case Key.H:P.getInstance().switchTool(n.hand);break;case Key.I:P.getInstance().switchTool(n.picker);break;case Key.O:if(!e.ctrlKey||e.altKey)return;y.getInstance().requestFileOpen();break;case Key.Z:P.getInstance().switchTool(n.zoom);break;case Key.UpArrrow:if(e.ctrlKey||e.altKey)return;P.getInstance().increasePickingSize(!e.altKey);break;case Key.DownArrrow:if(e.ctrlKey||e.altKey)return;P.getInstance().decreasePickingSize(!e.altKey);break;case Key.Delete:if(e.ctrlKey||e.altKey)return;P.getInstance().deleteSelectedAreas();break;case Key.A:if(!e.ctrlKey||e.altKey)return;P.getInstance().selectAllAreas(e.shiftKey);break;default:return}e.preventDefault()}}),$body.on("keyup",function(e){var t=e.target.tagName.toLowerCase();if(("input"!==t||"file"===e.target.type)&&"textarea"!==t&&null===e.target.getAttribute("contenteditable")){switch(e.keyCode){case Key.Space:if(e.ctrlKey||e.altKey)return;P.getInstance().moveMode(!1);break;case Key.Alt:break;default:return}e.preventDefault()}}),$body.on("paste","[contenteditable]",function(t){var i="",a=e(this);if(t.clipboardData?i=t.clipboardData.getData("text/plain"):window.clipboardData?i=window.clipboardData.getData("Text"):t.originalEvent.clipboardData&&(i=e.mk("div").text(t.originalEvent.clipboardData.getData("text"))),document.queryCommandSupported("insertText"))return document.execCommand("insertHTML",!1,e(i).html()),!1;a.find("*").each(function(){e(this).addClass("within")}),setTimeout(function(){a.find("*").each(function(){e(this).not(".within").contents().unwrap()})},1)}),$body.on("mouseenter","[data-info]",function(){b.getInstance().setInfo(e(this).attr("data-info"))}).on("mouseleave","[data-info]",function(){b.getInstance().setInfo()}).on("dragover dragend",function(e){e.stopPropagation(),e.preventDefault()}).on("drop",function(t){t.preventDefault();var i=t.originalEvent.dataTransfer.files;if(0!==i.length){var a=1!==i.length?"s":"";e.Dialog.wait("Drag and drop","Reading dropped file"+a+", please wait");var n=0;!function t(){void 0!==i[n]?y.getInstance().handleFileOpen(i[n],function(i){if(i)return n++,t();e.Dialog.fail("Drag and drop","Failed to read file #"+n+", aborting")}):e.Dialog.close()}()}}),window.Plugin=i}(jQuery);
//# sourceMappingURL=/js/min/colorpicker.js.map
