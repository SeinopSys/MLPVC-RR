"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};$(function(){function t(){var e=void 0,i=$(".episode"),n=i.find(".showplayers").on("scroll-video-into-view",function(){var t=$header.outerHeight();$.scrollTo(e.offset().top-($w.height()-$footer.outerHeight()-t-e.outerHeight())/2-t,500)}),o=n.parent(),s=void 0;if(n.length){var r=i.find(".reportbroken");n.on("click",function(t){if(t.preventDefault(),void 0===e)$.Dialog.wait(n.text()),$.post("/episode/video-embeds/"+a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);2===this.parts&&(s=$.mk("button").attr("class","blue typcn typcn-media-fast-forward").text("Part 2").on("click",function(){$(this).toggleHtml(["Part 1","Part 2"]),e.children().toggleClass("hidden")}),o.append(s)),e=$.mk("div").attr("class","resp-embed-wrap").html(this.html).insertAfter(o),n.removeClass("typcn-eye green").addClass("typcn-eye-outline blue").text("Hide on-site player").triggerHandler("scroll-video-into-view"),$.Dialog.close()}));else{var i=n.hasClass("typcn-eye");e[i?"show":"hide"](),s instanceof jQuery&&s.attr("disabled",!i),n.toggleClass("typcn-eye typcn-eye-outline").toggleHtml(["Show on-site player","Hide on-site player"]),i&&n.triggerHandler("scroll-video-into-view")}}),r.on("click",function(e){e.preventDefault(),$.Dialog.confirm("Report broken video",'<p>Have any of the linked videos been removed from their respective platform?<p><p>Please note that availability checking is automatic, bad video quality or sound issues cannot be detected this way. You should <a class="send-feedback">tell us</a> directly if that is the case.</p>',["Send report","Nevermind"],function(e){e&&($.Dialog.wait(!1,"Sending report"),$.post("/episode/broken-videos/"+a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);void 0!==this.epsection&&(this.epsection.length>0?(i.html(this.epsection),t()):i.remove()),$.Dialog.success(!1,this.message,!0)})))})})}}var e=window.SEASON,i=window.EPISODE,a="S"+e+"E"+i;window._HighlightHash=function(t){$(".highlight").removeClass("highlight");var e=$(location.hash);if(!e.length)return!1;e.addClass("highlight"),setTimeout(function(){$.scrollTo(e.offset().top-$navbar.outerHeight()-10,500,function(){"object"===(void 0===t?"undefined":_typeof(t))&&"load"===t.type&&$.Dialog.close()})},1)},$w.on("hashchange",window._HighlightHash);var n=$("#voting");n.on("click",".rate",function(t){t.preventDefault();var e=function(t){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:t}),$.mk("span")).on("mouseenter mouseleave",function(t){var e=$(this),i=e.parent().find("input:checked").parent(),a=e.closest("div").next().children("strong");switch(t.type){case"mouseleave":if(0===i.length){e.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}e=i;case"mouseenter":e.prevAll().addBack().children("span").attr("class","active"),e.nextAll().children("span").attr("class",""),a.text(e.children("input").attr("value"))}e.siblings().addBack().removeClass("selected"),i.addClass("selected")})},i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(e(1),e(2),e(3),e(4),e(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5")),o=n.children(".rate");$.Dialog.request("Rating "+a,i,"Rate",function(t){t.on("submit",function(e){e.preventDefault();var i=t.mkData();if(void 0===i.vote)return $.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins");$.Dialog.wait(!1,"Submitting your rating"),$.post("/episode/vote/"+a,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=o.closest("section");t.children("h2").nextAll().remove(),t.append(this.newhtml),n.bindDetails(),$.Dialog.close()}))})})}),n.find("time").data("dyntime-beforeupdate",function(t){if(!0===t.past)return n.children(".rate").length?void 0:($.post("/episode/vote/"+a+"?html",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Display voting buttons",this.message);n.children("h2").nextAll().remove(),n.append(this.html),n.bindDetails()})),$(this).removeData("dyntime-beforeupdate"),!1)}),$.fn.bindDetails=function(){$(this).find("a.detail").on("click",function(t){t.preventDefault(),t.stopPropagation(),$.Dialog.wait("Voting details","Getting vote distribution information"),$.post("/episode/vote/"+a+"?detail",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=$.mk("canvas"),e=t.get(0).getContext("2d"),i=$.mk("p").attr("class","tooltip");$.Dialog.info(!1,[$.mk("p").text("Here’s a chart showing how the votes are distributed. Mouse over the different segments to see the exact number of votes."),$.mk("div").attr("id","vote-distrib").append(t,i)]);var a=[void 0,"#FF5454","#FFB554","#FFFF54","#8CD446","#4DC742"],n=this.data,o=0;if(n.datasets[0].backgroundColor=[],n.datasets[0].hoverBackgroundColor=[],n.datasets[0].borderWidth=[],n.datasets[0].hoverBorderColor=[],$.each(n.datasets[0].data,function(t,e){var i=a[parseInt(n.labels[t],10)];n.datasets[0].backgroundColor.push(i);var s=$.RGBAColor.parse(i);s.red=Math.round(Math.min(255,1.06*s.red)),s.green=Math.round(Math.min(255,1.06*s.green)),s.blue=Math.round(Math.min(255,1.06*s.blue)),n.datasets[0].hoverBackgroundColor.push(s.toHex()),n.datasets[0].borderWidth.push(2),n.datasets[0].hoverBorderColor.push("rgba("+s.red+","+s.green+","+s.blue+",0.9)"),o+=parseInt(e,10)}),0===o)return t.remove(),void i.text("There are no votes for this episode yet");new Chart(e,{type:"pie",data:n,options:{titleFontColor:"#000",bodyFontColor:"#000",animation:{easing:"easeInOutExpo"},legend:{display:!1},tooltips:{callbacks:{title:function(t,e){var i=parseInt(e.labels[t[0].index],10);return i+" muffin"+(1!==i?"s":"")},label:function(t,e){var i=parseInt(e.datasets[t.datasetIndex].data[t.index],10),a=Math.round(i/o*1e3)/10;return i+" user"+(1!==i?"s":"")+" ("+a+"%)"}}}}})}))})},n.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find(".screencap > a:not(.fluidbox--initialized)").fluidboxThis()},$._getLiTypeId=function(t){var e=t.attr("id").split("-");return{id:e[1],type:e[0]+"s"}},$.fn.rebindHandlers=function(t){return(t?this:this.find("li[id]")).trigger("bind-more-handlers"),this.closest("section").rebindFluidbox(),this};var o=function(){var t=$(this),e=$._getLiTypeId(t),i=e.type,a=e.id,n=t.find(".actions").children();t.rebindFluidbox(),n.filter(".share").on("click",function(){var t=$(this),e=window.location.href.replace(/([^:/]\/).*$/,"$1")+"s/"+t.parents("li").attr("id").replace(/^(re[qs])[^-]+?-(\d+)$/,"$1/$2");$.Dialog.info("Sharing "+i.replace(/s$/,"")+" #"+a,$.mk("div").attr("class","align-center").append("Use the link below to link to this post directly:",$.mk("div").attr("class","share-link").text(e),$.mk("button").attr("class","blue typcn typcn-clipboard").text("Copy to clipboard").on("click",function(t){$.copy(e,t)})),function(){$("#dialogContent").find(".share-link").select()})})};$("#requests, #reservations").on("pls-update",function(t,e,i){var n=$(this),o=n.attr("id"),s=$.capitalize(o),r=o.replace(/([^s])$/,"$1s");!0!==i&&$.Dialog.wait(!$.Dialog.isOpen()&&s,"Updating list of "+r,!0),$.ajax("/episode/postlist/"+a+"?section="+r,{method:"POST",success:$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=$(this.render).filter("section").children();n.empty().append(t).rebindHandlers(),n.find(".post-form").attr("data-type",o).formBind(),n.find("h2 > button").enable(),Time.Update(),window._HighlightHash(),"function"==typeof e?e():!0!==i&&$.Dialog.close()})})}).on("bind-more-handlers","li[id]",o).find("li[id]").each(o),$.fn.formBind=function(){function t(t){var e=d.data("prev-url"),i="string"==typeof e&&e.trim()===d.val().trim();if(s.attr("disabled",!0===t||i),!0===t||i?s.attr("title","You need to change the URL before chacking again."):s.removeAttr("title"),"keyup"===t.type){var a=d.val();v.test(a)&&d.val(d.val().replace(v,""))}}function n(){var e=d.val(),i=g+" process";s.removeClass("red"),t(!0),$.Dialog.wait(i,"Checking image"),$.post("/post/check-image",{image_url:e},$.mkAjaxHandler(function(){function t(a,n){$.Dialog.wait(i,"Checking image availability"),p.attr("src",a.preview).show().off("load error").on("load",function(){h.children("p:not(.keep)").remove(),d.data("prev-url",e),a.title&&!c.val().trim()?$.Dialog.confirm("Confirm "+f+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+a.title+"</strong></p><br>Would you like to use this as the "+f+"’s description?<br>Keep in mind that it should describe the thing(s) "+("request"===f?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+f+" a description before clicking the "+m+" button.</p>",function(t){if(!t)return o.find("input[name=label]").focus();c.val(a.title),$.Dialog.close()}):$.Dialog.close(function(){o.find("input[name=label]").focus()})}).on("error",function(){if(n<1)return $.Dialog.wait("Can’t load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){t(a,n+1)},2e3);$.Dialog.fail(i,"There was an error while attempting to load the image. Make sure the URL is correct and try again!"),s.enable()})}var a=this;if(!a.status)return h.children("p:not(.keep)").remove(),h.prepend($.mk("p").attr("class","color-red").html(a.message)).show(),p.hide(),s.enable(),$.Dialog.close();t(a,0)}))}var o=$(this);if(o.length){var s=o.find(".check-img"),r=o.find(".img-preview"),l=o.find("[name=label]"),d=o.find("[name=image_url]"),c=o.find("[name=label]"),h=r.children(".notice"),u=h.html(),p=r.children("img"),f=o.attr("data-type").replace(/s$/,""),g=$.capitalize(f);0===p.length&&(p=$(new Image).appendTo(r)),$("#"+f+"-btn").on("click",function(){o.is(":visible")||(o.removeClass("hidden"),l.focus(),$.scrollTo(o.offset().top-$navbar.outerHeight()-10,500))}),"reservation"===f&&$("#add-reservation-btn").on("click",function(){var t=$.mk("form","add-reservation").html('<div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div>\n\t\t\t\t<div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div>\n\t\t\t\t<label>\n\t\t\t\t\t<span>Deviation URL</span>\n\t\t\t\t\t<input type="text" name="deviation">\n\t\t\t\t</label>');$.Dialog.request("Add a reservation",t,"Finish",function(t){t.on("submit",function(e){e.preventDefault();var i=t.find("[name=deviation]").val();if("string"!=typeof i||0===i.length)return $.Dialog.fail(!1,"Please enter a deviation URL");$.Dialog.wait(!1,"Adding reservation"),$.post("/post/add-reservation",{deviation:i,epid:a},$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,this.message),$("#"+f+"s").trigger("pls-update")}))})})}),d.on("keyup change paste",t);var v=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,m='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';s.on("click",function(t){t.preventDefault(),n()}),o.on("submit",function(t,a,n){t.preventDefault();var s=g+" process";if(void 0===d.data("prev-url"))return $.Dialog.fail(s,"Please click the "+m+" button before submitting your "+f+"!");if(!a&&d.data("prev-url")!==d.val())return $.Dialog.confirm(s,"You modified the image URL without clicking the "+m+" button.<br>Do you want to continue with the last checked URL?",function(t){t&&o.triggerHandler("submit",[!0])});if(!n&&"request"===f){var r=l.val(),c=o.find("select");if(r.indexOf("character")>-1&&"chr"!==c.val())return $.Dialog.confirm(s,'Your request label contains the word "character", but the request type isn’t set to Character.<br>Are you sure you\'re not requesting one (or more) character(s)?',["Let me change the type","Carray on"],function(t){if(!t)return o.triggerHandler("submit",[a,!0]);$.Dialog.close(function(){c.focus()})})}var h=o.mkData({what:f,episode:i,season:e,image_url:d.data("prev-url")});!function t(){$.Dialog.wait(s,"Submitting "+f),$.post("/post/add",h,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,["Go ahead","Nevermind"],function(e){e&&(h.allow_nonmember=!0,t())}):$.Dialog.fail(!1,this.message);$.Dialog.success(!1,g+" posted");var e=this.id;$("#"+f+"s").trigger("pls-update",[function(){$.Dialog.close(),$.Dialog.confirm(g+" posted","Would you like to view it or make another?",["View","Make another"],function(t){$.Dialog.close(),t||$("#"+f+"-btn").trigger("click")}),window.location.hash="#"+e}])}))}()}).on("reset",function(){s.attr("disabled",!1).addClass("red"),h.html(u).show(),p.hide(),d.removeData("prev-url"),$(this).hide()})}},$.each(["requests","reservations"],function(t,e){$("#"+e).trigger("bind-more-handlers").find(".post-form").attr("data-type",e).formBind()});var s=new IntersectionObserver(function(t){t.forEach(function(t){if(t.isIntersecting){var e=t.target;s.unobserve(e);var i=e.dataset.post.replace("-","/"),a=e.dataset.viewonly;$.get("/post/lazyload/"+i,{viewonly:a},$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Cannot load "+i.replace("/"," #"),this.message);$.loadImages(this.html).then(function(t){$(e).closest(".image").replaceWith(t.css("opacity",0)),t.animate({opacity:1},300)})}))}})});$(".post-deviation-promise").each(function(t,e){return s.observe(e)});var r=/^#(request|reservation)-\d+$/,l=location.hash.length>1&&r.test(location.hash);l&&($.Dialog.wait("Scroll post into view","Waiting for images to load"),function(){var t=$content.find("img[src]").length,e=0;if(!t)return $.Dialog.close();var i=void 0;l&&(i=$.mk("progress").attr({max:t,value:0}).css({display:"block",width:"100%",marginTop:"5px"}),$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(i)),$content.imagesLoaded().progress(function(a,n){if(n.isLoaded)e++,l&&i.attr("value",e);else if(n.img.src){var o=$(n.img).closest("li[id]");1===o.length&&o.reloadLi(),t--,l&&i.attr("max",t)}}).always(function(){if(!1===window._HighlightHash({type:"load"})&&l){var t="Scroll post into view";$.post("/post/locate/"+location.hash.substring(1).replace("-","/"),$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.info(t,this.message);var e=this.castle,i=$('<p>Looks like the post you were linked to is in another castle. Want to follow the path?</p>\n\t\t\t\t\t\t\t<div id="post-road-sign">\n\t\t\t\t\t\t\t\t<div class="sign-wrap">\n\t\t\t\t\t\t\t\t\t<div class="sign-inner">\n\t\t\t\t\t\t\t\t\t\t<span class="sign-text"></span>\n\t\t\t\t\t\t\t\t\t\t<span class="sign-arrow">➔</span>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="sign-pole"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="notice info">If you\'re seeing this message after clicking a link within the site please <a class="send-feedback">let us know</a>.</div>');i.find(".sign-text").text(e.name),$.Dialog.close(function(){$.Dialog.confirm(t,i,["Take me there","Stay here"],function(t){t&&($.Dialog.wait(!1,"Quicksaving"),$.Navigation.visit(e.url))})})}))}})}());var d={};$.fn.reloadLi=function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=this,a=i.attr("id");if("string"!=typeof a||i.hasClass("admin-break"))return this;if(!0===d[a])return this;d[a]=!0;var n=a.split("-"),o=n[0],s=n[1];return t&&console.log("[POST-FIX] Attemting to reload "+o+" #"+s),$.post("/post/reload/"+o+"/"+s,{cache:t},$.mkAjaxHandler(function(){if(d[a]=!1,this.status){if(!0===this.broken)return i.remove(),void console.log("[POST-FIX] Hid (broken) "+o+" #"+s);var n=$(this.li);((i=$("#"+n.attr("id"))).hasClass("highlight")||n.is(location.hash))&&n.addClass("highlight"),i.replaceWith(n),n.rebindFluidbox(),Time.Update(),n.rebindHandlers(!0),n.parent().is(this.section)||n.appendTo(this.section),n.parent().reorderPosts(),t&&console.log("[POST-FIX] Reloaded "+o+" #"+s),$.callCallback(e)}})),this},$.fn.reorderPosts=function(){var t=this;t.children().sort(function(t,e){var i=$(t),a=$(e),n=new Date(i.find(".post-date time").attr("datetime")).getTime()-new Date(a.find(".post-date time").attr("datetime")).getTime();return 0===n?parseInt(i.attr("id").replace("/D/g",""),10)-parseInt(a.attr("id").replace("/D/g",""),10):n}).appendTo(t)},window.bindVideoButtons=t,t(),$.WS.recvPostUpdates(!0)});
//# sourceMappingURL=/js/min/pages/episode/view.js.map
