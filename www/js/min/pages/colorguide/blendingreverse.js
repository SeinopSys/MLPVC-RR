"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}();$(function(){var e=["red","green","blue"],t={red:0,green:1,blue:2},a=function(e,a){return e+t[a]},i={normal:function(e,t,a){return e*t+(1-e)*a},normalReverse:function(e,t,a){return(a-e*t)/(1-e)},normalFilter:function(e,t,a){return(t-(1-e)*a)/e},multiply:function(e,t,a){return e*(t*a/255)+(1-e)*a},multiplyReverse:function(e,t,a){return(a-e*t)/(1-e)},multiplyFilter:function(e,t,a){return a/=255,t/=255,(e*a-a+t)/(e*a)*255}};new(function(){function t(){var e=this;_classCallCheck(this,t),this.$controls=$("#controls"),this.$knownColorsTbody=$("#known-colors").find("tbody"),this.$backupImage=$.mk("img"),this.backupImage=this.$backupImage.get(0),this.overlayColor=new $.RGBAColor(255,0,255,.75),this.haveImage=!1,this.filterOverrideActive=!1,this.fileName=null,this.selectedFilterColor=null,this.$freezing=$("#freezing"),this.$preview=$("#preview"),this.$previewImageCanvas=$("#preview-image"),this.previewImageCanvas=this.$previewImageCanvas.get(0),this.previewImageCtx=this.previewImageCanvas.getContext("2d"),this.$previewOverlayCanvas=$("#preview-overlay"),this.previewOverlayCanvas=this.$previewOverlayCanvas.get(0),this.previewOverlayCtx=this.previewOverlayCanvas.getContext("2d"),this.$addKnownColor=$("#add-known-color").on("click",function(t){t.preventDefault(),e.addKnownValueInputRow()}),this.$imageSelect=$("#image-select"),this.$imageSelectFileInput=this.$imageSelect.children("input").on("change",function(t){var a=t.target;if(a.files&&a.files[0]){e.fileName=a.files[0].name.split(/[\/]/g).pop();var i=new FileReader;i.onload=function(t){e.backupImage.src=t.target.result,e.$backupImage.one("load",function(){e.$backupImage.off("error"),e.haveImage=!0,e.updatePreview()}).one("error",function(){e.$backupImage.off("load"),$.Dialog.fail("Could not load image. Please make sure it is an actual image file.")})},i.readAsDataURL(a.files[0])}}),this.$imageSelectFileButton=this.$imageSelect.children("button").on("click",function(t){t.preventDefault(),e.$imageSelectFileInput.click()}),this.$filterTypeSelect=$("#filter-type").children("select").on("change",function(){e.updateFilterCandidateList(),e.updatePreview()}),this.$sensitivityControls=$("#sensitivity"),this.$sensitivitySlider=this.$sensitivityControls.children("div"),this.$sensitivityDisplay=this.$sensitivityControls.find(".display"),this.sensitivitySlider=this.$sensitivitySlider.get(0),noUiSlider.create(this.sensitivitySlider,{start:[10],range:{min:0,max:255},step:1,behaviour:"drag snap",format:{to:function(e){return parseInt(e,10)},from:function(e){return parseInt(e,10)}}}),this.sensitivitySlider.noUiSlider.on("update",function(t,a){e.$sensitivityDisplay.text(t[a])}),this.sensitivitySlider.noUiSlider.on("end",function(){e.updatePreview()}),this.$resultSaveButton=$("#result").children("button").on("click",function(t){if(t.preventDefault(),e.haveImage&&null!==e.selectedFilterColor){var a=void 0;if(e.isOverlayEnabled()){(a=document.createElement("canvas")).width=e.previewImageCanvas.width,a.height=e.previewImageCanvas.height;var i=a.getContext("2d");i.drawImage(e.previewImageCanvas,0,0),i.drawImage(e.previewOverlayCanvas,0,0)}else a=e.previewImageCanvas;a.toBlob(function(t){var a=" (no "+e.getFilterType()+" filter)";saveAs(t,e.fileName.replace(/^(.*?)(\.(?:[^.]+))?$/,"$1"+a+"$2")||"image"+a+".png")})}}),this.$filterCandidates=$("#filter-candidates").children("ul"),this.$filterCandidates.on("click","li",function(t){var a=$(t.target).closest("li"),i=a.hasClass("selected");e.$filterCandidates.children(".selected").removeClass("selected"),i||(a.addClass("selected"),e.selectedFilterColor=$.RGBAColor.parse(a.attr("data-rgba"))),e.updatePreview()}),this.$overlayControls=$("#overlay"),this.$overlayToggleInput=this.$overlayControls.find('input[type="checkbox"]').on("change input",function(t){e.$previewOverlayCanvas[t.target.checked?"removeClass":"addClass"]("hidden")}),this.$overlayColorInput=this.$overlayControls.find('input[type="text"]').on("change",function(t){var a=$.RGBAColor.parse(t.target.value);null!==a&&(t.target.value=a,e.overlayColor=a,e.repaintOverlay())}).on("change input blur",function(e){var t=$(e.target),a=$.RGBAColor.parse(e.target.value);null!==a?t.css({color:a.isLight()?"black":"white",backgroundColor:a.toString()}):t.css({color:"",backgroundColor:""})}),this.$overlayColorInput.val(this.overlayColor.toString()).trigger("input"),$("#filter-override").find('input[type="checkbox"]').on("change input",function(t){if(e.filterOverrideActive=t.target.checked,e.$filterCandidates.parent()[e.filterOverrideActive?"addClass":"removeClass"]("hidden"),e.filterOverrideActive)e.updateOverriddenFilterColor();else{var a=e.$filterCandidates.children(".selected");e.selectedFilterColor=a.length?$.RGBAColor.parse(a.attr("data-rgba")):null,e.updatePreview()}}),this.$filterOverrideOpacity=$("#filter-override-opacity").on("change",function(t){t.target.value=$.rangeLimit(t.target.value,!1,0,100),e.updateOverriddenFilterColor()}),this.$filterOverrideColor=$("#filter-override-color").on("change",function(t){var a=$.RGBAColor.parse(t.target.value);null!==a&&(t.target.value=a.toHex(),e.updateOverriddenFilterColor())}).on("change input blur",function(e){var t=$(e.target),a=$.RGBAColor.parse(e.target.value);null!==a?t.css({color:a.isLight()?"black":"white",backgroundColor:a.toHex()}):t.css({color:"",backgroundColor:""})}),this.addKnownValueInputRow(!0),this.addKnownValueInputRow(),this.addKnownValueInputRow(),this.addKnownValueInputRow();var a=["#9BDBF5","#364AAB","#F9B764","#573F45","#1B98D1","#093395","#EC4141","#52152D"];this.$knownColorsTbody.find("input").each(function(e,t){$(t).val(a[e]).trigger("blur")}),this.$filterOverrideOpacity.val(75),this.$filterOverrideColor.val("#221F9A").trigger("blur")}return _createClass(t,[{key:"isOverlayEnabled",value:function(){return!this.$previewOverlayCanvas.hasClass("hidden")}},{key:"updateOverriddenFilterColor",value:function(){if(this.filterOverrideActive){var e=$.RGBAColor.parse(this.$filterOverrideColor.val());null!==e&&(e.alpha=this.$filterOverrideOpacity.val()/100),this.selectedFilterColor=e,this.updatePreview()}}},{key:"createKnownValueInput",value:function(e){var t=this;return $.mk("td").attr("class","color-cell "+e).append($.mk("input").attr({type:"text",required:!0,autocomplete:"off",spellcheck:"false"}).on("input change blur",function(e){var t=$(e.target),a=t.val(),i=$.RGBAColor.parse(a);null===i?t.css({color:"",backgroundColor:""}):t.css({color:i.isLight()?"black":"white",backgroundColor:i.toHex()})}).on("blur",function(e){var a=$(e.target),i=$.RGBAColor.parse(a.val());null!==i?a.removeAttr("pattern").val(i):a.attr("pattern","^[^\\s\\S]$"),t.updateFilterCandidateList()}).on("paste",function(e){window.requestAnimationFrame(function(){$(e.target).trigger("blur")})}))}},{key:"addKnownValueInputRow",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.$knownColorsTbody.append($.mk("tr").attr("class",t?"reference":"").append(this.createKnownValueInput("original"),this.createKnownValueInput("filtered"),$.mk("td").attr("class","actions").append($.mk("button").attr({disabled:t,class:"red typcn typcn-minus",title:"Remove known color pair"}).on("click",function(t){t.preventDefault();var a=$(t.target).closest("tr");2===a.siblings().length&&a.siblings().find("button.red").disable().addClass("hidden"),a.remove(),e.updateFilterCandidateList()}),$.mk("button").attr({class:"darkblue typcn typcn-anchor",title:"Set as reference color",disabled:t}).on("click",function(t){t.preventDefault();var a=$(t.target);if(!a.is(":disabled")){var i=a.closest("tr"),r=i.find("input:invalid");r.length?r.first().focus():(i.addClass("reference").siblings().removeClass("reference").find("button").enable(),a.siblings().addBack().disable(),e.updateFilterCandidateList())}})))),this.$knownColorsTbody.children().length>=2){var a=this.$knownColorsTbody.children();a.find("button.red").removeClass("hidden"),a.filter(":not(.reference)").find("button.red").enable()}}},{key:"redrawPreviewImage",value:function(){this.previewOverlayCanvas.width=this.previewImageCanvas.width=this.backupImage.width,this.previewOverlayCanvas.height=this.previewImageCanvas.height=this.backupImage.height,this.previewImageCtx.drawImage(this.backupImage,0,0),this.previewOverlayCtx.clearRect(0,0,this.previewOverlayCanvas.width,this.previewOverlayCanvas.height)}},{key:"repaintOverlay",value:function(){if(this.haveImage){for(var e=this.previewOverlayCtx.getImageData(0,0,this.previewOverlayCanvas.width,this.previewOverlayCanvas.height),t=0;t<e.data.length;t+=4)1===e.data[t+3]&&(e.data[t]=this.overlayColor.red,e.data[t+1]=this.overlayColor.green,e.data[t+2]=this.overlayColor.blue);this.previewOverlayCtx.putImageData(e,0,0)}}},{key:"updatePreview",value:function(){var t=this;if(this.haveImage){this.redrawPreviewImage();var i=null===this.selectedFilterColor;if(this.$resultSaveButton.attr("disabled",i),!i){var r=this.sensitivitySlider.noUiSlider.get(),n=this.previewImageCtx.getImageData(0,0,this.previewImageCanvas.width,this.previewImageCanvas.height),l=this.previewOverlayCtx.getImageData(0,0,this.previewOverlayCanvas.width,this.previewOverlayCanvas.height),o=this.getReverseCalculator();this.$freezing.removeClass("hidden"),setTimeout(function(){for(var i=0;i<n.data.length;i+=4)!function(i){var s=!1,v=!1;$.each(e,function(e,l){var u=a(i,l),c=o(t.selectedFilterColor.alpha,t.selectedFilterColor[l],n.data[u]);!v&&c-r>255&&(v=!0),!s&&c+r<0&&(s=!0),n.data[u]=$.rangeLimit(c,!1,0,255)}),(s||v)&&(l.data[i]=t.overlayColor.red,l.data[i+1]=t.overlayColor.green,l.data[i+2]=t.overlayColor.blue,l.data[i+3]=255*t.overlayColor.alpha)}(i);t.previewImageCtx.putImageData(n,0,0),t.previewOverlayCtx.putImageData(l,0,0),t.$freezing.addClass("hidden")},200)}}else this.$resultSaveButton.disable()}},{key:"updateFilterCandidateList",value:function(){var e=this,a=null,i=[];if(this.$filterCandidates.empty(),this.selectedFilterColor=null,this.$knownColorsTbody.children().each(function(e,t){var r=$(t),n=r.find("input:valid");if(2===n.length){var l={};n.each(function(e,t){l[t.parentNode.className.split(" ")[1]]=$.RGBAColor.parse(t.value)}),r.hasClass("reference")?a=l:i.push(l)}}),null!==a&&i.length){var r=this.getValidFilterValues(a.original,a.filtered),n=[],l={},o=1;$.each(i,function(t,a){var i=e.pickBestFilterValues(r,a.original,a.filtered);$.each(i,function(e,t){var i=t.round().toRGBA();if(void 0!==l[i])return l[i].push(a),void(l[i].length>o&&(o=l[i].length));l[i]=[a],n.push(t)})}),n.length>1&&n.sort(function(e,t){var a=l[e.toRGBA()].length,i=l[t.toRGBA()].length;return a===i?0:a<i?1:-1}),$.each(n,function(a,i){var r=l[i.toRGBA()];e.$filterCandidates.append(t.getFilterDisplayLi(i,r))})}}},{key:"getFilterType",value:function(){return this.$filterTypeSelect.children(":selected").attr("value")}},{key:"getFilterCalculator",value:function(){switch(this.getFilterType()){case"multiply":return i.multiplyFilter;case"normal":return i.normalFilter}}},{key:"getNormalCalculator",value:function(){switch(this.getFilterType()){case"multiply":return i.multiply;case"normal":return i.normal}}},{key:"getReverseCalculator",value:function(){switch(this.getFilterType()){case"multiply":return i.multiplyReverse;case"normal":return i.normalReverse}}},{key:"getValidFilterValues",value:function(t,a){for(var i=this,r=[],n=0;n<=100;n++){(function(n){var l={},o=n/100,s=!1;if($.each(e,function(e,r){var n=i.getFilterCalculator()(o,a[r],t[r]);if(!isNaN(n))return!isFinite(n)||n<0||n>255?(s=!0,!1):void(l[r]=n);l[r]=n}),s)return"continue";l.alpha=o,r.push($.RGBAColor.fromRGB(l))})(n)}return r}},{key:"pickBestFilterValues",value:function(t,a,i){var r=void 0,n=0,l=[],o=this.getNormalCalculator();return $.each(t,function(t,s){var v=0;$.each(e,function(e,t){if(isNaN(s[t])){for(var r=void 0,n=void 0,l=0;l<=255;l++){var u=o(s.alpha,l,a[t]),c=Math.abs(i[t]-u);(void 0===r||c<r)&&(r=c,n=l)}s[t]=n,v+=r}else{var d=o(s.alpha,s[t],a[t]);v+=Math.abs(i[t]-d)}}),0===v&&l.push(s),(void 0===r||v<r)&&(r=v,n=t)}),l.length>0?l:[t[n]]}}],[{key:"getFilterDisplayLi",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=e.toRGBA(),i=$.mk("ul").attr("class","pairs");return $.each(t,function(e,t){i.append($.mk("li").append($.mk("span").attr("title",t.original.toString()).css("background-color",t.original),$.mk("span").attr("title",t.filtered.toString()).css("background-color",t.filtered)))}),$.mk("li").attr({"data-rgba":a,title:"Click to select & apply"}).append($.mk("div").attr("class","color").append($.mk("div").attr("class","color-preview").append($.mk("span").css("background-color",a)),$.mk("div").attr("class","color-rgba").append('<div><strong>R:</strong> <span class="color-red">'+e.red+"</span></div>",'<div><strong>G:</strong> <span class="color-green">'+e.green+"</span></div>",'<div><strong>B:</strong> <span class="color-blue">'+e.blue+"</span></div>","<div><strong>A:</strong> <span>"+100*e.alpha+"%</span></div>")),i)}}]),t}())});
//# sourceMappingURL=/js/min/pages/colorguide/blendingreverse.js.map
