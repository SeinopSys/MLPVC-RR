"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}();$(function(){function t(t,a,n){var o=t.closest(".tags"),r=o.closest("[id^=p]").attr("id").substring(1),l=c?$content.children("h1").text():o.siblings("strong").text().trim();$.Dialog.request("Create new tag",b.clone(!0,!0),"Create",function(t){t.children(".edit-only").replaceWith($.mk("label").append($.mk("input").attr({type:"checkbox",name:"addto"}).val(r).prop("checked","string"==typeof a),' Add this tag to the appearance "'+l+'" after creation')),"string"==typeof n&&void 0!==i[n]&&t.find("input[name=type][value="+n+"]").prop("checked",!0).trigger("change"),"string"==typeof a&&t.find("input[name=name]").val(a),t.on("submit",function(a){a.preventDefault();var i=t.mkData();$.Dialog.wait(!1,"Creating tag"),i.addto&&c&&(i.APPEARANCE_PAGE=!0),$.post(d+"/cg/tag/make"+s,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.tags&&(o.children("[data-hasqtip]").qtip("destroy",!0),o.html(this.tags),window.tooltips(),e()),!0===this.needupdate){var t=$(this.eps);g.replaceWith(t),g=t}$._tagAutocompleteCache={},$.Dialog.close()}))})})}function e(){(A=$(".tags")).filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Create new tag",icon:"plus",click:function(){t($(this))}}],"Tags"),A.children("span:not(.ctxmenu-bound)").ctxmenu([{text:"Edit tag",icon:"pencil",click:function(){var t=$(this),e=t.text().trim(),a=t.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Editing tag: "+e;$.Dialog.wait(i,"Retrieveing tag details from server"),$.post(d+"/cg/tag/get/"+a+s,$.mkAjaxHandler(function(){var e=this;this.status?$.Dialog.request(i,b.clone(!0,!0).data("tag",e),"Save",function(i){i.find("input[name=type][value="+e.type+"]").prop("checked",!0),i.find("input[type=text][name], textarea[name]").each(function(){var t=$(this);t.val(e[t.attr("name")])}),i.on("submit",function(e){e.preventDefault();var n=i.mkData();c&&(n.APPEARANCE_PAGE=t.closest("div[id^=p]").attr("id").replace(/\D/g,"")),$.Dialog.wait(!1,"Saving changes"),$.post(d+"/cg/tag/set/"+a+s,n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=this,e=$(".id-"+t.id);if(e.qtip("destroy",!0),t.title?e.attr("title",t.title):e.removeAttr("title"),e.text(t.name).data("ctxmenu-items").eq(0).text("Tag: "+t.name),e.each(function(){/typ-[a-z]+/.test(this.className)?this.className=this.className.replace(/typ-[a-z]+/,t.type?"typ-"+t.type:""):t.type&&(this.className+=" typ-"+t.type),$(this)[t.synonym_of?"addClass":"removeClass"]("synonym").parent().reorderTags()}),window.tooltips(),c&&t.needupdate){var a=$(t.eps);g.replaceWith(a),g=a}$.Dialog.close()}))})}):$.Dialog.fail(i,this.message)}))}},{text:"Remove tag",icon:"minus",click:function(){var t=$(this),e=t.attr("class").match(/id-(\d+)(?:\s|$)/);if(!e)return!1;e=e[1];var a=t.closest("[id^=p]").attr("id").replace(/\D/g,""),i=t.text().trim(),n="Remove tag: "+i;$.Dialog.confirm(n,"The tag <strong>"+i+"</strong> will be removed from this appearance.<br>Are you sure?",["Remove it","Nope"],function(i){if(i){var o={tag:e};$.Dialog.wait(n,"Removing tag"),c&&(o.APPEARANCE_PAGE=!0),$.post(d+"/cg/appearance/untag/"+a+s,o,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(n,this.message);if(!0===this.needupdate){var a=$(this.eps);g.replaceWith(a),g=a}t.qtip("destroy",!0),t.remove(),$(".tag.synonym").filter("[data-syn-of="+e+"]").remove(),$.Dialog.close()}))}})}},{text:"Delete tag",icon:"trash",click:function(){var t=$(this),e=t.text().trim(),a=t.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Detele tag: "+e;$.Dialog.confirm(i,"Deleting this tag will also remove it from every appearance where itâ€™s been used.<br>Are you sure?",["Delete it","Nope"],function(e){if(e){var n={};c&&(n.APPEARANCE_PAGE=t.closest("[id^=p]").attr("id").substring(1)),function t(e){$.Dialog.wait(i,"Sending removal request"),$.post(d+"/cg/tag/del/"+a+s,e,$.mkAjaxHandler(function(){if(this.status){if(!0===this.needupdate){var n=$(this.eps);g.replaceWith(n),g=n}var o=$(".id-"+a);o.qtip("destroy",!0),o.remove(),$._tagAutocompleteCache={},$.Dialog.close()}else this.confirm?$.Dialog.confirm(!1,this.message,["NUKE TAG","Nevermind"],function(a){a&&(e.sanitycheck=!0,t(e))}):$.Dialog.fail(i,this.message)}))}(n)}})}},$.ctxmenu.separator,{text:"Create new tag",icon:"plus",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(t){return"Tag: "+t.text().trim()});var a=[Key.Enter,Key.Comma];A.children(".addtag").each(function(){var i=$(this),n=i.closest("[id^=p]").attr("id").substring(1);i.autocomplete({minLength:3},[{name:"tags",display:"name",source:function(t,e){if(void 0===$._tagAutocompleteCache)$._tagAutocompleteCache={};else if(void 0!==$._tagAutocompleteCache[t])return e($._tagAutocompleteCache[t]);$.get(d+"/cg/get-tags?s="+encodeURIComponent(t),$.mkAjaxHandler(function(){e($._tagAutocompleteCache[t]=this)}))},templates:{suggestion:Handlebars.compile('<span class="tag id-{{tid}} {{type}} {{#if synonym_of}}synonym{{else}}monospace{{/if}}">{{name}} <span class="uses">{{#if synonym_of}}<span class="typcn typcn-flow-children"></span>{{synonym_target}}{{else}}{{uses}}{{/if}}</span></span>')}}]),i.on("keydown",function(o){if(a.includes(o.keyCode)){o.preventDefault();var r=i.val().trim(),l=i.parents(".tags"),p=l.children(".tag"),u="Adding tag: "+r;if(p.filter(function(){return this.innerHTML.trim()===r}).length>0)return $.Dialog.fail(u,"This appearance already has this tag");$.Dialog.setFocusedElement(i.attr("disabled",!0)),i.parent().addClass("loading"),i.autocomplete("val",r);var h={tag_name:r};c&&(h.APPEARANCE_PAGE=!0),$.post(d+"/cg/appearance/tag/"+n+s,h,$.mkAjaxHandler(function(){if(this.status){if(!0===this.needupdate){var a=$(this.eps);g.replaceWith(a),g=a}l.children("[data-hasqtip]").qtip("destroy",!0),l.children(".tag").remove(),l.append($(this.tags).filter("span")),window.tooltips(),e(),$._tagAutocompleteCache={},i.autocomplete("val","").focus()}else{if("string"==typeof this.cancreate){var n=this.cancreate,o=this.typehint;return u=u.replace(r,n),$.Dialog.confirm(u,this.message,function(e){e&&t(i,n,o)})}$.Dialog.fail(u,this.message)}})).always(function(){i.removeAttr("disabled").parent().removeClass("loading")})}}),i.nextAll(".aa-menu").on("click",".tag",function(){i.trigger({type:"keydown",keyCode:Key.Enter})})}),(n=$("ul.colors")).filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Re-order color groups",icon:"arrow-unsorted",click:function(){var t=$(this),a=t.closest("[id^=p]"),i=a.attr("id").substring(1),n="Re-order color groups on appearance: "+(c?$content.children("h1").text():a.children().last().children("strong").text().trim());$.Dialog.wait(n,"Retrieving color group list from server"),$.post(d+"/cg/appearance/getcgs/"+i+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(this.message);var a=$.mk("form","cg-reorder"),o=$.mk("ol");$.each(this.cgs,function(t,e){o.append($.mk("li").attr("data-id",e.id).text(e.label))}),a.append($.mk("div").attr("class","cgs").append('<p class="align-center">Drag to re-arrange</p>',o)),new Sortable(o.get(0),{ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.request(n,a,"Save",function(a){a.on("submit",function(n){n.preventDefault();var o={cgs:[]},r=a.children(".cgs");if(!r.length)return $.Dialog.fail(!1,"There are no color groups to re-order");r.find("ol").children().each(function(){o.cgs.push($(this).attr("data-id"))}),o.cgs=o.cgs.join(","),$.Dialog.wait(!1,"Saving changes"),c&&(o.APPEARANCE_PAGE=!0),$.post(d+"/cg/appearance/setcgs/"+i+s,o,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(null,this.message);t.html(this.cgs),window.tooltips(),e(),$.Dialog.close()}))})})}))}},{text:"Create new group",icon:"folder-add",click:function(){D.factory("Create color group",$(this).closest("[id^=p]").attr("id").substring(1))}},{text:"Apply template (if empty)",icon:"document-add",click:function(){var t=$(this).closest("[id^=p]").attr("id").substring(1);$.Dialog.confirm("Apply template on appearance","Add common color groups to this appearance?<br>Note: This will only work if there are no color groups currently present.",function(a){if(a){$.Dialog.wait(!1,"Applying template");var i={};c&&(i.APPEARANCE_PAGE=!0),$.post(d+"/cg/appearance/applytemplate/"+t+s,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$("#p"+t).find("ul.colors").html(this.cgs),window.tooltips(),e(),$.Dialog.close()}))}})}}],"Color groups"),n.children("li").filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Edit color group",icon:"pencil",click:function(){var t=$(this),e=t.closest("li"),a=e.attr("id").substring(2),i="Editing color group: "+t.children().first().text().replace(/:\s?$/,"");$.Dialog.wait(i,"Retrieving color group details from server"),$.post(d+"/cg/colorgroup/get/"+a+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(i,this.message);D.factory(i,e,this)}))}},{text:"Delete color group",icon:"trash",click:function(){var t=$(this).closest("li"),e=t.attr("id").substring(2),a="Delete color group: "+t.children().first().text().replace(/:\s?$/,"");$.Dialog.confirm(a,"By deleting this color group, all colors within will be removed too.<br>Are you sure?",function(i){i&&($.Dialog.wait(a,"Sending removal request"),$.post(d+"/cg/colorgroup/del/"+e+s,$.mkAjaxHandler(function(){this.status?(t.children("[data-hasqtip]").qtip("destroy",!0),t.remove(),$.Dialog.close()):$.Dialog.fail(a,this.message)})))})}},$.ctxmenu.separator,{text:"Re-order color groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}}],function(t){return"Color group: "+t.children().first().text().trim().replace(":","")});var i=n.children("li").find(".valid-color");$.ctxmenu.addItems(i.filter(".ctxmenu-bound"),$.ctxmenu.separator,{text:"Edit color group",icon:"pencil",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),1)}},{text:"Delete color group",icon:"trash",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),2)}},$.ctxmenu.separator,{text:"Re-order color groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),3)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent().closest(".ctxmenu-bound"),4)}}),$(".upload-wrap").filter(":not(.ctxmenu-bound)").each(function(){var t=$(this),e=t.closest("li");e.length||(e=$content.children("[id^=p]")),function(t,e){var a=t.find("img").attr("src"),i=void 0,n=function(){a=t.find("img").attr("src"),i=-1===a.indexOf("blank-pixel.png"),t[i?"removeClass":"addClass"]("nosprite"),$.ctxmenu.setDefault(t,i?1:4)};t.uploadZone({requestKey:"sprite",title:"Upload sprite",accept:"image/png",target:d+"/cg/appearance/setsprite/"+e}).on("uz-uploadstart",function(){$.Dialog.close()}).on("uz-uploadfinish",function(){n()}).ctxmenu([{text:"Open image in new tab",icon:"arrow-forward",click:function(){if(-1!==a.indexOf("blank-pixel.png"))return $.Dialog.fail("Open image in new tab","This appearance lacks a sprite image");window.open(t.find("img").attr("src"),"_blank")}},{text:"Copy image URL",icon:"clipboard",click:function(){if(-1!==a.indexOf("blank-pixel.png"))return $.Dialog.fail("Copy image URL","This appearance lacks a sprite image");$.copy($.toAbsoluteURL(t.find("img").attr("src")))}},{text:"Check sprite colors",icon:"adjust-contrast",click:function(){if(-1!==a.indexOf("blank-pixel.png"))return $.Dialog.fail("Check sprite colors","This appearance lacks a sprite image");$.Navigation.visit(d+"/cg/sprite/"+e)}},{text:"Upload new sprite",icon:"upload",click:function(){var a="Upload sprite image",i=t.find('input[type="file"]');$.Dialog.request(a,h.clone(),"Download image",function(t){var n=t.find("input[name=image_url]");t.find(".upload-link").on("click",function(t){t.preventDefault(),t.stopPropagation(),i.trigger("click",[!0])}),p&&t.find(".sprite-template-gen").on("click",function(t){t.preventDefault(),t.stopPropagation();var a="Sprite Template Generator",i=function(t){var e=window.$TemplateGenFormTemplate.clone(!0,!0);$.Dialog.request(a,e,!1,function(){e.triggerHandler("added"),t&&e.triggerHandler("got-colors",[t])})},n=function(){if(isNaN(e))return i(!1);$.Dialog.wait(a,"Getting relevant appearance colors"),$.post("/cg/get-sprite-colors/"+e,$.mkAjaxHandler(function(){if(!this.status)return i(!1);i(this.colors)}))};if($.Dialog.close(),void 0===window.$TemplateGenFormTemplate){$.Dialog.wait(a,"Loading form, please wait");$.getScript("/js/min/global-template_gen_form.js",n).fail(function(){$.Dialog.fail(a,"Form could not be loaded")})}else n()}),t.on("submit",function(t){t.preventDefault();var o=n.val();$.Dialog.wait(a,"Downloading external image to the server"),$.post(d+"/cg/appearance/setsprite/"+e+s,{image_url:o},$.mkAjaxHandler(function(){this.status?i.trigger("set-image",[this.path]):$.Dialog.fail(a,this.message)}))})})}},{text:"Remove sprite image",icon:"times",click:function(){if(-1!==a.indexOf("blank-pixel.png"))return $.Dialog.fail("Remove sprite image","This appearance lacks a sprite image");$.Dialog.confirm("Remove sprite image","Are you sure you want to <strong>permanently delete</strong> the sprite image from the server?",["Wipe it","Nope"],function(a){a&&($.Dialog.wait(!1,"Removing image"),$.post(d+"/cg/appearance/delsprite/"+e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);t.find("img").attr("src",this.sprite),n(),$.Dialog.close()})))})}}],"Sprite image").attr("title",r?" ":"").on("click",function(e,a){if(!0===a)return!0;e.preventDefault(),$.ctxmenu.runDefault(t)}),n()}(t,e.attr("id").substring(1))})}function a(){$("button.edit:not(.bound)").addClass("bound").on("click",function(){var t=$(this),e=t.closest("[id^=p]").attr("id").substring(1),a="Editing appearance: "+(c?$content.children("h1").text():t.parent().text().trim());$.Dialog.wait(a,"Retrieving appearance details from server"),$.post(d+"/cg/appearance/get/"+e+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var i=this;i.appearanceID=e,v(t,a,i)}))}).next(".delete").on("click",function(){var t=$(this),e=t.closest("[id^=p]"),a=e.attr("id").substring(1),i="Deleting appearance: "+(c?$content.children("h1").text():t.parent().text().trim());$.Dialog.confirm(i,"Deleting this appearance will remove <strong>ALL</strong> of its color groups, the colors within them, and the sprite file, if any.<br>Delete anyway?",function(t){t&&($.Dialog.wait(i,"Sending removal request"),$.post(d+"/cg/appearance/delete/"+a+s,$.mkAjaxHandler(function(){if(this.status){e.remove(),$.Dialog.success(i,this.message);var t=window.location.pathname;0===m.children().length&&(t=t.replace(/(\d+)$/,function(t){return t>1?t-1:t})),c?($.Dialog.wait("Navigation","Loading page 1"),$.Navigation.visit(d+"/cg/1")):$.toPage(t,!0,!0)}else $.Dialog.fail(i,this.message)})))})}),e()}var i=window.TAG_TYPES_ASSOC,n=void 0,o=window.HEX_COLOR_PATTERN,r="WebkitAppearance"in document.documentElement.style,l=window.EQG,s=l?"?eqg":"",c=!!window.AppearancePage,p=window.PersonalGuide,d=p?"/@"+p:"",u=function(t,e,a){var i=[];a&&a[1]||i.push("HEX color"),a&&a[2]||i.push("color name"),this.message="Parse error on line "+e+' (shown below)\n\t\t\t\t<pre style="font-size:16px"><code>'+t.replace(/</g,"&lt;")+"</code></pre>\n\t\t\t\t"+(i.length?"The "+i.join(" and ")+" is missing from this line.":"Please check for any typos before continuing."),this.lineNumber=e},h=$.mk("form","sprite-upload").html((p?'<div class="notice info"><label>About sprites</label><p>Sprites are small, pixelated images showcasing all of the colors a given character has. They are most useful if they contain a full body image of your character with any difficult details highlighted. You can use it together with the notes, adding explanations about anything that might be confusing.</p><p>Sprites have a height limit of 300px, a width limit between 300 and 700 pixels, and are expected to be PNG files with a transparent background.</p><p>We provide templates that fit these guidelines for anyone to use through the <a class="sprite-template-gen">Template Generator</a>. If you decide to use this generator, you must add at least the mane and tail before uploading the sprite to the site.</p><p class="color-red">The staff reserves the right to remove any sprites that do not follow these guidelines.</p></div>':"")+'<p class="align-center"><a class="upload-link">Click here to upload a file</a> (max. '+window.MAX_SIZE+') or enter a URL below.</p>\n\t\t<label><input type="text" name="image_url" placeholder="External image URL" required></label>\n\t\t<p class="align-center">The URL will be checked against the supported provider list, and if an image is found, it\'ll be downloaded to the server and set as this appearanceâ€™s sprite image.</p>'),g=void 0;c&&(g=$("#ep-appearances")),$.fn.reorderTags=function(){return this.each(function(){$(this).children(".tag").sort(function(t,e){var a=/^.*typ-([a-z]+).*$/;return t=[t.className.replace(a,"$1"),t.innerHTML.trim()],e=[e.className.replace(a,"$1"),e.innerHTML.trim()],t[0]===e[0]?t[1].localeCompare(e[1]):t[0].localeCompare(e[0])}).appendTo(this)})};var m=$(".appearance-list"),f=$.mk("form","pony-editor").append('<label>\n\t\t\t\t\t<span>Name (4-70 chars.)</span>\n\t\t\t\t\t<input type="text" name="label" placeholder="Enter a name" pattern="'+PRINTABLE_ASCII_PATTERN.replace("+","{4,70}")+'" required maxlength="70">\n\t\t\t\t</label>\n\t\t\t\t<div class="label">\n\t\t\t\t\t<span>Additional notes (1000 chars. max, optional)</span>\n\t\t\t\t\t<div class="ace_editor"></div>\n\t\t\t\t</div>\n\t\t\t\t<label><input type=\'checkbox\' name=\'private\'> Make private (only '+(p?"you":"admins")+" can see added colors)</label>"),v=function(t,e,a){var i=!!a,n=t.parents("[id^=p]").find(".notes"),o=void 0;if(c){if(!i)return;o=$content.children("h1")}else o=t.siblings().first();$.Dialog.request(e,f.clone(!0,!0),"Save",function(t){var r=void 0,l=void 0;$.getAceEditor(!1,"html",function(e){try{var n=t.find(".ace_editor").get(0),o=ace.edit(n);(l=$.aceInit(o,e)).setMode(e),l.setUseWrapMode(!0),i&&a.notes&&l.setValue(a.notes)}catch(t){console.error(t)}}),i?(r=a.appearanceID,t.find("input[name=label]").val(a.label),a.cm_preview&&t.find("input[name=cm_preview]").val(a.cm_preview),a.cm_dir&&t.find("input[name=cm_dir]").enable().filter("[value="+a.cm_dir+"]").prop("checked",!0),a.private&&t.find("input[name=private]").prop("checked",!0),t.append($.mk("div").attr("class","align-center").append($.mk("button").attr("class","orange typcn typcn-media-eject").text("Selective wipe").on("click",function(t){t.preventDefault();var e=a.label,i=$.mk("form","selective-wipe").html('<p>Select which of the following items to clear below.</p>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cache"> Clear cached images</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cm_tokenized"> Clear tokenized cutie mark</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cm_source"> Clear cutie mark source file</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_cms"> Remove all cutie marks</label>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_sprite"> Clear sprite image</label>\n\t\t\t\t\t\t\t\t\t\t\t<fieldset>\n\t\t\t\t\t\t\t\t\t\t\t\t<legend>Color Groups</legend>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="" checked><span>Nothing</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="color_hex"><span>HEX values</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="color_all"><span>Colors</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" name="wipe_colors" value="all"><span>Color groups</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</fieldset>\n\t\t\t\t\t\t\t\t\t\t\t<label><input type="checkbox" name="wipe_notes"> Clear notes</label>'+(p?"":'<label><input type="checkbox" name="wipe_tags"> Remove all tags</label>')+'<label><input type="checkbox" name="mkpriv"> Make private</label>');$.Dialog.close(),$.Dialog.request("Selectively wipe data from "+e,i,"Clear data",function(){i.on("submit",function(t){t.preventDefault();var e=i.mkData();if(e.wipe_colors||delete e.wipe_colors,0===Object.keys(e).length)return $.Dialog.fail(!1,"You didn't select any data to clear");$.Dialog.clearNotice(/select any data/),$.Dialog.confirm(!1,"The action you are about to perform is irreversible. Are you sure you want to proceed?",["Wipe selected data","Changed my mind"],function(t){t&&($.Dialog.wait(!1),$.post("/cg/appearance/selectiveclear/"+r,e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Navigation.reload(!0)})))})})})}),p?void 0:$.mk("button").attr("class","darkblue typcn typcn-pencil").text("Relations").on("click",function(t){t.preventDefault(),$.Dialog.close(),$.Dialog.wait("Appearance relation editor","Retrieving relations from server");var e=$content.find("section.related");$.post(d+"/cg/appearance/getrelations/"+r+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var t=this,a=$.mk("form").attr("id","guide-relation-editor"),i=$.mk("select").attr({name:"listed",multiple:!0}),n=$.mk("select").attr("multiple",!0);t.linked&&t.linked.length&&$.each(t.linked,function(t,e){var a=$.mk("option").attr("value",e.id).text(e.label);e.mutual&&a.attr("data-mutual",!0).text("(M) "+a.text()),i.append(a)}),t.unlinked&&t.unlinked.length&&$.each(t.unlinked,function(t,e){n.append($.mk("option").attr("value",e.id).text(e.label))});var o=$.mk("div").attr("class","mutual-fieldset-wrap").html('<fieldset>\n\t\t\t\t\t\t\t\t\t\t\t\t<legend data-placeholder="Relation type"></legend>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="radio-group">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" class="mutual-checkbox" name="mutual" value="1" required disabled><span>Mutual</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label><input type="radio" class="mutual-checkbox" name="mutual" value="0" required disabled><span>One way</span></label>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="notice"></div>\n\t\t\t\t\t\t\t\t\t\t\t</fieldset>'),l=o.find(".notice"),p=o.find("legend"),u=/^\(M\) /;o.find("input").on("change click",function(){var t=$(this);if(!t.hasAttr("disabled")){var e=i.children(":selected"),a=t.is(":checked")&&"1"===t.attr("value"),n=e.hasAttr("data-mutual");a?n||e.attr("data-mutual",!0).text("(M) "+e.text()):n&&e.removeAttr("data-mutual").text(e.text().replace(u,""))}}),i.on("change",function(){var t=i.children(":selected");1===t.length?(o.find("input").enable(),l.hide(),p.text("Relation to "+t.text().replace(u,"")),o.find('input[value="'+(t.hasAttr("data-mutual")?"1":"0")+'"]').prop("checked",!0)):(o.find("input").disable(),p.empty(),t.length>1?l.attr("class","notice fail").text("Multiple appearances are selected").show():l.attr("class","notice info").text("Select a relation on the left to change the type").show())}).triggerHandler("change"),a.append($.mk("div").attr("class","split-select-wrap").append($.mk("div").attr("class","split-select").append("<span>Linked</span>",i),$.mk("div").attr("class","buttons").append($.mk("button").attr({class:"typcn typcn-chevron-left green",title:"Link selected"}).on("click",function(t){t.preventDefault(),i.append(n.children(":selected").prop("selected",!1)).children().sort(function(t,e){return t.innerHTML.localeCompare(e.innerHTML)}).appendTo(i)}),$.mk("button").attr({class:"typcn typcn-chevron-right red",title:"Unlink selected"}).on("click",function(t){t.preventDefault(),n.append(i.children(":selected").prop("selected",!1)).children().sort(function(t,e){return t.innerHTML.localeCompare(e.innerHTML)}).appendTo(n),0===i.children().length&&(o.find("input").disable(),p.empty(),o.find(".notice").show())})),$.mk("div").attr("class","split-select").append("<span>Available</span>",n)),o),$.Dialog.request(!1,a,"Save",function(t){t.on("submit",function(t){t.preventDefault();var a=[],n=[];i.children().each(function(t,e){var i=$(e),o=i.attr("value");a.push(o),i.hasAttr("data-mutual")&&n.push(o)}),$.Dialog.wait(!1,"Saving changes");var o={ids:a.join(","),mutuals:n.join(",")};c&&(o.APPEARANCE_PAGE=!0),$.post(d+"/cg/appearance/setrelations/"+r+s,o,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);this.section?(e.length||(e=$.mk("section").addClass("related").appendTo($content.children().last())),e.html($(this.section).filter("section").html())):e.length&&(e.remove(),e={length:0}),$.Dialog.close()}))})})}))}),$.mk("button").attr({class:"darkblue typcn typcn-pencil cg-cm-editor"}).text("Cutie Mark").on("click",function(t){t.preventDefault();var e=a.label;$.Dialog.close(),$.Dialog.wait("Manage Cutie Mark of "+e,"Retrieving CM data from server"),$.post(d+"/cg/appearance/getcms/"+r+s,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);C.factory(!1,r,e,this)}))})))):t.append("<label><input type='checkbox' name='template'> Pre-fill with common color groups</label>"),t.on("submit",function(a){a.preventDefault();var u=t.mkData();u.notes=l.getValue(),$.Dialog.wait(!1,"Saving changes"),c&&(u.APPEARANCE_PAGE=!0),p&&(u.PERSONAL_GUIDE=!0),$.post(d+"/cg/appearance/"+(i?"set/"+r:"make")+s,u,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(u=this,i)return c?$.Navigation.reload(!0):(o.text(u.label),u.newurl&&o.attr("href",u.newurl),n.html(this.notes),window.tooltips(),void $.Dialog.close());$.Dialog.success(!1,"Appearance added");var t=function(){$.Dialog.wait(!1,"Loading appearance page"),$.Navigation.visit(u.goto)};if(!u.info)return t();$.Dialog.segway(e,u.info,"View appearance page",t)}))})})};$("#new-appearance-btn").on("click",function(){var t=$(this),e=t.text().trim();if(!p)return v(t,e);$.Dialog.wait(e,"Checking whether you have any more slots"),$.post(d+"/cg/slot-check",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);v(t,e)}))});var b=$.mk("form","edit-tag");b.append('<label><span>Tag name (3-30 chars.)</span><input type="text" name="name" required pattern="^[^-][ -~]{1,29}$" maxlength="30"></label>');var k='<div class=\'type-selector\'>\n\t\t\t<label>\n\t\t\t\t<input type="radio" name="type" value="" checked>\n\t\t\t\t<span class="tag">Typeless</span>\n\t\t\t</label>';$.each(i,function(t,e){k+='<label>\n\t\t\t\t<input type="radio" name="type" value="'+t+'">\n\t\t\t\t<span class="tag typ-'+t+'">'+e+"</span>\n\t\t\t</label>"}),k+="</div>",b.append('<div class="align-center">\n\t\t\t<span>Tag type</span><br>\n\t\t\t'+k+'\n\t\t</div>\n\t\t<label>\n\t\t\t<span>Tag description (max 255 chars., optional)</span>\n\t\t\t<textarea name="title" maxlength="255"></textarea>\n\t\t</label>',$.mk("div").attr("class","align-center edit-only").append($.mk("button").attr("class","blue typcn typcn-flow-merge merge").html("Merge&hellip;"),$.mk("button").attr("class","blue typcn typcn-flow-children synon").html("Synonymize&hellip;")).on("click","button",function(t){t.preventDefault();var a=$(this).closest("form").data("tag"),i=a.name,n=a.id,o=this.className.split(" ").pop();$.Dialog.close(function(){window.CGTagEditing(i,n,o,function(t){var a=$(".tag.id-"+n),i=void 0;if(a.length)switch(t){case"synon":i=this.target,a.addClass("synonym");var o=a.eq(0).clone().removeClass("ctxmenu-bound"),r=new y(i),l=a.add($(".tag.id-"+i.id)).closest(".tags");l.filter(function(){return 0===$(this).children(".id-"+n).length}).append(o).reorderTags(),l.filter(function(){return 0===$(this).children(".id-"+i.id).length}).append(r).reorderTags(),window.tooltips(),e();break;case"unsynon":this.keep_tagged?a.removeClass("synonym"):a.remove();break;case"merge":i=this.target,a.each(function(){var t=$(this);0===t.siblings(".id-"+i.id).length?t.replaceWith(new y(i)):t.remove()}),window.tooltips(),e()}$.Dialog.close()})})}));var y=function(t){function e(t){var a,i;return _classCallCheck(this,e),i=(a=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,'<span class="tag id-'+t.id+(t.type?" typ-"+t.type:"")+(t.synonym_of?" synonym":"")+'" data-syn-of="'+t.synonym_of+'">'))).attr("title",t.title).text(t.name),_possibleConstructorReturn(a,i)}return _inherits(e,jQuery),e}(),w=function(){var t=void 0,e=function(){return new Promise(function(e,a){if(void 0===t){var i={};p&&(i.PERSONAL_GUIDE=p),$.post("/cg/colorgroup/appearance-list",i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Appearance list retrieval",this.message);t=this.list,e(t)})).fail(function(){a()})}else e(t)})};return{read:function(){return e()}}}(),x=function(){var t={},e=function(e){return new Promise(function(a,i){void 0===t[e]?$.post("/cg/colorgroup/list/"+e,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail("Appearance list retrieval",this.message);t[e]=this.list,a(t[e])})).fail(function(){i()}):a(t[e])})};return{read:function(t){return e(t)}}}(),D=function(){function t(a,i){var n=this;_classCallCheck(this,t),this.mode="gui",this.editing="object"===(void 0===i?"undefined":_typeof(i))&&i.label&&i.Colors,void 0!==a&&(a instanceof jQuery?(this.group_id=a.attr("id").substring(2),this.appearance_id=parseInt(a.parents("[id^=p]").attr("id").substring(1),10)):this.appearance_id=parseInt(a,10)),this.colorAppearanceDataCache={},this.templates={$inputMethodDropdown:$.mk("select").attr({class:"clrmthd",required:!0}).html('<option value="hex">Hex</option>\n\t\t\t\t\t\t<option value="link">Link</option>').on("change",function(t){var e=$(t.target);e.closest(".clr").removeClass("mthd-hex mthd-link").addClass("mthd-"+e.children("option:selected").attr("value"))}),$appearanceSelector:$.mk("select").attr("class","clrla").html('<option value="" selected data-default>(appearance)</option>').on("mouseenter",function(t){var e=$(t.target);e.hasClass("loaded")||(e.disable(),w.read().then(function(t){var a=$.mk("optgroup").attr("label","Pony Guide"),i=$.mk("optgroup").attr("label","EQG Guide"),o=$.mk("optgroup").attr("label","Personal Color Guide");!0===l?e.append(i,a):!1===l?e.append(a,i):e.append(o),$.each(t,function(t,e){console.log(e.id,n.appearance_id),(null===e.ishuman?o:e.ishuman?i:a).append($.mk("option").attr({value:e.id}).text(e.label))}),e.addClass("loaded").enable()}))}).on("change",function(t){var e=$(t.target),a=e.find("option:selected"),i=a.attr("value"),o=a.text();isNaN(i)||n.loadColorSelectFor(e,i,o)}),$colorSelector:$.mk("select").attr({class:"clrlc hidden",disabled:!0}).html('<option value="" selected data-default>(color)</option>\n\t\t\t\t\t\t<option value="\n" class="appearance-name-option" disabled></option>\n\t\t\t\t\t\t<option value="\n" data-appearance-switch>(change appearance)</option>\n\t\t\t\t\t\t<option value="\n" disabled>----------</option>').on("change",function(t){var e=$(t.target);e.children("option:selected").hasAttr("data-appearance-switch")&&e.addClass("hidden").disable().prev().val("").removeClass("hidden")}),$colorInput:$.mk("input").attr({class:"clri",autocomplete:"off",spellcheck:"false"}).patternAttr(o).on("keyup change input",function(e,a){t.validateColorInput(e,a)}).on("paste blur keyup",function(t){var e=function(){return n.expandColorInput(t)};"paste"===t.type?setTimeout(e,10):e()}),$colorLabel:$.mk("input").attr({class:"clrl",list:"common-color-names",pattern:PRINTABLE_ASCII_PATTERN.replace("+","{3,30}"),maxlength:30}),$colorActions:$.mk("div").attr("class","clra").append($.mk("span").attr({class:"typcn typcn-trash remove red",title:"Remove"}).on("click",function(t){var e=$(t.target);e.closest(".clr").addClass("faded").find("input:not(:disabled), select:not(:disabled)").disable().addClass("fade-disabled"),e.addClass("hidden").next().removeClass("hidden")}),$.mk("span").attr({class:"typcn typcn-arrow-back add green hidden",title:"Restore"}).on("click",function(t){var e=$(t.target);e.closest(".clr").removeClass("faded").find(".fade-disabled").enable().removeClass("fade-disabled"),e.addClass("hidden").prev().removeClass("hidden")}),$.mk("span").attr("class","typcn typcn-arrow-move move blue"))},this.$addBtn=$.mk("button").attr("class","typcn typcn-plus green add-color").text("Add new color").on("click",function(t){t.preventDefault(),n.addColor()}),this.$editorToggle=$.mk("button").attr("class","typcn typcn-document-text darkblue").text("Plain text editor").on("click",function(t){t.preventDefault();var e=$(t.target);e.disable();try{n.saveColorInputs()}catch(t){if(!(t instanceof u))throw t;return n.editor.gotoLine(t.lineNumber),n.editor.navigateLineEnd(),$.Dialog.fail(!1,t.message),n.editor.focus(),void e.enable()}e.toggleClass("typcn-document-text typcn-edit").toggleHtml(["Plain text editor","Interactive editor"]).enable(),$.Dialog.clearNotice(/Parse error on line \d+ \(shown below\)/)}),this.$form=$.mk("form","cg-editor").append($.mk("label").append("<span>Group name (2-30 chars.)</span>",$.mk("input").attr({type:"text",name:"label",pattern:PRINTABLE_ASCII_PATTERN.replace("+","{2,30}"),required:!0,list:"common-cg-names"}).val(i.label),'<datalist id="common-cg-names">\n\t\t\t\t\t\t<option>Coat</option>\n\t\t\t\t\t\t<option>Mane & Tail</option>\n\t\t\t\t\t\t<option>Eyes</option>\n\t\t\t\t\t\t<option>Iris</option>\n\t\t\t\t\t\t<option>Cutie Mark</option>\n\t\t\t\t\t\t<option>Magic</option>\n\t\t\t\t\t</datalist>'),p?void 0:$.mk("label").append($.mk("input").attr({type:"checkbox",name:"major"}).on("click change",function(){$(this).parent().next()[this.checked?"removeClass":"addClass"]("hidden").children("input").attr("disabled",!this.checked)}),"<span>This is a major change</span>"),"<label class=\"hidden\">\n\t\t\t\t\t<span>Change reason (1-255 chars.)</span>\n\t\t\t\t\t<input type='text' name='reason' pattern=\""+PRINTABLE_ASCII_PATTERN.replace("+","{1,255}")+'" required disabled>\n\t\t\t\t</label>\n\t\t\t\t<p class="align-center">Each color must have a short (3-30 chars.) description.<br>The eitor rounds RGB values: â‰¤3 to 0 and â‰¥252 to 255.</p>',$.mk("div").attr("class","btn-group").append(this.$addBtn,this.$editorToggle),$.mk("div").attr("class","clrs").append(this.makeColorDiv()),'<datalist id="common-color-names">\n\t\t\t\t\t<option>Outline</option>\n\t\t\t\t\t<option>Fill</option>\n\t\t\t\t\t<option>Shadow Outline</option>\n\t\t\t\t\t<option>Shadow Fill</option>\n\t\t\t\t\t<option>Gradient Top</option>\n\t\t\t\t\t<option>Gradient Middle</option>\n\t\t\t\t\t<option>Gradient Bottom</option>\n\t\t\t\t\t<option>Hightlight Top</option>\n\t\t\t\t\t<option>Hightlight Bottom</option>\n\t\t\t\t</datalist>').on("submit",function(t){t.preventDefault();try{n.saveColorInputs(!0,!0)}catch(t){if(!(t instanceof u))throw t;return n.editor.gotoLine(t.lineNumber),n.editor.navigateLineEnd(),$.Dialog.fail(!1,t.message),void n.editor.focus()}var a=n.$form.mkData(),i=n.appearance_id;if(a.Colors=n.colorValues,n.editing||(a.ponyid=n.appearance_id),0===a.Colors.length)return $.Dialog.fail(!1,"You need to add at least one valid color");a.Colors=JSON.stringify(a.Colors),c&&(a.APPEARANCE_PAGE=!0);var o=$("#changes");o.length||(a.FULL_CHANGES_SECTION=!0),$.Dialog.wait(!1,"Saving changes"),$.post(d+"/cg/colorgroup/"+(n.editing?"set/"+n.group_id:"make")+s,a,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.cgs){var t=$("#p"+i);if(this.cgs&&t.find("ul.colors").html(this.cgs),!c&&this.notes){var a=t.find(".notes");try{a.find(".cm-direction").qtip("destroy",!0)}catch(t){}a.html(this.notes)}if(this.update){var n=t.find(".update");n.length?n.replaceWith(this.update):$(this.update).insertAfter(t.find("strong"))}this.changes&&(o.length?o.replaceWith(this.changes):$(this.changes).insertBefore($("#tags"))),window.tooltips(),e(),(this.update||this.changes)&&Time.Update(),c&&this.cm_list&&$("#pony-cm-list").html(this.cm_list),$.Dialog.close()}else $.Dialog.close()}))}),this.editing&&this.setColorValues(i.Colors).renderColorInputs()}return _createClass(t,[{key:"expandColorInput",value:function(t){var e=t.target,a=$.hexpand(e.value);if(o.test(a)){a=a.replace(o,"#$1").toUpperCase();var i=$(e),n=$.hex2rgb(a);switch($.each(n,function(t,e){e<=3?n[t]=0:e>=252&&(n[t]=255)}),a=$.rgb2hex(n),t.type){case"paste":i.next().focus();case"blur":i.val(a)}i.trigger("change",[a]).patternAttr(SHORT_HEX_COLOR_PATTERN.test(e.value)?SHORT_HEX_COLOR_PATTERN:o)}}},{key:"makeColorDiv",value:function(t){var e=this.templates.$inputMethodDropdown.clone(!0,!0),a=this.templates.$colorInput.clone(!0,!0),i=this.templates.$colorLabel.clone(),n=this.templates.$colorActions.clone(!0,!0),o=this.templates.$appearanceSelector.clone(!0,!0),r=this.templates.$colorSelector.clone(!0,!0),l=$.mk("div").attr("class","clr mthd-hex"),s=void 0;return l.append(e,o,r),"object"===(void 0===t?"undefined":_typeof(t))&&(t.hex&&a.val(t.hex.toUpperCase()),t.label&&i.val(t.label),t.id&&(s=$.mk("span").attr("class","clrid").text("ID:"+t.id)),t.linked_to&&(e.val("link").triggerHandler("change"),void 0!==t.appearance?this.colorAppearanceDataCache[t.id]=t.appearance:t.appearance=this.colorAppearanceDataCache[t.id],this.loadColorSelectFor(o,t.appearance.id,t.appearance.label).then(function(e){e.val(t.linked_to)}))),l.append("<span class='clrp'></span>",a,i,s,n),a.triggerHandler("change"),l}},{key:"addColor",value:function(){var t=this.$form.children(".clrs");if(t.length||(t=$.mk("div").attr("class","clrs"),this.$form.append(t)),"gui"===this.mode){var e=this.makeColorDiv();t.append(e),e.find(".clri").focus()}else{this.editor.clearSelection(),this.editor.navigateLineEnd();var a=this.editor.getCursorPosition(),i=a.row+1,n=0===a.column,o=window.copyHashEnabled();n||i++,this.editor.insert((n?"":"\n")+(o?"#":"")+"\t"),this.editor.gotoLine(i,Number(o)),this.editor.focus()}}},{key:"renderColorInputs",value:function(){var t=this,e=this.$form.children(".clrs");e.empty(),$.each(this.colorValues,function(a,i){e.append(t.makeColorDiv(i))}),this.destroySortable(),this.sortable=new Sortable(e.get(0),{handle:".move",ghostClass:"moving",scroll:!1,animation:150})}},{key:"saveColorInputs",value:function(e,a){var i=this,n=this.$form.children(".clrs");if("gui"===this.mode){var r=[];if(n.children(".clr").each(function(){var t=$(this),e=t.children(".clrmthd"),i=e.is(":disabled")?null:e.find("option:selected").attr("value"),n=t.children(".clrid"),l=n.length?n.text().replace("ID:",""):void 0;switch(i){case"hex":var s=t.children(".clri").val(),c=o.test(s);if(!c&&(s.length||a))return;r.push({id:l,hex:c?$.hexpand(s).toUpperCase().replace(o,"#$1"):void 0,label:t.children(".clrl").val()});break;case"link":var p=t.children(".clrlc");r.push({id:l,hex:void 0,label:t.children(".clrl").val(),linked_to:p.val()})}}),this.colorValues=r,e)return;var l=["// One color per line, e.g. #012ABC Fill"];$.each(r,function(t,e){var a=[];"object"===(void 0===e?"undefined":_typeof(e))&&(e.linked_to?a.push("@"+e.linked_to):a.push(e.hex?e.hex:"#"),a.push(e.label||""),e.id&&a.push("ID:"+e.id)),l.push(a.join("\t"))}),this.destroySortable(),n.unbind().hide().text(l.join("\n")+"\n"),$.getAceEditor(!1,"colorguide",function(t){n.show(),i.editor=ace.edit(n[0]);var e=$.aceInit(i.editor,t);e.setTabSize(8),e.setMode(t),i.editor.navigateFileEnd(),i.editor.focus(),i.mode="text"})}else{if(this.colorValues=t.parseColorsText(this.editor.getValue(),e||a),e)return;this.editor.destroy(),this.editor=null,n.empty().unbind().attr("class","clrs"),this.renderColorInputs(),this.mode="gui"}}},{key:"setColorValues",value:function(t){return this.colorValues=t,this}},{key:"getForm",value:function(){return this.$form}},{key:"destroySortable",value:function(){void 0!==this.sortable&&(this.sortable.destroy(),this.sortable=void 0)}},{key:"loadColorSelectFor",value:function(t,e,a){var i=t.next(),n=parseInt(t.siblings().filter(".clrid").text().replace("ID:",""),10);return t.disable(),new Promise(function(o){x.read(e).then(function(e){i.children("optgroup").remove(),i.children(".appearance-name-option").text(a),$.each(e,function(t,e){var a=$.mk("optgroup").attr("label",e.label);i.append(a),$.each(e.colors,function(t,e){a.append($.mk("option").attr({value:e.id,disabled:void 0===e.id||e.id===n}).text(e.label))})}),t.enable().addClass("hidden"),i.enable().val("").removeClass("hidden"),o(i)})})}}],[{key:"factory",value:function(e,a,i){$.Dialog.request(e,new t(a,i).getForm(),"Save")}},{key:"validateColorInput",value:function(t,e){var a=$(t.target),i=a.prev(),n=("string"==typeof e?e:a.val()).trim();o.test(n)?i.removeClass("invalid").css("background-color",n.replace(o,"#$1")):i.addClass("invalid").css("background-color","")}},{key:"parseColorsText",value:function(t,e){for(var a=[],i=t.split("\n"),n=0,o=i.length;n<o;n++){var r=i[n];if(!/^(\/\/.*)?$/.test(r)){var l=r.trim();if("#"!==l){var s=l.match(/^(?:#?([a-f\d]{6}|[a-f\d]{3})?|@(\d+))(?:\s*([ -~]{3,30}))?(?:\s*ID:(\d+))?$/i);if(!s||!s[3]||e&&!s[1])throw new u(r,n+1,s);a.push({hex:s[1]?$.hexpand(s[1]):void 0,label:s[3],id:s[4],linked_to:s[2]?s[2]:void 0})}else a.push({hex:void 0,label:""})}}return a}}]),t}(),C=function(){function t(e,a,i){var n=this;_classCallCheck(this,t),this.appearance_id=e,this.appearance_label=a,this.updateActionText="Preview",this.updatingText="Updating&hellip;",this.$cmSection=$content.find("section.approved-cutie-mark"),this.previewUpdateInProgess=!1,this.previewUpdateRequest=null,this.$CMPreview=$.mk("ul").attr("class","dialog-preview"),this.$CMList=$.mk("ul").attr("class","cm-list"),this.$AddNewButton=$.mk("button").attr("class","green typcn typcn-plus").text("Add").on("click",function(e){e.preventDefault(),n.$CMList.append(t.crateCutiemarkDataLi())}),this.$UpdatePreviewButton=$.mk("button").attr("class","darkblue typcn typcn-arrow-sync").text(this.updateActionText).on("click",function(t){t.preventDefault(),n.updatePreview()}),this.$DeleteButton=$.mk("button").attr("class","red typcn typcn-trash").text("All").on("click",function(t){t.preventDefault(),n.deleteAction()}),this.$BottomActionGroup=$.mk("div").attr("class","btn-group").append(this.$AddNewButton,this.$UpdatePreviewButton),this.$form=$.mk("form","cm-data-editor").append(this.$CMPreview,this.$CMList,this.$BottomActionGroup).on("submit",function(t){t.preventDefault(),n.cancelPreviewUpdateRequest();var a=n.$form.mkData();c&&(a.APPEARANCE_PAGE=!0),$.Dialog.wait(!1,"Saving cutie mark data"),$.post(d+"/cg/appearance/setcms/"+e+s,a,$.mkAjaxHandler(function(t){if(!t.status)return $.Dialog.fail(!1,t.message);$.Dialog.close(),n.$cmSection.length&&(n.$cmSection.children(":not(h2,p)").remove(),n.$cmSection.removeClass("hidden").append(t.html))}))}).on("change input",".rotation-range",function(t){var e=$(t.target),a=e.val();e.prev().children(".rotation-display").text(a)}),i.cms.length?($.each(i.cms,function(e,a){n.$CMList.append(t.crateCutiemarkDataLi(e,a))}),this.$CMPreview.html(i.preview),this.previewUpdated(),this.updateRanges(),this.$BottomActionGroup.append(this.$DeleteButton)):this.$CMList.append(t.crateCutiemarkDataLi(0))}return _createClass(t,[{key:"getForm",value:function(){return this.$form}},{key:"cancelPreviewUpdateRequest",value:function(){!1!==this.previewUpdateInProgess&&(this.previewUpdateRequest.abort(),this.previewUpdateInProgess=!1)}},{key:"updatePreview",value:function(){var t=this;this.cancelPreviewUpdateRequest();var e=this.$form.mkData();this.$UpdatePreviewButton.disable().html(this.updatingText),this.$CMPreview.addClass("loading"),this.previewUpdateRequest=$.post(d+"/cg/appearance/getcmpreview/"+this.appearance_id+s,e,$.mkAjaxHandler(function(e){if(t.$UpdatePreviewButton.text(t.updateActionText).enable(),t.$CMPreview.removeClass("loading"),t.previewUpdateRequest=!1,!e.status)return $.Dialog.fail(!1,e.message);$.Dialog.clearNotice(/preview/),t.$CMPreview.html(e.html),t.previewUpdated()}))}},{key:"deleteAction",value:function(){var t=this;this.cancelPreviewUpdateRequest(),$.Dialog.close(function(){$.Dialog.confirm("Delete Cutie Marks of "+t.appearance_label,"Are you sure you want to remove the cutie mark(s) associated with this appearance?",function(e){e&&($.Dialog.wait(!1,"Sending removal request"),$.post(d+"/cg/appearance/delcms/"+t.appearance_id+s,$.mkAjaxHandler(function(e){if(!e.status)return $.Dialog.fail(!1,e.message);t.$cmSection.length&&t.$cmSection.addClass("hidden").children(":not(h2,p)").remove(),$.Dialog.close()})))})})}},{key:"previewUpdated",value:function(){this.$CMPreviewImages=this.$CMPreview.find(".img"),this.updateRanges()}},{key:"updateRange",value:function(t){var e=$.Event("change");e.target=t,this.$form.trigger(e)}},{key:"updateRanges",value:function(){var t=this;this.$CMList.find(".rotation-range").each(function(e,a){t.updateRange(a)})}}],[{key:"crateCutiemarkDataLi",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};void 0===e.facing&&(e.facing="right");var a={facing:e.id?"facing-"+e.id:$.randomString(),attribution:e.id?"attribution-"+e.id:$.randomString()},i=$.mk("div").attr("class","disabled-show").html('<p>Body orientation</p>\n\t\t\t\t<div class="radio-group orientation">\n\t\t\t\t\t<label><input type="radio" name="'+a.facing+'" value="left" required><span>Left</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+a.facing+'" value="right" required><span>Right</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+a.facing+'" value="" required><span>Symmetrical</span></label>\n\t\t\t\t</div>');i.find("input[value='"+(e.facing||"")+"']").prop("checked",!0);var n=void 0!==e.favme_rotation?e.favme_rotation:0,o=($.mk("fieldset").html('<legend>Attribution</legend>\n\t\t\t\t<div class="radio-group orientation">\n\t\t\t\t\t<label><input type="radio" name="'+a.attribution+'" value="none" required><span>None</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+a.attribution+'" value="user" required><span>User</span></label>\n\t\t\t\t\t<label><input type="radio" name="'+a.attribution+'" value="deviation" required><span>Deviation</span></label>\n\t\t\t\t</div>\n\t\t\t\t<div class="label">\n\t\t\t\t</div>'),$.mk("button").attr("class","btn red typcn typcn-trash").html("Remove").on("click",function(t){t.preventDefault();var e=$(t.target);e.closest("li").addClass("faded").find("input:not(:disabled), select:not(:disabled)").disable().addClass("fade-disabled"),e.addClass("hidden").next().removeClass("hidden")})),r=$.mk("button").attr("class","btn green typcn typcn-arrow-back hidden").html("Restore").on("click",function(t){t.preventDefault();var e=$(t.target);e.closest("li").removeClass("faded").find(".fade-disabled").enable().removeClass("fade-disabled"),e.addClass("hidden").prev().removeClass("hidden")});return $.mk("li").attr("id",e.id).append($.mk("fieldset").append($.mk("legend").append("<span>"+(void 0!==e.id?"Cutie Mark #"+e.id:"New Cutie Mark")+"</span>",o,r),i,$.mk("label").append("<span>Deviation link</span>",$.mk("input").attr({type:"url",name:"favme[]",required:!0}).val(e.favme?"http://fav.me/"+e.favme:void 0)),$.mk("div").attr("class","label disabled-show").append("<span>Preview rotation: <span class='rotation-display'>"+n+"</span></span>",$.mk("input").attr({type:"range",name:"favme_rotation[]",min:-45,max:45,step:1,class:"rotation-range",required:!0}).val(n))))}},{key:"factory",value:function(e,a,i,n){$.Dialog.request(e,new t(a,i,n).getForm(),"Save")}}]),t}(),A=void 0;window.ctxmenus=function(){e()},m.on("page-switch",a),a(),$(".cg-export").on("click",function(){$.mk("form").attr({method:"POST",action:"/cg/export",target:"_blank"}).html($.mk("input").attr("name","CSRF_TOKEN").val($.getCSRFToken())).appendTo($body).submit().remove()}),$(".cg-reindex").on("click",function(){$.Dialog.confirm("Re-index all appearances","Wipe and rebuild ElasticSearch index?",function(t){t&&($.Dialog.wait(!1),$.post("/cg/reindex",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,this.message,!0)})))})}),$(".cg-sprite-colors").on("click",function(){$.Dialog.confirm($(this).text(),"Run a check on all sprites & look for missing colors?",function(t){t&&($.Dialog.wait(!1,"Checking all sprite colors (this might take a while)"),$.post("/cg/sprite-color-checkup",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);$.Dialog.success(!1,this.message,!0)})))})})});
//# sourceMappingURL=/js/min/pages/colorguide/manage.js.map
