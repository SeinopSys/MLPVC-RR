DocReady.push(function(){"use strict";function e(){var e,t,i=$(".episode").find(".showplayers").on("scroll-video-into-view",function(){var e=$header.outerHeight();$.scrollTo(t.offset().top-($w.height()-$footer.outerHeight()-e-t.outerHeight())/2-e,500)}),n=i.parent();i.length&&i.on("click",function(a){if(a.preventDefault(),"undefined"==typeof t)$.Dialog.wait(i.text()),$.post("/episode/videos/"+l,$.mkAjaxHandler(function(){return this.status?(2===this[0]&&(e=$.mk("button").attr("class","blue typcn typcn-media-fast-forward").text("Part 2").on("click",function(){$(this).toggleHtml(["Part 1","Part 2"]),t.children().toggle()}),n.append(e)),t=$.mk("div").attr("class","resp-embed-wrap").html(this[1]).insertAfter(n),i.removeClass("typcn-eye green").addClass("typcn-eye-outline blue").text("Hide on-site player").triggerHandler("scroll-video-into-view"),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}));else{var s=i.hasClass("typcn-eye");t[s?"show":"hide"](),e instanceof jQuery&&e.attr("disabled",!s),i.toggleClass("typcn-eye typcn-eye-outline").toggleHtml(["Show on-site player","Hide on-site player"]),s&&i.triggerHandler("scroll-video-into-view")}})}function t(e,l,d){e.children("button.reserve-request").off("click").on("click",function(i){i.preventDefault();var n="Reserving request",a=function(i){$.Dialog.wait(n,"Sending reservation to the server"),$.post("/reserving/request/"+l,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var i=$(this.li);e.replaceWith(i),i.rebindFluidbox(),window.updateTimes(),t(i,l,d),$.Dialog.close()}))};if("undefined"!=typeof o&&i.shiftKey){var s=$.mk("form").attr("id","reserve-as").append($.mk("label").append("<span>Reserve as</span>",$.mk("input").attr({type:"text",name:"post_as",placeholder:"Username"}).patternAttr(o)));$.Dialog.request(n,s,"reserve-as","Reserve",function(e){e.on("submit",function(t){t.preventDefault(),a(e.mkData())})})}else a({})}),e.children("em").children("a:not(.da-userlink)").on("click",function(e){e.preventDefault(),e.stopPropagation(),history.replaceState(history.state,"",this.href),n()});var c=e.find(".actions").children();c.filter(".cancel").off("click").on("click",function(){$.Dialog.confirm("Cancel reservation","Are you sure you want to cancel this reservation?",function(i){i&&($.Dialog.wait(!1,"Cancelling reservation"),$.post("/reserving/"+d+"/"+l+"?cancel",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.remove===!0)return $.Dialog.close(),e.remove();var i=$(this.li);e.replaceWith(i),i.rebindFluidbox(),window.updateTimes(),t(i,l,d),$.Dialog.close()})))})}),c.filter(".finish").off("click").on("click",function(){$.Dialog.request("Finish reservation",'<form id="finish-res"><input type="text" name="deviation" placeholder="Deviation URL" required></form>',"finish-res","Finish",function(e){e.on("submit",function(t){t.preventDefault();var n=e.find("[name=deviation]").val();if("string"!=typeof n||0===n.length)return $.Dialog.fail(!1,"Please enter a deviation URL");$.Dialog.wait(!1,"Marking reservation as finished");var o="/reserving/"+d+"/"+l+"?finish";$.post(o,{deviation:n},$.mkAjaxHandler(function(){var e=this,t=function(){$.Dialog.success(!1,"Reservation has been marked as finished"),i(d,a,s,function(){"string"==typeof e.message?$.Dialog.success(!1,e.message,!0):$.Dialog.close()})};e.status?t():e.retry?$.Dialog.confirm(!1,e.message,["Continue","Cancel"],function(i){i&&$.post(o,{deviation:n,allow_overwrite_reserver:!0},$.mkAjaxHandler(function(){return this.status?(e=this,void t()):$.Dialog.fail(!1,this.message)}))}):$.Dialog.fail(!1,e.message)}))})})}),c.filter(".unfinish").off("click").on("click",function(){var e=$(this),t=e.hasClass("delete-only"),n=$.capitalize(d),o=d.replace(/s$/,"");$.Dialog.request((t?"Delete":"Un-finish")+" "+o,'<form id="unbind-check"><p>Are you sure you want to '+(t?"delete this reservation":"mark this "+o+" as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind '+o+" from user</label></form>","unbind-check","Un-finish",function(){var e=$("#unbind-check"),o=e.find("[name=unbind]");t||e.prepend('<div class="notice info">By removing the "finished" flag, the post will be moved back to the "List of '+n+'" section</div>'),"reservation"===d?(o.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),t&&o.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(t?"reservation was added directly, it cannot be marked un-finished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),$w.trigger("resize"),e.on("submit",function(e){e.preventDefault();var t=o.prop("checked");$.Dialog.wait(!1,'Removing "finished" flag'+(t?" & unbinding from user":"")),$.post("/reserving/"+d+"/"+l+"?unfinish"+(t?"&unbind":""),$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,"undefined"!=typeof this.message?this.message:'"finished" flag removed successfully'),void i(d,a,s)):$.Dialog.fail(!1,this.message)}))})})}),c.filter(".check").off("click").on("click",function(e){e.preventDefault();var t=$(this);$.Dialog.wait("Submission approval status","Checking"),$.post("/reserving/"+d+"/"+l+"?lock",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);t.closest("li").children(".image").children("a").append($.mk("span").attr({"class":"typcn typcn-tick",title:"This submission has been accepted into the group gallery"}));var e;this.canedit&&(e=t.siblings(".edit").detach(),e.text(e.attr("title")).removeAttr("title")),t.parent().html(this.canedit?e:""),this.message?$.Dialog.success(!1,this.message,!0):$.Dialog.close()}))}),c.filter(".delete").on("click",function(){var e=$(this);$.Dialog.confirm("Deleteing request","You are about to permanently delete this request.<br>Are you sure about this?",function(t){t&&($.Dialog.wait(!1,"Sending deletion request"),$.post("/reserving/request/"+l+"?delete",$.mkAjaxHandler(function(){return this.status?($.Dialog.close(),void e.closest("li").fadeOut(1e3,function(){$(this).remove()})):$.Dialog.fail(!1,this.message)})))})}),c.filter(".edit").on("click",function(){var e=$(this),t=e.parents("li"),n=t.attr("id").split("-"),o=n[1],l=n[0];$.Dialog.wait("Editing "+l+" #"+o,"Retrieving "+l+" details"),$.post("/post/get-"+l+"/"+o,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this,n=$.mk("form").attr("id","post-edit-form").append($.mk("label").append($.mk("span").text("Description (3-255 chars."+("reservation"===l?", optional":"")+")"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{3,255}$",name:"label",required:"reservation"!==l})));"request"===l&&n.append($.mk("label").append($.mk("span").text("Request type"),$.mk("select").attr({name:"type",required:!0}).append($.mk("option").attr("value","chr").text("Character"),$.mk("option").attr("value","obj").text("Object"),$.mk("option").attr("value","bg").text("Backgound")))),"string"==typeof e.posted&&n.append($.mk("label").append($.mk("span").text("Post timestamp"),$.mk("input").attr({type:"datetime",name:"date",required:!0,spellcheck:!1}))),"string"==typeof e.reserved_at&&n.append($.mk("label").append($.mk("span").text("Reserved at"),$.mk("input").attr({type:"datetime",name:"reserved_at",required:!0,spellcheck:!1})));var d=0===t.children(".image").find(".typcn-tick").length,c="finished"===t.closest("div").attr("class"),u=c?t.children(".original"):t.children(".image").children("a"),p=u.attr("href"),f=!r.test(p)&&/deviantart\.net\//.test(p);(d||f)&&n.append($.mk("label").append(d?$.mk("a").text("Update Image").attr({href:"#update","class":"btn darkblue typcn typcn-pencil"}).on("click",function(e){e.preventDefault(),$.Dialog.close();var n=t.children(".image").find("img"),r=$.mk("form").attr("id","img-update-form").append($.mk("div").attr("class","align-center").append($.mk("span").text("Current image"),n.clone()),$.mk("label").append($.mk("span").text("New image URL"),$.mk("input").attr({type:"text",maxlength:255,pattern:"^.{2,255}$",name:"image_url",required:!0,autocomplete:"off",spellcheck:"false"})));$.Dialog.request("Update image of "+l+" #"+o,r,"img-update-form","Update",function(e){e.on("submit",function(t){t.preventDefault();var n=e.mkData();$.Dialog.wait(!1,"Replacing image"),$.post("/post/set-"+l+"-image/"+o,n,$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,"Image has been updated"),void i(l,a,s)):$.Dialog.fail(!1,this.message)}))})})}):void 0,f?$.mk("a").text("Sta.sh fullsize fix").attr({href:"#fix-stash-fullsize","class":"btn orange typcn typcn-spanner"}).on("click",function(e){e.preventDefault(),$.Dialog.close(),$.Dialog.wait("Fix Sta.sh fullsize URL","Fixing Sta.sh full size image URL"),$.post("/post/fix-"+l+"-stash/"+o,$.mkAjaxHandler(function(){if(!this.status){if(this.rmdirect){if(!c)return t.find(".post-date").children("a").first().triggerHandler("click"),$.Dialog.fail(!1,this.message+"<br>The post might be broken because of this, please check it for any issues.");t.children(".original").remove()}return $.Dialog.fail(!1,this.message)}u.attr("href",this.fullsize),$.Dialog.success(!1,"Fix successful",!0)}))}):void 0)),$.Dialog.request(!1,n,"post-edit-form","Save",function(i){var n,a,s=i.find("[name=label]"),r=i.find("[name=type]");if(e.label&&s.val(e.label),e.type&&r.children("option").filter(function(){return this.value===e.type}).attr("selected",!0),"string"==typeof e.posted){n=i.find("[name=date]");var d=moment(e.posted);n.val(d.format("YYYY-MM-DDTHH:mm:ssZ"))}if("string"==typeof e.reserved_at){a=i.find("[name=reserved_at]");var c=moment(e.reserved_at);a.val(c.format("YYYY-MM-DDTHH:mm:ssZ"))}i.on("submit",function(i){i.preventDefault();var d={label:s.val()};if("request"===l&&(d.type=r.val()),"string"==typeof e.posted){if(d.posted=new Date(n.val()),isNaN(d.posted.getTime()))return $.Dialog.fail(!1,"Post timestamp is invalid");d.posted=d.posted.toISOString()}if("string"==typeof e.reserved_at){if(d.reserved_at=new Date(a.val()),isNaN(d.reserved_at.getTime()))return $.Dialog.fail(!1,"Reserved at timestamp is invalid");d.reserved_at=d.reserved_at.toISOString()}$.Dialog.wait(!1,"Saving changes"),$.post("/post/set-"+l+"/"+o,d,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);if(this.label){var e=t.children(".label");e.length||$.mk("span").attr("class","lebel").insertAfter(t.children(".image")),t.children(".label").text(this.label)}if(this.type&&!t.parent().parent().hasClass("finished")){var i=$("#group-"+this.type).children("ul"),n=function(e){return new Date($(e).children("em").find("time").attr("datetime")).getTime()};i.append(t),i.children().sort(function(e,t){return n(e)-n(t)}).appendTo(i)}this.posted&&(t.children(".post-date").find("time").attr("datetime",this.posted),window.updateTimes()),this.reserved_at&&(t.children(".reserve-date").find("time").attr("datetime",this.reserved_at),window.updateTimes()),$.Dialog.close()}))})})}))}),c.filter(".share").on("click",function(){var e=$(this),t=e.parents("li").children(".post-date").children("a").first().prop("href");$.Dialog.info("Sharing "+d+" #"+l,$.mk("div").attr("class","align-center").append("Use the link below to link to this post directly:",$.mk("div").attr("class","share-link").text(t),$.mk("button").attr("class","blue typcn typcn-clipboard").text("Copy to clipboard").on("click",function(e){$.copy(t,e)})))})}function i(e,t,i,n){var a=$.capitalize(e),s=e.replace(/([^s])$/,"$1s");$.Dialog.wait(a,"Updating list",!0),$.post("/episode/"+s+"/S"+t+"E"+i,$.mkAjaxHandler(function(){if(!this.status)return window.location.reload();var t=$("#"+s),i=$(this.render).filter("section").children();t.empty().append(i).rebindHandlers(),t.find(".post-form").attr("data-type",e).formBind(),window.updateTimes(),"function"==typeof n?n():$.Dialog.close()}))}function n(e){$(".highlight").removeClass("highlight");var t=$(location.hash);t.length&&(t.addClass("highlight"),setTimeout(function(){$.scrollTo(t.offset().top-$navbar.outerHeight()-10,500,function(){"object"==typeof e&&"load"===e.type&&$.Dialog.close()})},1))}var a=window.SEASON,s=window.EPISODE,o=window.USERNAME_REGEX,r=window.FULLSIZE_MATCH_REGEX,l="S"+a+"E"+s,d=$content.children("section.episode");$("#video").on("click",function(){$.Dialog.wait("Set video links","Requesting links from the server"),$.post("/episode/getvideos/"+l,$.mkAjaxHandler(function(){var t=this;if(!t.status)return $.Dialog.fail(!1,t.message);var i=$.mk("input").attr({type:"url","class":"yt",name:"yt_1",placeholder:"YouTube",spellcheck:"false",autocomplete:"off"}),n=$.mk("input").attr({type:"url","class":"dm",name:"dm_1",placeholder:"Dailymotion",spellcheck:"false",autocomplete:"off"}),a=$.mk("form").attr("id","vidlinks").attr("class","align-center").append($.mk("p").text("Enter vido links below, leave any input blank to remove that video from the episode page."),i.clone(),n.clone());if(t.twoparter){$.mk("p").html("<strong>~ Part 1 ~</strong>").insertBefore(a.children("input").first());var s={$yt:i.clone().attr("name","yt_2"),$dm:n.clone().attr("name","dm_2")};a.append($.mk("p").text("Check below if either link contains the full episode instead of just one part"),$.mk("div").append("<label><input type='checkbox' name='yt_1_full'> YouTube</label> &nbsp; <label><input type='checkbox' name='dm_1_full'> Dailymotion</label>"),$.mk("p").html("<strong>~ Part 2 ~</strong>"),s.$yt,s.$dm),a.find('input[type="checkbox"]').on("change",function(){s["$"+$(this).attr("name").replace(/^([a-z]+)_.*$/,"$1")].attr("disabled",this.checked)}),t.fullep.length>0&&$.each(t.fullep,function(e,t){a.find('input[type="checkbox"]').filter('[name="'+t+'_1_full"]').prop("checked",!0).trigger("change")})}if(Object.keys(t.vidlinks).length>0){var o=a.children("input");$.each(t.vidlinks,function(e,t){o.filter("[name="+e+"]").val(t)})}$.Dialog.request(!1,a,"vidlinks","Save",function(i){if(t.airs&&new Date(t.airs).getTime()>(new Date).getTime()){var n=$.mk("div").addClass("notice warn").text("If you add this video now, it will be shown as a livestream link!");i.append(n),i.on("change keydown","input",function(){setTimeout(function(){var e=i.mkData(),t=e.yt_1&&e.yt_1_full&&!(e.dm_1||e.dm_2);n[t?"show":"hide"]()},1)}).triggerHandler("change")}i.on("submit",function(t){t.preventDefault();var n=i.mkData();$.Dialog.wait(!1,"Saving links"),$.post("/episode/setvideos/"+l,n,$.mkAjaxHandler(function(){return this.status?(this.epsection?(d.length||(d=$.mk("section").addClass("episode").insertBefore($content.children("section").first())),d.html($(this.epsection).filter("section").html()),e()):d.length&&(d.remove(),d={length:0}),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))});var c=$content.children("section.appearances");$("#cg-relations").on("click",function(){$.Dialog.wait("Guide relation editor","Retrieving relations from server"),$.post("/episode/getcgrelations/"+l,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=this,t=$.mk("form").attr("id","guide-relation-editor"),i=$.mk("select").attr({name:"listed",multiple:!0}),n=$.mk("select").attr("multiple",!0);e.linked&&e.linked.length&&$.each(e.linked,function(e,t){i.append($.mk("option").attr("value",t.id).text(t.label))}),e.unlinked&&e.unlinked.length&&$.each(e.unlinked,function(e,t){n.append($.mk("option").attr("value",t.id).text(t.label))}),t.append($.mk("div").attr("class","split-select-wrap").append($.mk("div").attr("class","split-select").append("<span>Linked</span>",i),$.mk("div").attr("class","buttons").append($.mk("button").attr({"class":"typcn typcn-chevron-left green",title:"Link selected"}).on("click",function(e){e.preventDefault(),i.append(n.children(":selected").prop("selected",!1)).children().sort(function(e,t){return e.innerHTML.localeCompare(t.innerHTML)}).appendTo(i)}),$.mk("button").attr({"class":"typcn typcn-chevron-right red",title:"Unlink selected"}).on("click",function(e){e.preventDefault(),n.append(i.children(":selected").prop("selected",!1)).children().sort(function(e,t){return e.innerHTML.localeCompare(t.innerHTML)}).appendTo(n)})),$.mk("div").attr("class","split-select").append("<span>Available</span>",n))),$.Dialog.request(!1,t,"guide-relation-editor","Save",function(e){e.on("submit",function(e){e.preventDefault();var t=[];i.children().each(function(e,i){t.push(i.value)}),$.Dialog.wait(!1,"Saving changes"),$.post("/episode/setcgrelations/"+l,{ids:t.join(",")},$.mkAjaxHandler(function(){return this.status?(this.section?(c.length||(c=$.mk("section").addClass("appearances").insertBefore($content.children(".admin"))),c.html($(this.section).filter("section").html())):c.length&&(c.remove(),c={length:0}),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))}),$("#edit-about_reservations, #edit-reservation_rules").on("click",function(e){e.preventDefault();var t=$(this).parent(),i=t.clone(),n=this.id.replace(/^.*-/,"");i.children().remove();var a=i.text().trim();$.Dialog.wait('Editing "'+a+'"',"Retrieving setting's value"),$.post("/setting/get/"+n,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("form").attr("id",n+"-editor").append($.mk("label").append($.mk("span").text(a),$.mk("textarea").attr({name:"value"}).val(this.value)));$.Dialog.request(!1,e,e.attr("id"),"Save",function(e){e.on("submit",function(i){i.preventDefault();var a=e.mkData();$.Dialog.wait(!1,"Saving"),$.post("/setting/set/"+n,a,$.mkAjaxHandler(function(){return this.status?(t.siblings().remove(),t.parent().append(this.value),void $.Dialog.close()):$.Dialog.fail(!1,this.message)}))})})}))}),e();var u=$("#voting");if(u.on("click",".rate",function(e){e.preventDefault();var t=function(e){return $.mk("label").append($.mk("input").attr({type:"radio",name:"vote",value:e}),$.mk("span")).on("mouseenter mouseleave",function(e){var t=$(this),i=t.parent().find("input:checked"),n=i.parent(),a=t.closest("div").next().children("strong");switch(e.type){case"mouseleave":if(0===n.length){t.siblings().addBack().find(".typcn").attr("class",""),a.text("?");break}t=n;case"mouseenter":t.prevAll().addBack().children("span").attr("class","active"),t.nextAll().children("span").attr("class",""),a.text(t.children("input").attr("value"))}t.siblings().addBack().removeClass("selected"),n.addClass("selected")})},i=$.mk("form").attr("id","star-rating").append($.mk("p").text("Rate the episode on a scale of 1 to 5. This cannot be changed later."),$.mk("div").attr("class","rate").append(t(1),t(2),t(3),t(4),t(5)),$.mk("p").css("font-size","1.1em").append("Your rating: <strong>?</strong>/5")),n=u.children(".rate");$.Dialog.request("Rating "+l,i,"star-rating","Rate",function(e){e.on("submit",function(t){t.preventDefault();var i=e.mkData();return"undefined"==typeof i.vote?$.Dialog.fail(!1,"Please choose a rating by clicking on one of the muffins"):($.Dialog.wait(!1,"Submitting your rating"),void $.post("/episode/vote/"+l,i,$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=n.closest("section");e.children("h2").nextAll().remove(),e.append(this.newhtml),u.bindDetails(),$.Dialog.close()})))})})}),u.find("time").data("dyntime-beforeupdate",function(e){return e.past===!0?u.children(".rate").length?void 0:($.post("/episode/vote/"+l+"?html",$.mkAjaxHandler(function(){return this.status?(u.children("h2").nextAll().remove(),u.append(this.html),void u.bindDetails()):$.Dialog.fail("Display voting buttons",this.message)})),$(this).removeData("dyntime-beforeupdate"),!1):void 0}),$.fn.bindDetails=function(){$(this).find("a.detail").on("click",function(e){e.preventDefault(),$.Dialog.wait("Voting details","Getting vote distribution information"),$.post("/episode/vote/"+l+"?detail",$.mkAjaxHandler(function(){if(!this.status)return $.Dialog.fail(!1,this.message);var e=$.mk("canvas").css({width:200,height:200,display:"block",margin:"0 auto"}),t=e.get(0).getContext("2d"),i=$.mk("p").attr("class","tooltip").html("&nbsp;");$.Dialog.info(!1,[$.mk("p").text("Here's a chart showing how the votes are distributed."),$.mk("div").attr("id","vote-distrib").append(e,i)]);var n=[void 0,"#FF5454","#FFB554","#FFFF54","#8CD446","#4DC742"],a=this.data,s=0;return $.each(a,function(e,t){$.extend(a[e],{color:n[parseInt(t.label,10)]}),s+=parseInt(t.value,10)}),0===s?(e.remove(),void i.text("There are no votes for this episode yet")):void new Chart(t).Pie(a,{animationEasing:"easeInOutExpo",customTooltips:function(e){if(!e)return void i.css("color","").html("&nbsp;");var t=e.text.split(": "),a=Math.round(parseInt(t[1],10)/s*1e3)/10;i.css("color",n[parseInt(t[0],10)]).empty().append($.mk("span").text(t[1]+" ×"),$.mk("span").attr("class","muffins cnt-"+t[0]),$.mk("span").text("("+a+"%)"))}})}))})},u.bindDetails(),$.fn.rebindFluidbox=function(){$(this).find(".screencap > a").fluidbox({immediateOpen:!0,loader:!0}).on("openstart.fluidbox",function(){$body.addClass("no-distractions")}).on("closestart.fluidbox",function(){$body.removeClass("no-distractions")})},$.fn.rebindHandlers=function(){return this.find("li[id]").each(function(){var e=$(this),i=parseInt(e.attr("id").replace(/\D/g,"")),n=e.closest("section[id]").attr("id").replace(/s$/,"");t(e,i,n)}),this.closest("section").find(".unfinished").rebindFluidbox(),this},$("#requests, #reservations").rebindHandlers(),$.fn.formBind=function(){function e(e){var t=c.data("prev-url"),i="string"==typeof t&&t.trim()===c.val().trim();if(o.attr("disabled",e===!0||i),e===!0||i?o.attr("title","You need to change the URL before chacking again."):o.removeAttr("title"),"keyup"===e.type){var n=c.val();v.test(n)&&c.val(c.val().replace(v,""))}}function t(){var t=c.val(),i=g+" process";o.removeClass("red"),e(!0),$.Dialog.wait(i,"Checking image"),$.post("/post",{image_url:t},$.mkAjaxHandler(function(){function e(a,s){$.Dialog.wait(i,"Checking image availability"),h.attr("src",a.preview).show().off("load error").on("load",function(){p.children("p:not(.keep)").remove(),c.data("prev-url",t),a.title&&!u.val().trim()?$.Dialog.confirm("Confirm "+m+" title",'The image you just checked had the following title:<br><br><p class="align-center"><strong>'+a.title+"</strong></p><br>Would you like to use this as the "+m+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===m?"being requested":"you plan to vector")+".<p>This dialog will not appear if you give your "+m+" a description before clicking the "+k+" button.</p>",function(e){return e?(u.val(a.title),void $.Dialog.close()):n.find("input[name=label]").focus()}):$.Dialog.close(function(){n.find("input[name=label]").focus()})}).on("error",function(){return 1>s?($.Dialog.wait("Can't load image","Image could not be loaded, retrying in 2 seconds"),void setTimeout(function(){e(a,s+1)},2e3)):void $.Dialog.fail(i,"There was an error while attempting to load the image. Make sure the URL is correct and try again!")})}var a=this;return a.status?void e(a,0):(p.children("p:not(.keep)").remove(),p.prepend($.mk("p").attr("class","color-red").html(a.message)).show(),h.hide(),$.Dialog.close())}))}var n=$(this),o=n.find(".check-img"),r=n.find(".img-preview"),d=n.find("[name=label]"),c=n.find("[name=image_url]"),u=n.find("[name=label]"),p=r.children(".notice"),f=p.html(),h=r.children("img"),m=n.attr("data-type"),g=$.capitalize(m);0===h.length&&(h=$(new Image).appendTo(r)),$("#"+m+"-btn").on("click",function(){n.is(":visible")||(n.show(),d.focus(),$.scrollTo(n.offset().top-$navbar.outerHeight()-10,500))}),"reservation"===m&&$("#add-reservation-btn").on("click",function(){$.Dialog.request("Add a reservation",'<form id="add-reservation"><div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div><div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"add-reservation","Finish",function(e){e.on("submit",function(t){t.preventDefault();var n=e.find("[name=deviation]").val();return"string"!=typeof n||0===n.length?$.Dialog.fail(!1,"Please enter a deviation URL"):($.Dialog.wait(!1,"Adding reservation"),void $.post("/reserving/reservation?add="+l,{deviation:n},$.mkAjaxHandler(function(){return this.status?($.Dialog.success(!1,this.message),void i(m,a,s)):$.Dialog.fail(!1,this.message)})))})})}),c.on("keyup change paste",e);var v=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,k='<strong class="typcn typcn-arrow-repeat" style="display:inline-block">Check image</strong>';o.on("click",function(e){e.preventDefault(),t()}),n.on("submit",function(e,t,o){e.preventDefault();var r=g+" process";if(!t&&c.data("prev-url")!==c.val())return $.Dialog.confirm(r,"You modified the image URL without clicking the "+k+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&n.triggerHandler("submit",[!0])});if("undefined"==typeof c.data("prev-url"))return $.Dialog.fail(r,"Please click the "+k+" button before submitting your "+m+"!");if(!o&&"request"===m){var l=d.val(),u=n.find("select");if(l.indexOf("character")>-1&&"chr"!==u.val())return $.Dialog.confirm(r,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){u.focus()}):n.triggerHandler("submit",[t,!0])})}var p=n.mkData({what:m,episode:s,season:a,image_url:c.data("prev-url")});!function f(){$.Dialog.wait(r,"Submitting "+m),$.post("/post",p,$.mkAjaxHandler(function(){if(!this.status)return this.canforce?$.Dialog.confirm(!1,this.message,["Go ahead","Nevermind"],function(e){e&&(p.allow_nonmember=!0,f())}):$.Dialog.fail(!1,this.message);var e=this.id;i(m,a,s,function(){$.Dialog.close(),$("#"+m+"-"+e).find("em.post-date").children("a").triggerHandler("click")})}))}()}).on("reset",function(){o.attr("disabled",!1).addClass("red"),p.html(f).show(),h.hide(),c.removeData("prev-url"),$(this).hide()})},$(".post-form").each($.fn.formBind),$w.on("hashchange",n),location.hash.length){var p=$content.find("img"),f=p.length,h=0;if(f>0&&$(location.hash).length>0){$.Dialog.wait("Scroll post into view","Waiting for page to load");var m=$.mk("progress").attr({max:f,value:0}).css({display:"block",width:"100%",marginTop:"5px"});$("#dialogContent").children("div:not([id])").last().addClass("align-center").append(m),$content.imagesLoaded().progress(function(e,t){t.isLoaded?m.attr("value",++h):m.attr("max",--f)}).always(function(){n({type:"load"})})}}});
//# sourceMappingURL=episode.min.js.map
