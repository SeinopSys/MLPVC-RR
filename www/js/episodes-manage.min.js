$(function(){function e(e){return 10>e?"0"+e:e}function t(e){return $.each(e,function(t,i){e[t]=parseInt(i,10)}),e}function i(e){var i=t(e.split("-"));return i[1]--,i}function a(e){return t(e.split(":"))}function n(e,t,n){var r=i(e),o=a(t),s=new Date(r[0],r[1],r[2],10);return s["set"+(n?"UTC":"")+"Hours"](o[0]),s["set"+(n?"UTC":"")+"Minutes"](o[1]),s}function r(e){var t=$(document.createElement("form")).attr("id",e).html('<div class=input-group><input type="number" min=1 max=8 name=season placeholder="Season #" required><input type="number" min=1 max=26 name=episode placeholder="Episode #" required></div>\r\n			<label><input type="text" maxlength=255 name=title placeholder=Title pattern="'+h+'" autocomplete=off required></label>\r\n			<div class="notice info align-center">\r\n				<p><strong>Title</strong> must be between 5 and 35 characters.<br>Letters, numbers, and these characters, are allowed:<br>-, apostrophe, !, &, comma.</p>\r\n			</div>\r\n			<div class=input-group><input type="date" name=airdate placeholder="YYYY-MM-DD" required><input type="time" name=airtime placeholder="HH:MM" required></div>\r\n			<div class="notice info align-center button-here">\r\n				<p>Specify when the episode will air,<br>in <strong>your computer\'s timezone</strong>.</p>\r\n			</div>\r\n			<label><input type="checkbox" name=twoparter> Has two parts</label>\r\n			<div class="notice info align-center">\r\n				<p>If this is checked, only specify<br>the episode number of the first part</p>\r\n			</div>');return $(document.createElement("button")).text("Set time to "+u+" this Sunday").addClass("setsunday").on("click",function(e){e.preventDefault(),$(this).parent().prev().children().first().val(p).next().val(u)}).appendTo(t.children(".button-here")),t}function o(e){"string"==typeof e&&(l.html(e),l.children(".empty").length?m.html(m.data("none")).next().show():m.html(m.data("list")).next().hide()),("string"==typeof e||this.init===!0)&&l.children().children(":last-child").children("time.nodt").each(function(){this.innerHTML=new Date($(this).attr("datetime")).toLocaleString()}),s.find("tr[data-epid]").each(function(){var e=$(this),t=e.attr("data-epid");e.removeAttr("data-epid").data("epid",t)}),s.find(".edit-episode").off("click").on("click",function(e){e.preventDefault();var t=$(this),i=t.closest("tr").data("epid"),a="Editing "+i;$.Dialog.wait(a,"Getting episode details from server"),$.ajax({method:"POST",url:"/episode/"+i,success:function(e){if("object"!=typeof e)return console.log(e)&&$w.trigger("ajaxerror");if(e.status){var t=D.clone(!0,!0);t.find("input[name=twoparter]").prop("checked",!!e.ep.twoparter),delete e.ep.twoparter;var i=n(e.ep.airdate,e.ep.airtime,!0);e.ep.airdate=i.toAirDate(),e.ep.airtime=i.toAirTime();var r=e.epid;delete e.epid,$.each(e.ep,function(e,i){t.find("input[name="+e+"]").val(i)}),$.Dialog.request("Editing",t,"editep","Save",function(){$("#editep").on("submit",function(e){e.preventDefault();var t=$(this).serializeArray(),i={};$.each(t,function(e,t){i[t.name]=t.value});var s=n(i.airdate,i.airtime);delete i.airdate,delete i.airtime,i.airs=s.toISOString(),$.Dialog.wait(a,"Saving edits"),$.ajax({method:"POST",url:"/episode/edit/"+r,data:i,success:function(e){return"object"!=typeof e?console.log(e)&&$w.trigger("ajaxerror"):void(e.status?(o(e.tbody),$.Dialog.close()):$.Dialog.fail(a,e.message))}})})})}else $.Dialog.fail(a,e.message)}})}),s.find(".delete-episode").off("click").on("click",function(e){e.preventDefault();var t=$(this),i=t.closest("tr").data("epid"),a="Deleting "+i;$.Dialog.confirm(a,"<p>This will remove <strong>ALL</strong><ul><li>requests</li><li>reservations</li><li>and votes</li></ul>associated with the episode, too.</p><p>Are you sure you want to delete it?</p>",function(e){e&&($.Dialog.wait(a),$.ajax({method:"POST",url:"/episode/delete/"+i,success:function(e){return"object"!=typeof e?console.log(e)&&$w.trigger("ajaxerror"):void(e.status?(o(e.tbody),$.Dialog.close()):$.Dialog.fail(a,e.message))}}))})})}var s=$("#episodes"),l=s.children("tbody");o.call({init:!0});var d=new Date,c=new Date(d.getTime());c.setDate(c.getDate()+6-c.getDay()),c.setUTCHours(15),c.setUTCMinutes(30),Date.prototype.toAirDate=function(){return e(this.getFullYear())+"-"+e(this.getMonth()+1)+"-"+e(this.getDate())},Date.prototype.toAirTime=function(){return e(this.getHours())+":"+e(this.getMinutes())};var p=c.toAirDate(),u=c.toAirTime(),f=window.EP_TITLE_REGEX,h=f.toString().split("/")[1],g=$("#content"),m=g.children("h1"),v=new r("addep"),D=new r("editep");$("#add-episode").on("click",function(e){e.preventDefault();var t="Add Episode";$.Dialog.request(t,v.clone(!0,!0),"addep","Add",function(){$("#addep").on("submit",function(e){e.preventDefault();var i={};i.airs=n($airdate.attr("disabled",!0).val(),$airtime.attr("disabled",!0).val()).toISOString();var a=$(this).serializeArray();$.each(a,function(e,t){i[t.name]=t.value}),$.Dialog.wait(t,"Adding episode to database"),$.ajax({method:"POST",url:"/episode/add",data:i,success:function(e){return"object"!=typeof e?console.log(e)&&$w.trigger("ajaxerror"):void(e.status?(o(e.tbody),$.Dialog.close()):$.Dialog.fail(t,e.message))}})})})})});