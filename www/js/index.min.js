$(function(){function e(t,a,i){t.find("button.reserve-request").off("click").on("click",function(){var r=$(this),o="Reserving request";$.Dialog.wait(o,"Sending reservation to the server"),$.ajax({method:"POST",url:"/reserving/request/"+a,success:function(n){return"object"!=typeof n?console.log(n)&&$w.trigger("ajaxerror"):void(n.status?($.Dialog.close(),$(n.btnhtml).insertAfter(r),e(t,a,i),r.remove()):$.Dialog.fail(o,n.message))}})}),t.find(".reserver-actions .typcn-times").off("click").on("click",function(){var r=$(this),o="Cancel reservation";$.Dialog.confirm(o,"Are you sure you want to cancel this reservation?",function(n){n&&($.Dialog.wait(o,"Cancelling reservation"),$.ajax({method:"POST",url:"/reserving/"+i+"/"+a+"?cancel",success:function(n){if("object"!=typeof n)return console.log(n)&&$w.trigger("ajaxerror");if(n.status){if($.Dialog.close(),n.remove===!0)return r.closest("li").remove();$(n.btnhtml).insertBefore(r.parent().prev()),r.parent().prev().remove(),r.parent().remove(),e(t,a,i)}else $.Dialog.fail(o,n.message)}}))})})}var t=$(document.body),a=$("header nav"),i=window.SEASON,r=window.EPISODE;$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){t.addClass("no-distractions")}).on("closestart",function(){t.removeClass("no-distractions")}),$("#requests").find("li[id]").each(function(){{var e=$(this);parseInt(e.attr("id").replace(/\D/g,""))}}),$("#requests, #reservations").find("li[id]").each(function(){var t=$(this),a=parseInt(t.attr("id").replace(/\D/g,"")),i=t.closest("section[id]").attr("id");e(t,a,i)}),$(".post-form").each(function(){function e(e){var t=c.data("prev-url"),a="string"==typeof t&&t===c.val().trim();n.attr("disabled",e===!0||a),e===!0||a?n.attr("title","You need to change the URL before chacking again."):n.removeAttr("title")}var o=$(this),n=o.find(".check-img"),s=o.find(".img-preview"),c=o.find("[name=image_url]"),l=o.find("[name=label]"),u=s.children(".notice"),d=u.html(),f=s.children("img"),g=o.data("type"),v=g.charAt(0).toUpperCase()+g.substring(1);0===f.length&&(f=$(new Image).appendTo(s)),$("#"+g+"-btn").on("click",function(){o.is(":visible")||(o.show(),c.focus(),t.animate({scrollTop:o.offset().top+a.outerHeight()},1e3,"easeOutQuint"))}),c.on("keyup change paste",e),n.on("click",function(t){t.preventDefault(),n.removeClass("red"),e(!0);var a=c.val();$.ajax({method:"POST",url:"/post",data:{image_url:a},success:function(e){return"object"!=typeof e?console.log(e)&&$w.trigger("ajaxerror"):void(e.status?f.attr("src",e.preview).show().on("load",function(){u.hide(),c.data("prev-url",a),e.title&&!l.val().trim()&&l.val(e.title)}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image.<br>Make sure the URL is correct and try again!")}):(n.attr("disabled",!1),u.html(e.message).show(),f.hide()))}})}),o.on("submit",function(e){e.preventDefault(),$.Dialog.wait(v,"Submitting "+g);var t=o.serializeArray(),a={what:g,episode:r,season:i};$.each(t,function(e,t){a[t.name]=t.value}),$.ajax({method:"POST",url:"/post",data:a,success:function(e){return"object"!=typeof e?console.log(e)&&$w.trigger("ajaxerror"):void(e.status?($.Dialog.success(v,e.message),setTimeout(function(){window.location.reload()},1e3)):$.Dialog.fail(v,e.message))}})}).on("reset",function(){n.attr("disabled",!1).addClass("red"),u.html(d).show(),f.hide(),c.removeData("prev-url"),$(this).hide()})})});