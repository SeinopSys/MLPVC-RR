$(function(){function e(t,o,r){t.children("button.reserve-request").off("click").on("click",function(){var i=$(this),a="Reserving request";$.Dialog.wait(a,"Sending reservation to the server"),$.post("/reserving/request/"+o,function(s){return"object"!=typeof s?console.log(s)&&n.trigger("ajaxerror"):void(s.status?($.Dialog.close(),i.nextAll().remove(),$(s.btnhtml).insertAfter(i),e(t,o,r),i.remove()):$.Dialog.fail(a,s.message))})}),t.children("button.delete").on("click",function(){var e=$(this),t="Deleteing request";$.Dialog.confirm(t,"You are about to permanently delete this request.<br>Are you sure about this?",function(i){i&&$.post("/reserving/request/"+o+"?delete",function(i){return"object"!=typeof i?console.log(i)&&n.trigger("ajaxerror"):void(i.status?($.Dialog.close(),e.closest("li").remove()):$.Dialog.fail(t,i.message))})})});var a=t.find(".reserver-actions").children();a.filter(".cancel").off("click").on("click",function(){var i=$(this),a="Cancel reservation";$.Dialog.confirm(a,"Are you sure you want to cancel this reservation?",function(s){s&&($.Dialog.wait(a,"Cancelling reservation"),$.post("/reserving/"+r+"/"+o+"?cancel",function(s){if("object"!=typeof s)return console.log(s)&&n.trigger("ajaxerror");if(s.status){if($.Dialog.close(),s.remove===!0)return t.remove();i.parent().prev().nextAll().addBack().remove(),$(s.btnhtml).appendTo(t),e(t,o,r)}else $.Dialog.fail(a,s.message)}))})}),a.filter(".finish").off("click").on("click",function(){var e="Finish reservation";$.Dialog.request(e,'<form id="finish-res"><div class="notice fail"><label>Error</label><p></p></div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"finish-res","Finish",function(){var t=$("#finish-res"),a=t.find(".notice p");a.parent().hide(),t.on("submit",function(c){c.preventDefault();var d=t.find("[name=deviation]").val(),u=function(e){a.html(e.message).parent().show(),n.trigger("resize"),t.find("input").attr("disabled",!1)};try{if("string"!=typeof d||0===d.length)throw new Error("Please enter a deviation URL");$.post("/reserving/"+r+"/"+o+"?finish",{deviation:d},function(t){return"object"!=typeof t?console.log(t)&&n.trigger("ajaxerror"):void(t.status?i.call({callback:function(){"string"==typeof t.message?$.Dialog.success(e,t.message,!0):$.Dialog.close()}},r,s,l):u(t))})}catch(c){u(c)}})})}),a.filter(".unfinish").off("click").on("click",function(){var e=$(this),t=e.hasClass("delete-only"),a=(t?"Delete":"Un-finish")+" reservation",c=r.charAt(0).toUpperCase()+r.substring(1);$.Dialog.request(a,'<form id="unbind-check"><p>Are you sure you want to '+(t?"delete this reservation":"mark this reservation as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind reservation from user</label></form>',"unbind-check","Un-finish",function(){var e=$("#unbind-check"),d=e.find("[name=unbind]");t||e.prepend('<div class="notice info">By removing the "finished" flag, the deviation will be moved back to the "List of '+c+'" section</div>'),"reservations"===r?(d.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),t&&d.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(t?"reservation was added directly, it cannot be marked un-finished, only deleted.":"is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards. If left unchecked, only the current reserver <em>(and Vector Inspectors)</em> will be able to mark it as finished until the reservation is cancelled.</div>'),n.trigger("resize"),e.on("submit",function(e){e.preventDefault();var t=d.prop("checked");$.Dialog.wait(a,'Removing "finished" flag'+(t?" & unbinding from user":"")),$.post("/reserving/"+r+"/"+o+"?unfinish"+(t?"&unbind":""),function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?($.Dialog.success(a,"undefined"!=typeof e.message?e.message:'"finished" flag removed successfully'),i(r,s,l)):$.Dialog.fail(a,e.message))})})})})}function t(){function e(e){var t=f.data("prev-url"),i="string"==typeof t&&t.trim()===f.val().trim();if(a.attr("disabled",e===!0||i),e===!0||i?a.attr("title","You need to change the URL before chacking again."):a.removeAttr("title"),"keyup"===e.type){var n=f.val();y.test(n)&&f.val(f.val().replace(y,""))}}var t=this instanceof jQuery?this:$(this),a=t.find(".check-img"),d=t.find(".img-preview"),u=t.find("[name=label]"),f=t.find("[name=image_url]"),g=t.find("[name=label]"),h=d.children(".notice"),v=h.html(),p=d.children("img"),m=t.data("type"),b=m.charAt(0).toUpperCase()+m.substring(1);0===p.length&&(p=$(new Image).appendTo(d)),$("#"+m+"-btn").on("click",function(){t.is(":visible")||(t.show(),u.focus(),o.animate({scrollTop:t.offset().top-r.outerHeight()-10},500))}),"reservation"===m&&$("#add-reservation-btn").on("click",function(){var e="Add a reservation";$.Dialog.request(e,'<form id="add-reservation"><div class="notice fail"><label>Error</label><p></p></div><div class="notice info">This feature should only be used when the vector was made before the episode was displayed here, and all you want to do is link your already-made vector under the newly posted episode.</div><div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"add-reservation","Finish",function(){var t=$("#add-reservation"),o=t.find(".notice.fail").hide().children("p");t.on("submit",function(r){r.preventDefault();var a=t.find("[name=deviation]").val(),d=function(e){o.html(e.message).parent().show(),n.trigger("resize"),t.find("input").attr("disabled",!1)};try{if("string"!=typeof a||0===a.length)throw new Error("Please enter a deviation URL");$.post("/reserving/reservation?add="+c,{deviation:a},function(t){return"object"!=typeof t?console.log(t)&&n.trigger("ajaxerror"):void(t.status?($.Dialog.success(e,t.message),i(m,s,l)):d(t))})}catch(r){d(r)}})})}),f.on("keyup change paste",e);var y=/^https?:\/\/www\.deviantart\.com\/users\/outgoing\?/,w='<strong class="typcn typcn-arrow-repeat">Check image</strong>';a.on("click",function(i){i.preventDefault(),a.removeClass("red"),e(!0);var o=f.val();$.ajax({method:"POST",url:"/post",data:{image_url:o},success:function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?p.attr("src",e.preview).show().on("load",function(){h.hide(),f.data("prev-url",o),e.title&&!g.val().trim()&&$.Dialog.confirm("Confirm "+m+" title","The image you just checked had the following title:<br><br><p class=align-center><strong>"+e.title+"</strong></p><br>Would you like to use this as the "+m+"'s description?<br>Keep in mind that it should describe the thing(s) "+("request"===m?"being requested":"you plan to vector")+".<br>This dialog will not appear if you give your "+m+" a description before clicking the "+w+" button.",function(i){return i?(g.val(e.title),void $.Dialog.close()):t.find("input[name=label]").focus()})}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image. Make sure the URL is correct and try again!")}):(h.html(e.message).show(),p.hide()))}})}),t.on("submit",function(e,o,r){if(e.preventDefault(),!o&&f.data("prev-url")!==f.val())return $.Dialog.confirm(title,"You modified the image URL without clicking the "+w+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&t.triggerHandler("submit",[!0])});if("undefined"==typeof f.data("prev-url"))return $.Dialog.fail(b,"Please click the "+w+" button before submitting your "+m+"!");if(!r&&"request"===m){var a=u.val(),c=t.find("select");if(a.indexOf("character")>-1&&"chr"!==c.val())return $.Dialog.confirm(b,"Your request label contains the word \"character\", but the request type isn't set to Character.<br>Are you sure you're not requesting one (or more) character(s)?",["Let me change the type","Carray on"],function(e){return e?void $.Dialog.close(function(){c.focus()}):t.triggerHandler("submit",[o,!0])})}$.Dialog.wait(b,"Submitting "+m);var d=t.serializeArray(),g={what:m,episode:l,season:s};d.image_url=f.data("prev-url"),$.each(d,function(e,t){g[t.name]=t.value}),$.post("/post",g,function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?i(m,s,l):$.Dialog.fail(b,e.message))})}).on("reset",function(){a.attr("disabled",!1).addClass("red"),h.html(v).show(),p.hide(),f.removeData("prev-url"),$(this).hide()})}function i(e,i,o){var r=e.charAt(0).toUpperCase()+e.substring(1),a=this;$.Dialog.wait(r,"Updating list"),$.post("/episode/"+e.replace(/([^s])$/,"$1s")+"/S"+i+"E"+o,function(i){if("object"!=typeof i)return console.log(i)&&n.trigger("ajaxerror");if(i.status){var o=$(i.render);t.call($("#"+e.replace(/([^s])$/,"$1s")).html(o.filter("section").html()).rebindHandlers().find(".post-form").data("type",e)),window.updateTimesF(),console.log(a),"object"==typeof a&&"function"==typeof a.callback?a.callback():$.Dialog.close()}else window.location.reload()})}var n=$(window),o=$(document.body),r=$("header nav"),a=$("#content"),s=window.SEASON,l=window.EPISODE,c="S"+s+"E"+l;$("#export").on("click",function(){var e="Exporting posts";$.post("/episode/export/"+c,function(t){return"object"!=typeof t?console.log(t)&&n.trigger("ajaxerror"):void(t.status?$.Dialog.info(e,'<p>Here\'s the code you need to paste into the journal while in<br><em>HTML editing mode</em>, replacing what was there previously.</p><textarea style="display:block;margin:0 auto;resize:none;width:90%"></textarea>',function(){$("#dialogContent").find("textarea").val(t["export"]).focus(function(){$(this).select()}).focus().mouseup(function(){return!1})}):$.Dialog.fail(e,t.message))})}),$("#video").on("click",function(){$.post("/episode/getvideos/"+c,function(e){if("object"!=typeof e)return console.log(e)&&n.trigger("ajaxerror");var t="Video links";$.Dialog.request(t,'<form id=vidlinks><input type="text" name="yt" placeholder="YouTube"><input type="text" name="dm" placeholder="Dailymotion"></form>',"vidlinks","Save",function(){var i=$("#vidlinks"),o=i.find("[name=yt]"),r=i.find("[name=dm]");e.yt&&o.val(e.yt),e.dm&&r.val(e.dm),i.on("submit",function(e){e.preventDefault(),$.Dialog.wait(t,"Saving links"),$.post("/episode/setvideos/"+c,{yt:o.val(),dm:r.val()},function(e){if("object"!=typeof e)return console.log(e)&&n.trigger("ajaxerror");if(e.status){var i=a.children("section.episode");e.epsection?(i.length||(i=$(document.createElement("section")).addClass("episode").insertBefore(a.children("section").first())),i.html($(e.epsection).filter("section").html())):i.length&&i.remove(),$.Dialog.close()}else $.Dialog.fail(t,e.message)})})})})});var d=$("#voting"),u=d.find("button");d.on("click","button",function(e){e.preventDefault();var t=$(this),i=t.siblings("button").addBack(),o=t.hasClass("green")?1:-1,r=""+c,a=(o>0?"Up":"Down")+"voting "+r;i.attr("disabled",!0),$.post("/episode/vote/"+r,{vote:o},function(e){if("object"!=typeof e)return console.log(e)&&n.trigger("ajaxerror");if(e.status){$.Dialog.close();var o=t.closest("section");o.children("h2").nextAll().remove(),o.append(e.newhtml)}else $.Dialog.fail(a,e.message),i.attr("disabled",!1)})}),d.find("time").data("dyntime-beforeupdate",function(e){return e.past===!0?u.length?void 0:($.post("/episode/vote/"+c+"?html",function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?(d.children("h2").nextAll().remove(),d.append(e.html)):$.Dialog.fail("Display voting buttons",e.message))}),$(this).removeData("dyntime-beforeupdate"),!1):void 0}),$.fn.rebindHandlers=function(){var t=$(this);return t.find("li[id]").each(function(){var t=$(this),i=parseInt(t.attr("id").replace(/\D/g,"")),n=t.closest("section[id]").attr("id");$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){o.addClass("no-distractions")}).on("closestart",function(){o.removeClass("no-distractions")}),e(t,i,n)}),t},$("#requests, #reservations").rebindHandlers(),$(".post-form").each(function(){t.call(this)})});
//# sourceMappingURL=index.min.js.map