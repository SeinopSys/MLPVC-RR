$(function(){function e(t,r,o){t.find("button.reserve-request").off("click").on("click",function(){var i=$(this),a="Reserving request";$.Dialog.wait(a,"Sending reservation to the server"),$.ajax({method:"POST",url:"/reserving/request/"+r,success:function(s){return"object"!=typeof s?console.log(s)&&n.trigger("ajaxerror"):void(s.status?($.Dialog.close(),$(s.btnhtml).insertAfter(i),e(t,r,o),i.remove()):$.Dialog.fail(a,s.message))}})});var l=t.find(".reserver-actions").children();l.filter(".cancel").off("click").on("click",function(){var i=$(this),a="Cancel reservation";$.Dialog.confirm(a,"Are you sure you want to cancel this reservation?",function(s){s&&($.Dialog.wait(a,"Cancelling reservation"),$.post("/reserving/"+o+"/"+r+"?cancel",{},function(s){if("object"!=typeof s)return console.log(s)&&n.trigger("ajaxerror");if(s.status){if($.Dialog.close(),s.remove===!0)return i.closest("li").remove();$(s.btnhtml).insertBefore(i.parent().prev()),i.parent().prev().remove(),i.parent().remove(),e(t,r,o)}else $.Dialog.fail(a,s.message)}))})}),l.filter(".finish").off("click").on("click",function(){var e="Finish reservation";$.Dialog.request(e,'<form id="finish-res"><div class="notice fail"><label>Error</label><p></p></div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"finish-res","Finish",function(){var t=$("#finish-res"),l=t.find(".notice p");l.parent().hide(),t.on("submit",function(c){c.preventDefault();var d=t.find("[name=deviation]").val(),f=function(e){l.html(e.message).parent().show(),n.trigger("resize"),t.find("input").attr("disabled",!1)};try{if("string"!=typeof d||0===d.length)throw new Error("Please enter a deviation URL");$.post("/reserving/"+o+"/"+r+"?finish",{deviation:d},function(t){return"object"!=typeof t?console.log(t)&&n.trigger("ajaxerror"):void(t.status?($.Dialog.success(e,"The "+o+" is now marked as finished"),i(o,a,s)):f(t))})}catch(e){f(e)}})})}),l.filter(".unfinish").off("click").on("click",function(){var e=$(this),t=e.hasClass("delete-only"),l=(t?"Delete":"Un-finish")+" reservation",c=o.charAt(0).toUpperCase()+o.substring(1);$.Dialog.request(l,'<form id="unbind-check"><p>Are you sure you want to '+(t?"delete this reservation":"mark this reservation as unfinished")+'?</p><hr><label><input type="checkbox" name="unbind"> Unbind reservation from user</label></form>',"unbind-check","Un-finish",function(){var e=$("#unbind-check"),d=e.find("[name=unbind]");t||e.prepend('<div class="notice info">By removing the "finished" flag, the deviation will be moved back<br>to the "List of '+c+'" section</div>'),"reservations"===o?(d.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")}),t&&d.trigger("click").off("click").on("click keydown touchstart",function(){return!1}).css("pointer-events","none").parent().hide(),e.append('<div class="notice warn">Because this '+(t?"reservation was added directly,<br>it cannot be marked un-finished, only deleted.":"is a reservation, unbinding<br>it from the user will <strong>delete</strong> it permanently.")+"</div>")):e.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards.<br>If left unchecked, only the current reserver <em>(and Vector Inspectors)</em><br>will be able to mark it as finished until the reservation is cancelled.</div>'),n.trigger("resize"),e.on("submit",function(e){e.preventDefault();var t=d.prop("checked");$.Dialog.wait(l,'Removing "finished" flag'+(t?" & unbinding from user":"")),$.post("/reserving/"+o+"/"+r+"?unfinish"+(t?"&unbind":""),{},function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?($.Dialog.success(l,"undefined"!=typeof e.message?e.message:'"finished" flag removed successfully'),i(o,a,s)):$.Dialog.fail(l,e.message))})})})})}function t(){function e(e){var t=d.data("prev-url"),i="string"==typeof t&&t.trim()===d.val().trim();l.attr("disabled",e===!0||i),e===!0||i?l.attr("title","You need to change the URL before chacking again."):l.removeAttr("title")}var t=this instanceof jQuery?this:$(this),l=t.find(".check-img"),c=t.find(".img-preview"),d=t.find("[name=image_url]"),f=t.find("[name=label]"),u=c.children(".notice"),h=u.html(),v=c.children("img"),g=t.data("type"),p=g.charAt(0).toUpperCase()+g.substring(1);0===v.length&&(v=$(new Image).appendTo(c)),$("#"+g+"-btn").on("click",function(){t.is(":visible")||(t.show(),d.focus(),r.animate({scrollTop:t.offset().top-o.outerHeight()-10},500))}),"reservation"===g&&$("#add-reservation-btn").on("click",function(){var e="Add a reservation";$.Dialog.request(e,'<form id="add-reservation"><div class="notice fail"><label>Error</label><p></p></div><div class="notice info">This feature should only be used when the vector was made before the episode was displayed here,<br>and all you want to do is link your already-made vector under the newly posted episode.</div><div class="notice warn">If you already posted the reservation, use the <strong class="typcn typcn-attachment">I\'m done</strong> button to mark it as finished instead of adding it here.</div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"add-reservation","Finish",function(){var t=$("#add-reservation"),r=t.find(".notice p");r.parent().hide(),t.on("submit",function(o){o.preventDefault();var l=t.find("[name=deviation]").val(),c=function(e){r.html(e.message).parent().show(),n.trigger("resize"),t.find("input").attr("disabled",!1)};try{if("string"!=typeof l||0===l.length)throw new Error("Please enter a deviation URL");$.post("/reserving/reservation?add=S"+a+"E"+s,{deviation:l},function(t){return"object"!=typeof t?console.log(t)&&n.trigger("ajaxerror"):void(t.status?($.Dialog.success(e,t.message),i(g,a,s)):c(t))})}catch(e){c(e)}})})}),d.on("keyup change paste",e),l.on("click",function(t){t.preventDefault(),l.removeClass("red"),e(!0);var i=d.val();$.ajax({method:"POST",url:"/post",data:{image_url:i},success:function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?v.attr("src",e.preview).show().on("load",function(){u.hide(),d.data("prev-url",i),e.title&&!f.val().trim()&&f.val(e.title)}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image.<br>Make sure the URL is correct and try again!")}):(u.html(e.message).show(),v.hide()))}})});var m='<strong class="typcn typcn-arrow-repeat">Check image</strong>';t.on("submit",function(e,r){if(e.preventDefault(),!r&&d.data("prev-url")!==d.val())return $.Dialog.confirm(title,"You modified the image URL without clicking the "+m+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&t.trigger("submit",[!0])});if("undefined"==typeof d.data("prev-url"))return $.Dialog.fail(p,"Please click the "+m+" button before submitting your "+g+"!");$.Dialog.wait(p,"Submitting "+g);var o=t.serializeArray(),l={what:g,episode:s,season:a};o.image_url=d.data("prev-url"),$.each(o,function(e,t){l[t.name]=t.value}),$.post("/post",l,function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?i(g,a,s):$.Dialog.fail(p,e.message))})}).on("reset",function(){l.attr("disabled",!1).addClass("red"),u.html(h).show(),v.hide(),d.removeData("prev-url"),$(this).hide()})}function i(e,i,r){var o=e.charAt(0).toUpperCase()+e.substring(1);$.Dialog.wait(o,"Updating list"),$.post("/episode/"+e.replace(/([^s])$/,"$1s")+"/S"+i+"E"+r,{},function(i){if("object"!=typeof i)return console.log(i)&&n.trigger("ajaxerror");if(i.status){var r=$(i.render);t.call($("#"+e.replace(/([^s])$/,"$1s")).html(r.filter("section").html()).rebindHandlers().find(".post-form").data("type",e)),$.Dialog.close()}else window.location.reload()})}var n=$(window),r=$(document.body),o=$("header nav"),a=window.SEASON,s=window.EPISODE;$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){r.addClass("no-distractions")}).on("closestart",function(){r.removeClass("no-distractions")}),$.fn.rebindHandlers=function(){var t=$(this);return t.find("li[id]").each(function(){var t=$(this),i=parseInt(t.attr("id").replace(/\D/g,"")),n=t.closest("section[id]").attr("id");e(t,i,n)}),t},$("#requests, #reservations").rebindHandlers(),$(".post-form").each(function(){t.call(this)})});