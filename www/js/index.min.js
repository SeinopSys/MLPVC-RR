$(function(){function e(i,r,o){i.find("button.reserve-request").off("click").on("click",function(){var n=$(this),a="Reserving request";$.Dialog.wait(a,"Sending reservation to the server"),$.ajax({method:"POST",url:"/reserving/request/"+r,success:function(s){return"object"!=typeof s?console.log(s)&&t.trigger("ajaxerror"):void(s.status?($.Dialog.close(),$(s.btnhtml).insertAfter(n),e(i,r,o),n.remove()):$.Dialog.fail(a,s.message))}})}),i.find(".reserver-actions .typcn-times").off("click").on("click",function(){var n=$(this),a="Cancel reservation";$.Dialog.confirm(a,"Are you sure you want to cancel this reservation?",function(s){s&&($.Dialog.wait(a,"Cancelling reservation"),$.ajax({method:"POST",url:"/reserving/"+o+"/"+r+"?cancel",success:function(s){if("object"!=typeof s)return console.log(s)&&t.trigger("ajaxerror");if(s.status){if($.Dialog.close(),s.remove===!0)return n.closest("li").remove();$(s.btnhtml).insertBefore(n.parent().prev()),n.parent().prev().remove(),n.parent().remove(),e(i,r,o)}else $.Dialog.fail(a,s.message)}}))})})}var t=$(window),i=$(document.body),r=$("header nav"),o=window.SEASON,n=window.EPISODE;$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){i.addClass("no-distractions")}).on("closestart",function(){i.removeClass("no-distractions")}),$.fn.rebindHandlers=function(){$(this).find("li[id]").each(function(){var t=$(this),i=parseInt(t.attr("id").replace(/\D/g,"")),r=t.closest("section[id]").attr("id");e(t,i,r)})},$("#requests, #reservations").rebindHandlers(),$(".post-form").each(function(){!function(e){function a(e){var t=c.data("prev-url"),i="string"==typeof t&&t.trim()===c.val().trim();s.attr("disabled",e===!0||i),e===!0||i?s.attr("title","You need to change the URL before chacking again."):s.removeAttr("title")}var s=e.find(".check-img"),l=e.find(".img-preview"),c=e.find("[name=image_url]"),u=e.find("[name=label]"),d=l.children(".notice"),f=d.html(),g=l.children("img"),h=e.data("type"),m=h.charAt(0).toUpperCase()+h.substring(1);0===g.length&&(g=$(new Image).appendTo(l)),$("#"+h+"-btn").on("click",function(){e.is(":visible")||(e.show(),c.focus(),i.animate({scrollTop:e.offset().top-r.outerHeight()-10},500))}),c.on("keyup change paste",a),s.on("click",function(e){e.preventDefault(),s.removeClass("red"),a(!0);var i=c.val();$.ajax({method:"POST",url:"/post",data:{image_url:i},success:function(e){return"object"!=typeof e?console.log(e)&&t.trigger("ajaxerror"):void(e.status?g.attr("src",e.preview).show().on("load",function(){d.hide(),c.data("prev-url",i),e.title&&!u.val().trim()&&u.val(e.title)}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image.<br>Make sure the URL is correct and try again!")}):(d.html(e.message).show(),g.hide()))}})});var v='<strong class="typcn typcn-arrow-repeat">Check image</strong>';e.on("submit",function(i,r){if(i.preventDefault(),!r&&c.data("prev-url")!==c.val())return $.Dialog.confirm("You modified the image URL without clicking the "+v+" button.<br>Do you want to continue with the last checked URL?",function(t){t&&e.trigger("submit",[!0])});if("undefined"==typeof c.data("prev-url"))return $.Dialog.fail(m,"Please click the "+v+" button before submitting your "+h+"!");$.Dialog.wait(m,"Submitting "+h);var a=e.serializeArray(),s={what:h,episode:n,season:o};a.image_url=c.data("prev-url"),$.each(a,function(e,t){s[t.name]=t.value}),$.post("/post",s,function(e){return"object"!=typeof e?console.log(e)&&t.trigger("ajaxerror"):void(e.status?($.Dialog.wait(m,"Updating list"),$.post("/episode/"+h+"s/S"+o+"E"+n,{},function(e){if("object"!=typeof e)return console.log(e)&&t.trigger("ajaxerror");if(e.status){var i=$(e.render);console.log(i),$("#"+h+"s").html(i.filter("section").html()).rebindHandlers(),$.Dialog.close()}else window.location.reload()})):$.Dialog.fail(m,e.message))})}).on("reset",function(){s.attr("disabled",!1).addClass("red"),d.html(f).show(),g.hide(),c.removeData("prev-url"),$(this).hide()})}($(this))})});