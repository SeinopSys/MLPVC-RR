$(function(){function e(i,r,o){i.find("button.reserve-request").off("click").on("click",function(){var t=$(this),a="Reserving request";$.Dialog.wait(a,"Sending reservation to the server"),$.ajax({method:"POST",url:"/reserving/request/"+r,success:function(s){return"object"!=typeof s?console.log(s)&&n.trigger("ajaxerror"):void(s.status?($.Dialog.close(),$(s.btnhtml).insertAfter(t),e(i,r,o),t.remove()):$.Dialog.fail(a,s.message))}})});var l=i.find(".reserver-actions").children();l.filter(".cancel").off("click").on("click",function(){var t=$(this),a="Cancel reservation";$.Dialog.confirm(a,"Are you sure you want to cancel this reservation?",function(s){s&&($.Dialog.wait(a,"Cancelling reservation"),$.post("/reserving/"+o+"/"+r+"?cancel",{},function(s){if("object"!=typeof s)return console.log(s)&&n.trigger("ajaxerror");if(s.status){if($.Dialog.close(),s.remove===!0)return t.closest("li").remove();$(s.btnhtml).insertBefore(t.parent().prev()),t.parent().prev().remove(),t.parent().remove(),e(i,r,o)}else $.Dialog.fail(a,s.message)}))})}),l.filter(".finish").off("click").on("click",function(){var e="Finish reservation";$.Dialog.request(e,'<form id="finish-res"><div class="notice fail"><label>Error</label><p></p></div><input type="text" name="deviation" placeholder="Deviation URL"></form>',"finish-res","Finish",function(){var i=$("#finish-res"),l=i.find(".notice p");l.parent().hide(),i.on("submit",function(c){c.preventDefault();var f=i.find("[name=deviation]").val();try{if("string"!=typeof f||0===f.length)throw new Error("Please enter a deviation URL");$.post("/reserving/"+o+"/"+r+"?finish",{deviation:f},function(i){if("object"!=typeof i)return console.log(i)&&n.trigger("ajaxerror");if(!i.status)throw new Error(i.message);$.Dialog.success(e,"The "+o+" is now marked as finished"),t(o,a,s)})}catch(e){l.text(e.message).parent().show(),i.find("input").attr("disabled",!1)}})})}),l.filter(".unfinish").off("click").on("click",function(){var e="Un-finish reservation",i=o.charAt(0).toUpperCase()+o.substring(1);$.Dialog.request(e,'<form id="unbind-check"><div class="notice info">By removing the finished flag, the deviation will be moved back<br>to the "List of '+i+'" section</div><p>Are you sure you want to mark this reservation as unfinished?</p><hr><label><input type="checkbox" name="unbind"> Unbind reservation from user</label></form>',"unbind-check","Un-finish",function(){var i=$("#unbind-check"),l=i.find("[name=unbind]");"reservations"===o?(i.append('<div class="notice warn">Because this is a reservation, unbinding it from the user will <strong>delete</strong> it permanently.</div>'),l.on("click",function(){$("#dialogButtons").children().first().val(this.checked?"Delete":"Un-finish")})):i.append('<div class="notice info">If this is checked, any user will be able to reserve this request again afterwards.<br>If left unchecked, only the current reserver <em>(and Vector Inspectors)</em><br>will be able to mark it as finished until the reservation is cancelled.</div>'),i.on("submit",function(i){i.preventDefault();var c=l.prop("checked");$.Dialog.wait(e,'Removing "finished" flag'+(c?" & unbinding from user":"")),$.post("/reserving/"+o+"/"+r+"?unfinish"+(c?"&unbind":""),{},function(i){return"object"!=typeof i?console.log(i)&&n.trigger("ajaxerror"):void(i.status?($.Dialog.success("undefined"!=typeof i.message?i.message:'"finished" flag removed successfully'),t(o,a,s)):$.Dialog.fail(e,i.message))})})})})}function i(){function e(e){var i=f.data("prev-url"),t="string"==typeof i&&i.trim()===f.val().trim();l.attr("disabled",e===!0||t),e===!0||t?l.attr("title","You need to change the URL before chacking again."):l.removeAttr("title")}var i=this instanceof jQuery?this:$(this),l=i.find(".check-img"),c=i.find(".img-preview"),f=i.find("[name=image_url]"),u=i.find("[name=label]"),d=c.children(".notice"),h=d.html(),g=c.children("img"),v=i.data("type"),p=v.charAt(0).toUpperCase()+v.substring(1);0===g.length&&(g=$(new Image).appendTo(c)),$("#"+v+"-btn").on("click",function(){i.is(":visible")||(i.show(),f.focus(),r.animate({scrollTop:i.offset().top-o.outerHeight()-10},500))}),f.on("keyup change paste",e),l.on("click",function(i){i.preventDefault(),l.removeClass("red"),e(!0);var t=f.val();$.ajax({method:"POST",url:"/post",data:{image_url:t},success:function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?g.attr("src",e.preview).show().on("load",function(){d.hide(),f.data("prev-url",t),e.title&&!u.val().trim()&&u.val(e.title)}).on("error",function(){$.Dialog.fail("Can't load image","There was an error while attempting to load the image.<br>Make sure the URL is correct and try again!")}):(d.html(e.message).show(),g.hide()))}})});var m='<strong class="typcn typcn-arrow-repeat">Check image</strong>';i.on("submit",function(e,r){if(e.preventDefault(),!r&&f.data("prev-url")!==f.val())return $.Dialog.confirm("You modified the image URL without clicking the "+m+" button.<br>Do you want to continue with the last checked URL?",function(e){e&&i.trigger("submit",[!0])});if("undefined"==typeof f.data("prev-url"))return $.Dialog.fail(p,"Please click the "+m+" button before submitting your "+v+"!");$.Dialog.wait(p,"Submitting "+v);var o=i.serializeArray(),l={what:v,episode:s,season:a};o.image_url=f.data("prev-url"),$.each(o,function(e,i){l[i.name]=i.value}),$.post("/post",l,function(e){return"object"!=typeof e?console.log(e)&&n.trigger("ajaxerror"):void(e.status?t(v,a,s):$.Dialog.fail(p,e.message))})}).on("reset",function(){l.attr("disabled",!1).addClass("red"),d.html(h).show(),g.hide(),f.removeData("prev-url"),$(this).hide()})}function t(e,t,r){var o=e.charAt(0).toUpperCase()+e.substring(1);$.Dialog.wait(o,"Updating list"),$.post("/episode/"+e.replace(/([^s])$/,"$1s")+"/S"+t+"E"+r,{},function(t){if("object"!=typeof t)return console.log(t)&&n.trigger("ajaxerror");if(t.status){var r=$(t.render);i.call($("#"+e.replace(/([^s])$/,"$1s")).html(r.filter("section").html()).rebindHandlers().find(".post-form").data("type",e)),$.Dialog.close()}else window.location.reload()})}var n=$(window),r=$(document.body),o=$("header nav"),a=window.SEASON,s=window.EPISODE;$("section .unfinished .screencap > a").fluidbox({immediateOpen:!0}).on("openstart",function(){r.addClass("no-distractions")}).on("closestart",function(){r.removeClass("no-distractions")}),$.fn.rebindHandlers=function(){var i=$(this);return i.find("li[id]").each(function(){var i=$(this),t=parseInt(i.attr("id").replace(/\D/g,"")),n=i.closest("section[id]").attr("id");e(i,t,n)}),i},$("#requests, #reservations").rebindHandlers(),$(".post-form").each(function(){i.call(this)})});