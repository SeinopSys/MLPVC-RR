DocReady.push(function(){function t(t){t.children(".tag").sort(function(t,e){var a=/^.*typ-([a-z]+).*$/;return t=[t.className.replace(a,"$1"),t.innerHTML.trim()],e=[e.className.replace(a,"$1"),e.innerHTML.trim()],t[0]===e[0]?t[1].localeCompare(e[1]):t[0].localeCompare(e[0])}).appendTo(t)}function e(t,e){var a="Create new tag",n=t.closest("li"),r=t.closest("div:not([class])"),o=r.children(".tags"),s=n.attr("id").replace(/\D/g,""),l=r.children("strong").text().trim();$.Dialog.request(a,v.clone(!0,!0),"edit-tag","Create",function(t){var a=t.children(".notice").children("p"),n=function(){a.html(this.message).parent().removeClass("info").addClass("fail").show(),t.find("input, texarea").attr("disabled",!1),$.Dialog.center()};t.append($.mk("label").append($.mk("input").attr({type:"checkbox",name:"addto"}).val(s).prop("checked","string"==typeof e),document.createTextNode(' Add this tag to the appearance "'+l+'" after creation'))),"string"==typeof e&&t.find("input[name=name]").val(e),$.Dialog.center(),t.on("submit",function(e){e.preventDefault(),a.text("Creating tag...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/maketag",t.mkData(),$.mkAjaxHandler(function(){this.status?(this.tags&&(o.children("[data-hasqtip]").qtip("destroy",!0),o.html(this.tags),window.tooltips(),i()),$.Dialog.close()):n.call(this)}))})})}function a(t,e){var a=this;if("undefined"!=typeof e)if(e instanceof jQuery)var n=e.attr("id").substring(2),r=e.parents("li").attr("id").substring(1);else r=e;$.Dialog.request(t,x.clone(!0,!0),"cg-editor","Save",function(t){var o=t.children(".notice").children("p"),s=function(){o.html(this.message).parent().removeClass("info").addClass("fail").show(),t.find("input, texarea").attr("disabled",!1),$.Dialog.center()},l=t.find("input[name=label]"),c="object"==typeof a&&a.label&&a.Colors;c&&(l.val(a.label),t.trigger("render-color-inputs",[a.Colors])),t.on("submit",function(a){a.preventDefault();var p={label:l.val(),Colors:[]};return c||(p.ponyid=r),t.find(".clr").each(function(){var t=$(this),e=t.children(".clri");if(d.test(e.val())){var a=t.data("id"),i={hex:e.val().replace(d,"#$1").toUpperCase()};"undefined"!=typeof a&&(i.colorid=parseInt(a,10)),i.label=t.children(".clrl").val(),p.Colors.push(i)}}),0===p.Colors.length?s.call({message:"You need to have at least 1 valid color"}):(p.Colors=JSON.stringify(p.Colors),o.text("Saving changes...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),void $.post("/colorguide/"+(c?"set":"make")+"cg"+(c?"/"+n:""),p,$.mkAjaxHandler(function(){this.status?((this.cg||this.cgs)&&(this.cg?(e.children("[data-hasqtip]").qtip("destroy",!0),e.html(this.cg)):this.cgs&&$("#p"+r).find("ul.colors").html(this.cgs),window.tooltips(),i()),$.Dialog.close()):s.call(this)})))})})}function i(){q.children("span:not(.ctxmenu-bound)").ctxmenu([{text:"Edit tag",icon:"pencil",click:function(){var e=$(this),a=e.text().trim(),i=e.attr("class").match(/id-(\d+)(?:\s|$)/)[1],n="Editing tag: "+a;$.Dialog.wait(n,"Retrieveing tag details from server"),$.post("/colorguide/gettag/"+i,$.mkAjaxHandler(function(){var e=this;this.status?$.Dialog.request(n,v.clone(!0,!0),"edit-tag","Save",function(a){var n=a.children(".notice").children("p"),r=function(){n.html(this.message).parent().removeClass("info").addClass("fail").show(),a.find("input, texarea").attr("disabled",!1),$.Dialog.center()};a.find("input[name=type][value="+e.type+"]").prop("checked",!0),a.find("input[type=text][name], textarea[name]").each(function(){var t=$(this);t.val(e[t.attr("name")])}),a.on("submit",function(e){e.preventDefault(),n.text("Saving changes...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/settag/"+i,a.mkData(),$.mkAjaxHandler(function(){if(this.status){var e=$(".id-"+this.tid);e.qtip("destroy",!0),this.title?e.attr("title",this.title):e.removeAttr("title"),e.attr("class","tag id-"+this.tid+(this.type?" typ-"+this.type:"")).text(this.name).data("ctxmenu-items").eq(0).text("Tag: "+this.name),e.parent().each(function(){t($(this))}),window.tooltips(),$.Dialog.close()}else r.call(this)}))})}):$.Dialog.fail(n,this.message)}))}},{text:"Remove tag",icon:"minus",click:function(){var t=$(this),e=t.attr("class").match(/id-(\d+)(?:\s|$)/);if(!e)return!1;e=e[1];var a=t.closest("li").attr("id").replace(/\D/g,""),i=t.text().trim(),n="Remove tag: "+i;$.Dialog.confirm(n,"The tag "+i+" will be removed from this appearance.<br>Are you sure?",["Remove it","Nope"],function(i){i&&($.Dialog.wait(n,"Removing tag"),$.post("/colorguide/untag/"+a,{tag:e},$.mkAjaxHandler(function(){this.status?(t.qtip("destroy",!0),t.remove(),$.Dialog.close()):$.Dialog.fail(n,this.message)})))})}},{text:"Delete tag",icon:"trash",click:function(){var t=$(this),e=t.text().trim(),a=t.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Detele tag: "+e;$.Dialog.confirm(i,"Deleting this tag will also remove it from every appearance where it's been used.<br>Are you sure?",["Delete it","Nope"],function(t){t&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/deltag/"+a,$.mkAjaxHandler(function(){if(this.status){var t=$(".id-"+a);t.qtip("destroy",!0),t.remove(),$.Dialog.close()}else $.Dialog.fail(i,this.message)})))})}},!0,{text:"Create new tag",icon:"plus",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(t){return"Tag: "+t.text().trim()});var s=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"/colorguide/gettags?s=%QUERY",wildcard:"%QUERY"}}),l=[13,188];q.children(".addtag").each(function(){var t=$(this),a=t.parents("li").attr("id").substring(1);t.typeahead(null,{name:"tags",display:"name",source:s,templates:{suggestion:Handlebars.compile('<span class="tag id-{{tid}} {{type}}">{{name}}</span>')}}),t.on("keydown",function(n){if(-1!==l.indexOf(n.keyCode)){n.preventDefault();var r=t.val().trim(),o=t.parents(".tags"),s=o.children(".tag"),c="Adding tag: "+r;if(s.filter(function(){return this.innerHTML.trim()===r}).length>0)return $.Dialog.fail(c,"This appearance already has this tag");$.Dialog._focusedElement=t.attr("disabled",!0),t.parent().addClass("loading"),$.post("/colorguide/tag/"+a,{tag_name:r},$.mkAjaxHandler(function(){if(t.removeAttr("disabled").parent().removeClass("loading"),this.status)o.children("[data-hasqtip]").qtip("destroy",!0),o.children(".tag").remove(),o.append($(this.tags).filter("span")),window.tooltips(),i(),t.typeahead("val","").focus();else{if("string"==typeof this.cancreate){var a=this.cancreate;return c=c.replace(r,a),$.Dialog.confirm(c,this.message,function(i){i&&e(t,a)})}$.Dialog.fail(c,this.message)}}))}}),t.nextAll(".tt-menu").on("click",".tag",function(){t.trigger({type:"keydown",keyCode:13})})}),n=$("ul.colors:not(.static)").attr("data-color",o),n.filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Re-order "+o+" groups",icon:"arrow-unsorted",click:function(){var t=$(this),e=t.parents("li"),a=e.attr("id").substring(1),n=e.children().last().children("strong").text().trim(),r="Re-order "+o+" groups on appearance: "+n;$.Dialog.wait(r,"Retrieving color group list from server"),$.post("/colorguide/getcgs/"+a,$.mkAjaxHandler(function(){this.status||$.Dialog.fail(this.message);var e=f.clone(),n=$.mk("ol");$.each(this.cgs,function(t,e){n.append($.mk("li").attr("data-id",e.groupid).text(e.label))}),$.mk("div").attr("class","cgs").append('<p class="align-center">Drag to re-arrange</p>',n).prependTo(e),$.Dialog.center(),new Sortable(n.get(0),{ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.request(r,e,"cg-reorder","Save",function(e){var n=e.children(".notice").children("p"),r=function(){n.html(this.message).parent().removeClass("info").addClass("fail").show(),$.Dialog.center()};e.on("submit",function(o){o.preventDefault();var s={cgs:[]},l=e.children(".cgs");return l.length?(l.find("ol").children().each(function(){s.cgs.push($(this).attr("data-id"))}),s.cgs=s.cgs.join(","),n.text("Saving changes...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),void $.post("/colorguide/setcgs/"+a,s,$.mkAjaxHandler(function(){this.status?(t.html(this.cgs),window.tooltips(),i(),$.Dialog.close()):r.call(this)}))):r.call({message:"There are no color groups to re-order"})})})}))}},{text:"Create new group",icon:"folder-add",click:function(){a("Create color group",$(this).parents("li").attr("id").substring(1))}}],r+" groups"),n.children("li").filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Edit "+o+" group",icon:"pencil",click:function(){var t=$(this),e=t.closest("li"),i=e.attr("id").substring(2),n=t.children().first().text().replace(/:\s?$/,""),r="Editing "+o+" group: "+n;$.Dialog.wait(r,"Retrieving "+o+" group details from server"),$.post("/colorguide/getcg/"+i,$.mkAjaxHandler(function(){this.status?a.call(this,r,e):$.Dialog.fail(r,data.message)}))}},{text:"Delete "+o+" group",icon:"trash",click:function(){var t=$(this).closest("li"),e=t.attr("id").substring(2),a=t.children().first().text().replace(/:\s?$/,""),i="Delete "+o+" group: "+a;$.Dialog.confirm(i,"By deleting this "+o+" group, all "+o+"s within will be removed too.<br>Are you sure?",function(a){a&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/delcg/"+e,$.mkAjaxHandler(function(){this.status?(t.children("[data-hasqtip]").qtip("destroy",!0),t.remove(),$.Dialog.close()):$.Dialog.fail(i,this.message)})))})}},!0,{text:"Re-order "+o+" groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}}],function(t){return r+" group: "+t.children().first().text().trim().replace(":","")}),$.ctxmenu.addItems(n.children("li").children("span:not(:first-child)"),!0,{text:"Edit "+o+" group",icon:"pencil",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Delete "+o+" group",icon:"trash",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}},!0,{text:"Re-order "+o+" groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),3)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),4)}}),$(".upload-wrap").each(function(){var t=$(this),e=t.closest("li").attr("id").substring(1);t.uploadZone({requestKey:"sprite",title:"Upload sprite",accept:"image/png",target:"/colorguide/setsprite/"+e}).on("uz-uploadstart",function(){$.Dialog.close()}).ctxmenu([{text:"Open image in new tab",icon:"arrow-forward","default":!0,attr:{href:t.find("img").attr("src"),target:"_blank"}},{text:"Copy image URL",icon:"clipboard",click:function(){$.copy($.urlToAbsolute(t.find("img").attr("src")))}},{text:"Upload new sprite",icon:"upload",click:function(){var e="Upload sprite image",a=t.closest("li").attr("id").substring(1),i=t.find('input[type="file"]');$.Dialog.request(e,g.clone(),"sprite-img","Download image",function(t){var n=t.find("input[name=image_url]");t.find("a").on("click",function(t){t.preventDefault(),t.stopPropagation(),i.trigger("click",[!0])}),t.on("submit",function(t){t.preventDefault();var r=n.val();$.Dialog.wait(e,"Downloading external image to the server"),$.post("/colorguide/setsprite/"+a,{image_url:r},$.mkAjaxHandler(function(){this.status?i.trigger("set-image",[this.path]):$.Dialog.fail(e,this.message)}))})})}}],"Sprite image").attr("title",p?" ":"").on("click",function(e,a){return a===!0?!0:(e.preventDefault(),void t.data("ctxmenu-items").eq(1).children().get(0).click())})})}var n,r=window.Color,o=window.color,s=window.TAG_TYPES_ASSOC,l=window.MAX_SIZE,c=window.PRINTABLE_ASCII_REGEX,d=window.HEX_COLOR_PATTERN,p="WebkitAppearance"in document.documentElement.style,g=$.mk("form").attr("id","sprite-img").html('<p class="align-center"><a href="#upload">Click here to upload a file</a> (max. '+l+') or enter a URL below.</p><label><input type="text" name="image_url" placeholder="External image URL" required></label><p class="align-center">The URL will be checked against the supported provider list, and if an image is found, it\'ll be downloaded to the server and set as this appearance\'s sprite image.</p>'),u=$("#list"),m=$.mk("form").attr("id","pony-editor").append($.mk("label").append($.mk("span").text("Name (4-70 chars.)"),$.mk("input").attr({name:"label",placeholder:"Enter a name",pattern:c.replace("+","{4,70}"),required:!0,maxlength:70})),$.mk("label").append($.mk("span").text("Additional notes (255 chars. max, optional)"),$.mk("textarea").attr({name:"notes",maxlength:255})),$.mk("label").append($.mk("span").text("Link to cutie mark (optional)"),$.mk("input").attr({name:"cm_favme",placeholder:"DeviantArt submission URL"})),$.mk("div").attr("class","notice").hide().html("<p></p>")),h=function(t,e,a){var i=t.parent(),n=i.next();$.Dialog.request(e,m.clone(),"pony-editor","Save",function(t){var r=t.children(".notice").children("p"),o=function(){r.html(this.message).parent().removeClass("info").addClass("fail").show(),t.find("input, texarea").attr("disabled",!1),$.Dialog.center()},s=!!a;s?(t.find("input[name=label]").val(a.label),t.find("textarea").val(a.notes),t.find("input[name=cm_favme]").val(a.cm_favme)):($.mk("label").append($.mk("input").attr({type:"checkbox",name:"template"})," Pre-fill with common color groups").insertBefore(r.parent()),$.Dialog.center()),t.on("submit",function(l){l.preventDefault(),r.text("Saving changes...").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/"+(s?"set/"+a.ponyID:"make"),t.mkData(),$.mkAjaxHandler(function(){if(this.status)if(s)i.children().first().text(this.label),n.html(this.notes),$.Dialog.close();else{$.Dialog.success(e,this.message,!0);var t=this.id,a=this.info;u.one("page-switch",function(i){var n=$("#p"+t);n.length&&$body.scrollTop(n.offset().top-n.outerHeight()/2),a&&(i.preventDefault(),$.Dialog.info(e,a))}),$.toPage(window.location.pathname.replace(/(\d+)?$/,this.page),!0,!0)}else o.call(this)}))})})},f=$.mk("form").attr("id","cg-reorder").append($.mk("div").attr("class","notice").hide().html("<p></p>"));$("#new-appearance-btn").on("click",function(){h($(this),"Add new appearance")});var v=$.mk("form").attr("id","edit-tag");v.append('<label><span>Tag name (4-30 chars.)</span><input type="text" name="name" required pattern="^.{4,30}$" maxlength="30"></label>');var k=$.mk("div").addClass("type-selector");$.each(s,function(t,e){var a=$.mk("label"),i=$.mk("input").attr({type:"checkbox",name:"type",value:t}).on("click keyup",function(){this.checked&&$(this).parent().siblings().find("input").prop("checked",!1)});a.append(i,$.mk("span").addClass("tag typ-"+t).text(e)).appendTo(k)}),v.append($.mk("div").addClass("align-center").append("<span>Tag type (optional)</span><br>",k),$.mk("label").append('<span>Tag description (max 255 chars., optional)</span><br><textarea name="title" maxlength="255"></textarea>'),$.mk("div").attr("class","notice").hide().html("<p></p>"));var x=$.mk("form").attr("id","cg-editor"),w=$.mk("span").attr("class","clrp"),D=$.mk("input").attr({"class":"clri",pattern:d.toString().replace(/\//g,""),autocomplete:"off",spellcheck:"false"}).on("keyup change input",function(){var t=$(this),e=t.prev(),a=d.test(this.value);a?e.removeClass("invalid").css("background-color",this.value.replace(d,"#$1")):e.addClass("invalid"),t.next().attr("required",a)}).on("paste blur",function(t){var e=this,a=$(e),i=/^#?([A-Fa-f0-9]{3})$/,n=function(){var n=e.value;if(i.test(n)){var r=n.match(i)[1];n="#"+r[0]+r[0]+r[1]+r[1]+r[2]+r[2]}d.test(n)&&(a.val(n.replace(d,"#$1").toUpperCase()).trigger("change"),"blur"!==t.type&&a.next().focus())};"paste"===t.type?setTimeout(n,10):n()}),b=$.mk("input").attr({"class":"clrl",pattern:c.replace("+","{3,30}")}),y=$.mk("div").attr("class","clra").append($.mk("span").attr("class","typcn typcn-minus remove red").on("click",function(){$(this).closest(".clr").remove(),$.Dialog.center()})).append($.mk("span").attr("class","typcn typcn-arrow-move move blue")),C=function(t){var e=w.clone(),a=D.clone(!0,!0),i=b.clone(),n=y.clone(!0,!0),r=$.mk("div").attr("class","clr");return"object"==typeof t&&(t.colorid&&r.data("id",t.colorid),t.hex&&a.val(t.hex),t.label&&i.val(t.label)),r.append(e,a,i,n),a.trigger("change"),r},A=$.mk("button").attr("class","typcn typcn-plus green").text("Add new color").on("click",function(t){t.preventDefault();var e=$(this).parents("#cg-editor"),a=e.children(".clrs");a.length||e.append(a=$.mk("div").attr("class","clrs"));var i=C();a.append(i),i.find(".clri").focus(),$.Dialog.center()});x.append('<label><span>Group name (2-30 chars.)</span><br><input name="label" pattern="'+c.replace("+","{2,30}")+'" required></label>').append('<p class="align-center">The # symbol is optional, rows with invalid '+o+"s will be ignored. Each color must have a short (3-30 chars.) description of its intended use.</p>",A).append($.mk("div").attr("class","clrs")).append($.mk("div").attr("class","notice").hide().html("<p></p>")),x.on("render-color-inputs",function(t,e){var a=$(this),i=a.children(".clrs").empty();$.each(e,function(t,e){i.append(C(e))}),new Sortable(i.get(0),{handle:".move",ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.center()}),window.ctxmenus=function(){i()};var q;u.on("page-switch",function(){u.find("button.edit").on("click",function(){var t=$(this),e=t.parents("li").attr("id").substring(1),a=t.parent().text().trim(),i="Editing appearance: "+a;$.Dialog.wait(i,"Retrieving appearance details from server"),$.post("/colorguide/get/"+e,$.mkAjaxHandler(function(){var a=this;a.status?(a.ponyID=e,h(t,i,a)):$.Dialog.fail(i,this.message)}))}).next().on("click",function(){var t=$(this),e=t.closest("li"),a=e.attr("id").substring(1),i=t.parent().text().trim(),n="Deleting appearance: "+i;$.Dialog.confirm(n,"Deleting this appearance will remove <strong>ALL</strong> of its color groups, the colors within them, and the sprite file, if any.<br>Delete anyway?",function(t){t&&($.Dialog.wait(n,"Sending removal request"),$.post("/colorguide/delete/"+a,$.mkAjaxHandler(function(){if(this.status){e.remove(),$.Dialog.success(n,this.message);var t=window.location.pathname;0===u.children().length&&(t=t.replace(/(\d+)$/,function(t){return t>1?t-1:t})),$.toPage(t,!0,!0)}else $.Dialog.fail(n,this.message)})))})}),q=$(".tags").ctxmenu([{text:"Create new tag",icon:"plus",click:function(){e($(this))}}],"Tags"),i()}).trigger("page-switch")});
//# sourceMappingURL=colorguide-manage.min.js.map