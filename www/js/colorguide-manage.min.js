DocReady.push(function(){function e(e){e.children(".tag").sort(function(e,t){var a=/^.*typ-([a-z]+).*$/;return e=[e.className.replace(a,"$1"),e.innerHTML.trim()],t=[t.className.replace(a,"$1"),t.innerHTML.trim()],e[0]===t[0]?e[1].localeCompare(t[1]):e[0].localeCompare(t[0])}).appendTo(e)}function t(e,t){var a="Create new tag",n=e.closest("li"),r=e.closest("div:not([class])"),o=r.children(".tags"),s=n.attr("id").replace(/\D/g,""),l=r.children("strong").text().trim();$.Dialog.request(a,f.clone(!0,!0),"edit-tag","Create",function(e){var a=e.children(".notice").children("p"),n=function(){a.html(this.message).parent().removeClass("info").addClass("fail").show(),e.find("input, texarea").attr("disabled",!1),$.Dialog.center()};e.append($.mk("label").append($.mk("input").attr({type:"checkbox",name:"addto"}).val(s).prop("checked","string"==typeof t),document.createTextNode(' Add this tag to the appearance "'+l+'" after creation'))),"string"==typeof t&&e.find("input[name=name]").val(t),$.Dialog.center(),e.on("submit",function(t){t.preventDefault(),a.text("Creating tag&hellip;").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/maketag",e.mkData(),$.mkAjaxHandler(function(){this.status?(this.tags&&(o.children("[data-hasqtip]").qtip("destroy",!0),o.html(this.tags),window.tooltips(),i()),$.Dialog.close()):n.call(this)}))})})}function a(e,t){var a=this;if("undefined"!=typeof t)if(t instanceof jQuery)var n=t.attr("id").substring(2),r=t.parents("li").attr("id").substring(1);else r=t;$.Dialog.request(e,k.clone(!0,!0),"cg-editor","Save",function(e){var o=e.children(".notice").children("p"),s=function(){o.html(this.message).parent().removeClass("info").addClass("fail").show(),e.find("input:not([name=reason]), texarea").attr("disabled",!1),$.Dialog.center()},l=e.find("input[name=label]"),d=e.find("input[name=major]"),p=e.find("input[name=reason]"),u="object"==typeof a&&a.label&&a.Colors;u&&(l.val(a.label),e.trigger("render-color-inputs",[a.Colors])),e.on("submit",function(a){a.preventDefault();var g={label:l.val(),Colors:[]};return u||(g.ponyid=r),e.find(".clr").each(function(){var e=$(this),t=e.children(".clri");if(c.test(t.val())){var a=e.data("id"),i={hex:t.val().replace(c,"#$1").toUpperCase()};"undefined"!=typeof a&&(i.colorid=parseInt(a,10)),i.label=e.children(".clrl").val(),g.Colors.push(i)}}),0===g.Colors.length?s.call({message:"You need to have at least 1 valid color"}):(g.Colors=JSON.stringify(g.Colors),d.is(":checked")&&(g.major=!0,g.reason=p.val()),o.text("Saving changes&hellip;").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),void $.post("/colorguide/"+(u?"set":"make")+"cg"+(u?"/"+n:""),g,$.mkAjaxHandler(function(){if(this.status){if(this.cg||this.cgs){if(this.cg)t.children("[data-hasqtip]").qtip("destroy",!0),t.html(this.cg),this.update&&t.parents("li").find(".update").html(this.update);else if(this.cgs){var e=$("#p"+r);this.update&&e.find(".update").html(this.update),e.find("ul.colors").html(this.cgs)}window.tooltips(),i(),this.update&&window.updateTimes()}$.Dialog.close()}else s.call(this)})))})})}function i(){A.children("span:not(.ctxmenu-bound)").ctxmenu([{text:"Edit tag",icon:"pencil",click:function(){var t=$(this),a=t.text().trim(),i=t.attr("class").match(/id-(\d+)(?:\s|$)/)[1],n="Editing tag: "+a;$.Dialog.wait(n,"Retrieveing tag details from server"),$.post("/colorguide/gettag/"+i,$.mkAjaxHandler(function(){var t=this;this.status?$.Dialog.request(n,f.clone(!0,!0),"edit-tag","Save",function(a){var n=a.children(".notice").children("p"),r=function(){n.html(this.message).parent().removeClass("info").addClass("fail").show(),a.find("input, texarea").attr("disabled",!1),$.Dialog.center()};a.find("input[name=type][value="+t.type+"]").prop("checked",!0),a.find("input[type=text][name], textarea[name]").each(function(){var e=$(this);e.val(t[e.attr("name")])}),a.on("submit",function(t){t.preventDefault(),n.text("Saving changes&hellip;").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/settag/"+i,a.mkData(),$.mkAjaxHandler(function(){if(this.status){var t=$(".id-"+this.tid);t.qtip("destroy",!0),this.title?t.attr("title",this.title):t.removeAttr("title"),t.attr("class","tag id-"+this.tid+(this.type?" typ-"+this.type:"")).text(this.name).data("ctxmenu-items").eq(0).text("Tag: "+this.name),t.parent().each(function(){e($(this))}),window.tooltips(),$.Dialog.close()}else r.call(this)}))})}):$.Dialog.fail(n,this.message)}))}},{text:"Remove tag",icon:"minus",click:function(){var e=$(this),t=e.attr("class").match(/id-(\d+)(?:\s|$)/);if(!t)return!1;t=t[1];var a=e.closest("li").attr("id").replace(/\D/g,""),i=e.text().trim(),n="Remove tag: "+i;$.Dialog.confirm(n,"The tag "+i+" will be removed from this appearance.<br>Are you sure?",["Remove it","Nope"],function(i){i&&($.Dialog.wait(n,"Removing tag"),$.post("/colorguide/untag/"+a,{tag:t},$.mkAjaxHandler(function(){this.status?(e.qtip("destroy",!0),e.remove(),$.Dialog.close()):$.Dialog.fail(n,this.message)})))})}},{text:"Delete tag",icon:"trash",click:function(){var e=$(this),t=e.text().trim(),a=e.attr("class").match(/id-(\d+)(?:\s|$)/)[1],i="Detele tag: "+t;$.Dialog.confirm(i,"Deleting this tag will also remove it from every appearance where it's been used.<br>Are you sure?",["Delete it","Nope"],function(e){e&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/deltag/"+a,$.mkAjaxHandler(function(){if(this.status){var e=$(".id-"+a);e.qtip("destroy",!0),e.remove(),$.Dialog.close()}else $.Dialog.fail(i,this.message)})))})}},!0,{text:"Create new tag",icon:"plus",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}}],function(e){return"Tag: "+e.text().trim()});var s=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"/colorguide/gettags?s=%QUERY",wildcard:"%QUERY"}}),l=[13,188];A.children(".addtag").each(function(){var e=$(this),a=e.parents("li").attr("id").substring(1);e.typeahead(null,{name:"tags",display:"name",source:s,templates:{suggestion:Handlebars.compile('<span class="tag id-{{tid}} {{type}}">{{name}}</span>')}}),e.on("keydown",function(n){if(-1!==l.indexOf(n.keyCode)){n.preventDefault();var r=e.val().trim(),o=e.parents(".tags"),s=o.children(".tag"),c="Adding tag: "+r;if(s.filter(function(){return this.innerHTML.trim()===r}).length>0)return $.Dialog.fail(c,"This appearance already has this tag");$.Dialog._focusedElement=e.attr("disabled",!0),e.parent().addClass("loading"),$.post("/colorguide/tag/"+a,{tag_name:r},$.mkAjaxHandler(function(){if(e.removeAttr("disabled").parent().removeClass("loading"),this.status)o.children("[data-hasqtip]").qtip("destroy",!0),o.children(".tag").remove(),o.append($(this.tags).filter("span")),window.tooltips(),i(),e.typeahead("val","").focus();else{if("string"==typeof this.cancreate){var a=this.cancreate;return c=c.replace(r,a),$.Dialog.confirm(c,this.message,function(i){i&&t(e,a)})}$.Dialog.fail(c,this.message)}}))}}),e.nextAll(".tt-menu").on("click",".tag",function(){e.trigger({type:"keydown",keyCode:13})})}),n=$("ul.colors:not(.static)").attr("data-color",o),n.filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Re-order "+o+" groups",icon:"arrow-unsorted",click:function(){var e=$(this),t=e.parents("li"),a=t.attr("id").substring(1),n=t.children().last().children("strong").text().trim(),r="Re-order "+o+" groups on appearance: "+n;$.Dialog.wait(r,"Retrieving color group list from server"),$.post("/colorguide/getcgs/"+a,$.mkAjaxHandler(function(){this.status||$.Dialog.fail(this.message);var t=h.clone(),n=$.mk("ol");$.each(this.cgs,function(e,t){n.append($.mk("li").attr("data-id",t.groupid).text(t.label))}),$.mk("div").attr("class","cgs").append('<p class="align-center">Drag to re-arrange</p>',n).prependTo(t),$.Dialog.center(),new Sortable(n.get(0),{ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.request(r,t,"cg-reorder","Save",function(t){var n=t.children(".notice").children("p"),r=function(){n.html(this.message).parent().removeClass("info").addClass("fail").show(),$.Dialog.center()};t.on("submit",function(o){o.preventDefault();var s={cgs:[]},l=t.children(".cgs");return l.length?(l.find("ol").children().each(function(){s.cgs.push($(this).attr("data-id"))}),s.cgs=s.cgs.join(","),n.text("Saving changes&hellip;").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),void $.post("/colorguide/setcgs/"+a,s,$.mkAjaxHandler(function(){this.status?(e.html(this.cgs),window.tooltips(),i(),$.Dialog.close()):r.call(this)}))):r.call({message:"There are no color groups to re-order"})})})}))}},{text:"Create new group",icon:"folder-add",click:function(){a("Create color group",$(this).parents("li").attr("id").substring(1))}}],r+" groups"),n.children("li").filter(":not(.ctxmenu-bound)").ctxmenu([{text:"Edit "+o+" group",icon:"pencil",click:function(){var e=$(this),t=e.closest("li"),i=t.attr("id").substring(2),n=e.children().first().text().replace(/:\s?$/,""),r="Editing "+o+" group: "+n;$.Dialog.wait(r,"Retrieving "+o+" group details from server"),$.post("/colorguide/getcg/"+i,$.mkAjaxHandler(function(){this.status?a.call(this,r,t):$.Dialog.fail(r,data.message)}))}},{text:"Delete "+o+" group",icon:"trash",click:function(){var e=$(this).closest("li"),t=e.attr("id").substring(2),a=e.children().first().text().replace(/:\s?$/,""),i="Delete "+o+" group: "+a;$.Dialog.confirm(i,"By deleting this "+o+" group, all "+o+"s within will be removed too.<br>Are you sure?",function(a){a&&($.Dialog.wait(i,"Sending removal request"),$.post("/colorguide/delcg/"+t,$.mkAjaxHandler(function(){this.status?(e.children("[data-hasqtip]").qtip("destroy",!0),e.remove(),$.Dialog.close()):$.Dialog.fail(i,this.message)})))})}},!0,{text:"Re-order "+o+" groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}}],function(e){return r+" group: "+e.children().first().text().trim().replace(":","")}),$.ctxmenu.addItems(n.children("li").children("span:not(:first-child)"),!0,{text:"Edit "+o+" group",icon:"pencil",click:function(){$.ctxmenu.triggerItem($(this).parent(),1)}},{text:"Delete "+o+" group",icon:"trash",click:function(){$.ctxmenu.triggerItem($(this).parent(),2)}},!0,{text:"Re-order "+o+" groups",icon:"arrow-unsorted",click:function(){$.ctxmenu.triggerItem($(this).parent(),3)}},{text:"Create new group",icon:"folder-add",click:function(){$.ctxmenu.triggerItem($(this).parent(),4)}}),$(".upload-wrap").each(function(){var e=$(this),t=e.closest("li").attr("id").substring(1);e.uploadZone({requestKey:"sprite",title:"Upload sprite",accept:"image/png",target:"/colorguide/setsprite/"+t}).on("uz-uploadstart",function(){$.Dialog.close()}).ctxmenu([{text:"Open image in new tab",icon:"arrow-forward","default":!0,attr:{href:e.find("img").attr("src"),target:"_blank"}},{text:"Copy image URL",icon:"clipboard",click:function(){$.copy($.urlToAbsolute(e.find("img").attr("src")))}},{text:"Upload new sprite",icon:"upload",click:function(){var t="Upload sprite image",a=e.closest("li").attr("id").substring(1),i=e.find('input[type="file"]');$.Dialog.request(t,p.clone(),"sprite-img","Download image",function(e){var n=e.find("input[name=image_url]");e.find("a").on("click",function(e){e.preventDefault(),e.stopPropagation(),i.trigger("click",[!0])}),e.on("submit",function(e){e.preventDefault();var r=n.val();$.Dialog.wait(t,"Downloading external image to the server"),$.post("/colorguide/setsprite/"+a,{image_url:r},$.mkAjaxHandler(function(){this.status?i.trigger("set-image",[this.path]):$.Dialog.fail(t,this.message)}))})})}}],"Sprite image").attr("title",d?" ":"").on("click",function(t,a){return a===!0?!0:(t.preventDefault(),void e.data("ctxmenu-items").eq(1).children().get(0).click())})})}var n,r=window.Color,o=window.color,s=window.TAG_TYPES_ASSOC,l=window.PRINTABLE_ASCII_REGEX,c=window.HEX_COLOR_PATTERN,d="WebkitAppearance"in document.documentElement.style,p=$.mk("form").attr("id","sprite-img").html('<p class="align-center"><a href="#upload">Click here to upload a file</a> (max. '+window.MAX_SIZE+') or enter a URL below.</p><label><input type="text" name="image_url" placeholder="External image URL" required></label><p class="align-center">The URL will be checked against the supported provider list, and if an image is found, it\'ll be downloaded to the server and set as this appearance\'s sprite image.</p>'),u=$("#list"),g=$.mk("form").attr("id","pony-editor").append($.mk("label").append($.mk("span").text("Name (4-70 chars.)"),$.mk("input").attr({name:"label",placeholder:"Enter a name",pattern:l.replace("+","{4,70}"),required:!0,maxlength:70})),$.mk("label").append($.mk("span").text("Additional notes (255 chars. max, optional)"),$.mk("textarea").attr({name:"notes",maxlength:255})),$.mk("label").append($.mk("span").text("Link to cutie mark (optional)"),$.mk("input").attr({name:"cm_favme",placeholder:"DeviantArt submission URL"})),$.mk("div").attr("class","notice").hide().html("<p></p>")),m=function(e,t,a){var i=e.parent(),n=i.parent(),r=n.children(".notes");$.Dialog.request(t,g.clone(),"pony-editor","Save",function(e){var n=e.children(".notice").children("p"),o=function(){n.html(this.message).parent().removeClass("info").addClass("fail").show(),e.find("input, texarea").attr("disabled",!1),$.Dialog.center()},s=!!a;s?(e.find("input[name=label]").val(a.label),e.find("textarea").val(a.notes),e.find("input[name=cm_favme]").val(a.cm_favme)):($.mk("label").append($.mk("input").attr({type:"checkbox",name:"template"})," Pre-fill with common color groups").insertBefore(n.parent()),$.Dialog.center()),e.on("submit",function(l){l.preventDefault(),n.text("Saving changes&hellip;").parent().removeClass("fail").addClass("info").show(),$.Dialog.center(),$.post("/colorguide/"+(s?"set/"+a.ponyID:"make"),e.mkData(),$.mkAjaxHandler(function(){if(this.status)if(s)i.children().first().text(this.label),r.html(this.notes),$.Dialog.close();else{$.Dialog.success(t,this.message,!0);var e=this.id,a=this.info;u.one("page-switch",function(i){var n=$("#p"+e);n.length&&$body.scrollTop(n.offset().top-n.outerHeight()/2),a&&(i.preventDefault(),$.Dialog.info(t,a))}),$.toPage(window.location.pathname.replace(/(\d+)?$/,this.page),!0,!0)}else o.call(this)}))})})},h=$.mk("form").attr("id","cg-reorder").append($.mk("div").attr("class","notice").hide().html("<p></p>"));$("#new-appearance-btn").on("click",function(){m($(this),"Add new appearance")});var f=$.mk("form").attr("id","edit-tag");f.append('<label><span>Tag name (4-30 chars.)</span><input type="text" name="name" required pattern="^.{4,30}$" maxlength="30"></label>');var v=$.mk("div").addClass("type-selector");$.each(s,function(e,t){var a=$.mk("label"),i=$.mk("input").attr({type:"checkbox",name:"type",value:e}).on("click keyup",function(){this.checked&&$(this).parent().siblings().find("input").prop("checked",!1)});a.append(i,$.mk("span").addClass("tag typ-"+e).text(t)).appendTo(v)}),f.append($.mk("div").addClass("align-center").append("<span>Tag type (optional)</span><br>",v),$.mk("label").append('<span>Tag description (max 255 chars., optional)</span><br><textarea name="title" maxlength="255"></textarea>'),$.mk("div").attr("class","notice").hide().html("<p></p>"));var k=$.mk("form").attr("id","cg-editor"),x=$.mk("span").attr("class","clrp"),b=$.mk("input").attr({"class":"clri",pattern:c.toString().replace(/\//g,""),autocomplete:"off",spellcheck:"false"}).on("keyup change input",function(){var e=$(this),t=e.prev(),a=c.test(this.value);a?t.removeClass("invalid").css("background-color",this.value.replace(c,"#$1")):t.addClass("invalid"),e.next().attr("required",a)}).on("paste blur",function(e){var t=this,a=$(t),i=/^#?([A-Fa-f0-9]{3})$/,n=function(){var n=t.value;if(i.test(n)){var r=n.match(i)[1];n="#"+r[0]+r[0]+r[1]+r[1]+r[2]+r[2]}c.test(n)&&(a.val(n.replace(c,"#$1").toUpperCase()).trigger("change"),"blur"!==e.type&&a.next().focus())};"paste"===e.type?setTimeout(n,10):n()}),w=$.mk("input").attr({"class":"clrl",pattern:l.replace("+","{3,30}")}),D=$.mk("div").attr("class","clra").append($.mk("span").attr("class","typcn typcn-minus remove red").on("click",function(){$(this).closest(".clr").remove(),$.Dialog.center()})).append($.mk("span").attr("class","typcn typcn-arrow-move move blue")),y=function(e){var t=x.clone(),a=b.clone(!0,!0),i=w.clone(),n=D.clone(!0,!0),r=$.mk("div").attr("class","clr");return"object"==typeof e&&(e.colorid&&r.data("id",e.colorid),e.hex&&a.val(e.hex),e.label&&i.val(e.label)),r.append(t,a,i,n),a.trigger("change"),r},C=$.mk("button").attr("class","typcn typcn-plus green").text("Add new color").on("click",function(e){e.preventDefault();var t=$(this).parents("#cg-editor"),a=t.children(".clrs");a.length||t.append(a=$.mk("div").attr("class","clrs"));var i=y();a.append(i),i.find(".clri").focus(),$.Dialog.center()});k.append($.mk("label").append($.mk("span").text("Group name (2-30 chars.)"),mk("br"),$.mk("input").attr({type:"text",name:"label",pattern:l.replace("+","{2,30}"),required:!0})),$.mk("label").append($.mk("input").attr({type:"checkbox",name:"major"}).on("click",function(){$(this).parent().next()[this.checked?"show":"hide"]().children("input").attr("disabled",!this.checked),$.Dialog.center()}),$.mk("span").text("This is a major change")),$.mk("label").append($.mk("span").text("Change reason (1-255 chars.)"),mk("br"),$.mk("input").attr({type:"text",name:"reason",pattern:l.replace("+","{1,255}"),required:!0,disabled:!0})).hide(),$.mk("p").attr("class","align-center").text("The # symbol is optional, rows with invalid "+o+"s will be ignored. Each color must have a short (3-30 chars.) description of its intended use."),C,$.mk("div").attr("class","clrs"),$.mk("div").attr("class","notice").hide().html("<p></p>")).on("render-color-inputs",function(e,t){var a=$(this),i=a.children(".clrs").empty();$.each(t,function(e,t){i.append(y(t))}),new Sortable(i.get(0),{handle:".move",ghostClass:"moving",scroll:!1,animation:150}),$.Dialog.center()}),window.ctxmenus=function(){i()};var A;u.on("page-switch",function(){u.find("button.edit").on("click",function(){var e=$(this),t=e.parents("li").attr("id").substring(1),a=e.parent().text().trim(),i="Editing appearance: "+a;$.Dialog.wait(i,"Retrieving appearance details from server"),$.post("/colorguide/get/"+t,$.mkAjaxHandler(function(){var a=this;a.status?(a.ponyID=t,m(e,i,a)):$.Dialog.fail(i,this.message)}))}).next().on("click",function(){var e=$(this),t=e.closest("li"),a=t.attr("id").substring(1),i=e.parent().text().trim(),n="Deleting appearance: "+i;$.Dialog.confirm(n,"Deleting this appearance will remove <strong>ALL</strong> of its color groups, the colors within them, and the sprite file, if any.<br>Delete anyway?",function(e){e&&($.Dialog.wait(n,"Sending removal request"),$.post("/colorguide/delete/"+a,$.mkAjaxHandler(function(){if(this.status){t.remove(),$.Dialog.success(n,this.message);var e=window.location.pathname;0===u.children().length&&(e=e.replace(/(\d+)$/,function(e){return e>1?e-1:e})),$.toPage(e,!0,!0)}else $.Dialog.fail(n,this.message)})))})}),A=$(".tags").ctxmenu([{text:"Create new tag",icon:"plus",click:function(){t($(this))}}],"Tags"),i()}).trigger("page-switch")});
//# sourceMappingURL=colorguide-manage.min.js.map
