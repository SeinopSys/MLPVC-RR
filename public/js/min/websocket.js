"use strict";var _createClass=function(){function o(n,t){for(var e=0;e<t.length;e++){var o=t[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}return function(n,t,e){return t&&o(n.prototype,t),e&&o(n,e),n}}();function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){var t=$("#wss").attr("src").replace(/^(.*?:\d+\/).*$/,"$1"),i=function(t){return function(n){if("string"==typeof n)try{n=JSON.parse(n)}catch(n){}t(n)}},e=void 0,s=void 0,a=void 0,c=!1,o="function"==typeof window.io;o||(console.log("%c[WS] Server down!","color:red"),$sidebar.find(".notif-list").on("click",".mark-read",function(n){n.preventDefault(),$.Dialog.fail("Mark notification read",'The notification server appears to be down. Please <a class="send-feedback">let us know</a>, and sorry for the inconvenience.')}));var n=function(){function n(){_classCallCheck(this,n),this.down=!o,this.substatus={postUpdates:!1,entryUpdates:!1}}return _createClass(n,[{key:"connect",value:function(){var o=this;this.conn||(this.conn=io(t,{reconnectionDelay:1e4}),this.conn.on("connect",function(){console.log("[WS] %cConnected","color:green"),o.navigate()}),this.conn.on("auth",i(function(n){o.clientid=n.clientid,c=!0,console.log("[WS] %cAuthenticated as "+n.name,"color:teal")})),this.conn.on("auth-guest",i(function(n){o.clientid=n.clientid,console.log("[WS] %cReceiving events as a guest","color:teal")})),this.conn.on("notif-cnt",i(function(n){var t=n.cnt?parseInt(n.cnt,10):0;console.log("[WS] Unread notification count: %d",t),o.essentialElements(),0===t?s.stop().slideUp("fast",function(){a.empty(),e.empty()}):$.API.get("/notif",$.mkAjaxHandler(function(n){e.text(t),a.html(n.list),Time.Update(),o.bindMarkRead(),s.stop().slideDown()}))})),this.conn.on("post-delete",i(function(n){if(n.id){var t="post-"+n.id,e=$("#"+t+":not(.deleting)");console.log("[WS] Post deleted (postid=%s)",t),e.length&&(e.find(".fluidbox--opened").fluidbox("close"),e.find(".fluidbox--initialized").fluidbox("destroy"),e.attr({class:"deleted",title:"This post has been deleted; click here to hide"}).on("click",function(n){var t=$(n.target);t[window.withinMobileBreakpoint()?"slideUp":"fadeOut"](500,function(){t.remove()})}))}})),this.conn.on("post-break",i(function(n){if(n.id){var t=$("#post-"+n.id+":not(.admin-break)");console.log("[WS] Post broken (id=%s)",n.id),t.length&&t.reloadLi()}})),this.conn.on("post-add",i(function(e){e.id&&window.EPISODE===e.episode&&window.SEASON===e.season&&(0<$(".posts #post-"+e.id).length||$.API.get("/post/"+e.id+"/reload",$.mkAjaxHandler(function(n){if(n.status&&!(0<$(".posts #post-"+e.id).length)){var t=$(n.li);$(n.section).append(t),t.rebindFluidbox(),Time.Update(),t.rebindHandlers(!0).parent().reorderPosts(),console.log("[WS] Post added (id="+e.id+") to container "+o.section)}})))})),this.conn.on("post-update",i(function(n){if(n.id){var t=$("#post-"+n.id+":not(.deleting)");console.log("[WS] Post updated (id=%s)",n.id),t.length&&t.reloadLi(!1)}})),this.conn.on("entry-score",i(function(n){if(void 0!==n.entryid){var t=$("#entry-"+n.entryid);console.log("[WS] Entry score updated (entryid=%s, score=%s)",n.entryid,n.score),t.length&&t.refreshVoting()}})),this.conn.on("update",i(function(n){console.log("[WS] %cWebsite updated","color:darkblue");var t=$("#git-info");t.fadeOut(100,function(){t.html(n.git_info).fadeIn(100)})})),this.conn.on("hello",i(function(n){console.log("[WS] %cHello response (priv=%s)","color:green",n.priv),$w.trigger("ws-hello",[n])})),this.conn.on("disconnect",function(){c=!1,console.log("[WS] %cDisconnected","color:red")}))}},{key:"navigate",value:function(){if(void 0!==this.conn){var n=location.pathname+location.search+location.hash;this.conn.emit("navigate",{page:n})}}},{key:"recvPostUpdates",value:function(t){var e=this;if(void 0===this.conn)return setTimeout(function(){e.recvPostUpdates(t)},2e3);"boolean"==typeof t&&this.substatus.postUpdates!==t&&this.conn.emit("post-updates",String(t),i(function(n){if(!n.status)return console.log("[WS] %cpost-updates subscription status change failed (subscribe=%s)","color:red",t);e.substatus.postUpdates=t,$("#episode-live-update")[e.substatus.postUpdates?"removeClass":"addClass"]("hidden"),console.log("[WS] %c%s","color:green",n.message)}))}},{key:"recvEntryUpdates",value:function(t){var e=this;if(void 0===this.conn)return setTimeout(function(){e.recvEntryUpdates(t)},2e3);"boolean"==typeof t&&this.substatus.entryUpdates!==t&&this.conn.emit("entry-updates",String(t),i(function(n){if(!n.status)return console.log("[WS] %centry-updates subscription status change failed (subscribe=%s)","color:red",t);e.substatus.entryUpdates=t,$("#entry-live-update")[e.substatus.entryUpdates&&"contest"===window.EventType?"removeClass":"addClass"]("hidden"),console.log("[WS] %c%s","color:green",n.message)}))}},{key:"authme",value:function(){var n=this;void 0!==this.conn&&!0!==c&&(console.log("[WS] %cReconnection needed for identity change","color:teal"),this.conn.disconnect(0),setTimeout(function(){n.conn.connect()},100))}},{key:"unauth",value:function(){void 0!==this.conn&&!0===c&&this.conn.emit("unauth",null,i(function(n){if(!n.status)return console.log("[WS] %cUnauth failed","color:red");c=!1,console.log("[WS] %cAuthentication dropped","color:brown")}))}},{key:"disconnect",value:function(n){void 0!==this.conn&&(console.log("[WS] Forced disconnect (reason="+n+")"),this.conn.disconnect(0))}},{key:"status",value:function(){var n=this;if(void 0===this.conn)return setTimeout(function(){n.status()},2e3);this.conn.emit("status",null,i(function(n){if(!n.status)return console.log("[WS] Status: %c"+n.message,"color:red");console.log("[WS] Status: ID=%s; Name=%s; Rooms=%s",n.User.id,n.User.name,n.rooms.join(","))}))}},{key:"devquery",value:function(n){var t=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;if(void 0===this.conn)return setTimeout(function(){t.devquery(n,e,o)},2e3);this.conn.emit("devquery",{what:n,data:e},i(function(n){if("function"==typeof o)return o(n);console.log("[WS] DevQuery "+(n.status?"Success":"Fail"),n)}))}},{key:"essentialElements",value:function(){0===(e=$sbToggle.children(".notif-cnt")).length&&(e=$.mk("span").attr({class:"notif-cnt",title:"New notifications"}).prependTo($sbToggle)),s=$sidebar.children(".notifications"),a=s.children(".notif-list"),o&&this.bindMarkRead()}},{key:"bindMarkRead",value:function(){a.off("click",".mark-read").on("click",".mark-read",function(n){n.preventDefault(),n.stopPropagation();var t=$(n.target).closest(".mark-read");if(!t.hasClass("disabled")){var e=t.attr("data-id"),o={read_action:t.attr("data-value")},i=t.attr("data-action")||"Mark notification as read",s=function(){t.siblings(".mark-read").addBack().addClass("disabled"),$.API.post("/notif/"+e+"/mark-read",o,$.mkAjaxHandler(function(n){return n.status?n.message?$.Dialog.success(i,n.message,!0):void $.Dialog.close():$.Dialog.fail(i,n.message)})).always(function(){t.siblings(".mark-read").addBack().removeClass("disabled")})};o.read_action&&t.hasAttr("data-confirm")?$.Dialog.confirm("Actionable notification",'Please confirm your choice: <strong class="color-'+t.attr("class").replace(/^.*variant-(\w+)\b.*$/,"$1")+'">'+t.attr("title")+"</strong>",["Confirm","Cancel"],function(n){n&&($.Dialog.wait(i),s())}):s()}})}},{key:"getClientId",value:function(){return this.clientid}}]),n}();$.WS=new n,$.WS.essentialElements(),o&&$.WS.connect()}();
//# sourceMappingURL=/js/min/websocket.js.map
